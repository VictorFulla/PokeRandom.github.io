<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Backfill v3 ‚Äî RandomLock</title>
<style>
:root{--bg:#0d0f14;--panel:#151922;--edge:rgba(255,255,255,.12);--text:#e7ecf5;--muted:#9aa4b2;--ok:#49d17d;--warn:#ffcc66;--err:#ff6b6b}
*{box-sizing:border-box}html,body{height:100%}
body{margin:0;background:linear-gradient(180deg,#0b0e13,#0d1016);color:var(--text);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto}
.wrap{max-width:960px;margin:0 auto;padding:20px}
.card{background:var(--panel);border:1px solid var(--edge);border-radius:14px;padding:16px;box-shadow:0 10px 30px rgba(0,0,0,.3)}
h1{margin:0 0 12px}
small{color:var(--muted)}
.btn{background:#0e121a;border:1px solid var(--edge);color:#fff;border-radius:999px;padding:8px 12px;cursor:pointer}
.btn[disabled]{opacity:.5;cursor:not-allowed}
.row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin:10px 0}
pre{background:#0e121a;border:1px solid var(--edge);padding:10px;border-radius:10px;max-height:360px;overflow:auto;white-space:pre-wrap}
.ok{color:var(--ok)} .warn{color:var(--warn)} .err{color:var(--err)}
.code{font-family:ui-monospace,SFMono-Regular,Consolas,"Liberation Mono",Menlo,monospace;font-size:12px}
.kv{display:grid;grid-template-columns:200px 1fr;gap:8px;margin:10px 0}
.kv b{color:#cbd5e1}
label{display:flex;gap:6px;align-items:center}
input[type=text]{background:#0e121a;border:1px solid var(--edge);color:#fff;border-radius:10px;padding:6px 10px;min-width:280px}
</style>
</head>
<body>
<div class="wrap">
  <h1>üß∞ Backfill v3 (robusto)</h1>
  <div class="card">
    <div class="kv">
      <div><b>Qu√© hace</b></div><div>Busca hist√≥rico en varias rutas comunes y lo vuelca en <code class="code">usageLogs</code> y <code class="code">attackLogs</code> con <b>Timestamps reales</b> e <b>IDs deterministas</b>.</div>
      <div><b>Rutas escaneadas</b></div>
      <div class="code">
        ‚Ä¢ <b>profiles</b> ‚Üí campos <code>useLog</code>, <code>usage</code><br/>
        ‚Ä¢ <b>inventories</b> (colecci√≥n ra√≠z) ‚Üí campos <code>useLog</code>, <code>usage</code><br/>
        ‚Ä¢ <b>collectionGroup("inventories")</b> (subcolecciones) ‚Üí campos <code>useLog</code>, <code>usage</code><br/>
        ‚Ä¢ <b>attackRequests</b> (si marcas ‚Äúincluir ataques‚Äù)
      </div>
    </div>

    <div class="row">
      <button id="btnAuth" class="btn">Iniciar sesi√≥n</button>
      <button id="btnRun" class="btn" disabled>Importar todo</button>
      <label><input type="checkbox" id="chkAttacks" checked/> Incluir ataques</label>
      <label>Rama profiles personalizada (opcional): <input id="profilesPath" type="text" placeholder="profiles"/></label>
    </div>
    <pre id="log" class="code"></pre>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
import { getFirestore, collection, collectionGroup, doc, getDocs, setDoc, Timestamp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCPhWAShfR33sAuZ2H4Y2BAGnF8wkkv_S0",
  authDomain: "pokerandom-ce300.firebaseapp.com",
  projectId: "pokerandom-ce300",
  storageBucket: "pokerandom-ce300.firebasestorage.app",
  messagingSenderId: "637348459448",
  appId: "1:637348459448:web:4ab19e68bcce734692554d"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const $ = s => document.querySelector(s);
const logEl = $("#log");
const btnAuth = $("#btnAuth");
const btnRun = $("#btnRun");
const chkAttacks = $("#chkAttacks");
const profilesPath = $("#profilesPath");

let currentUser = null;

function log(line, cls=""){ logEl.innerHTML += (cls?`<span class="${cls}">${line}</span>`:line) + "\\n"; logEl.scrollTop = logEl.scrollHeight; }
function asMillis(ts){
  if (!ts) return null;
  if (ts.toMillis) return ts.toMillis();
  if (typeof ts.seconds === "number") return ts.seconds*1000;
  if (typeof ts === "number") return ts;
  const t = Date.parse(ts);
  return isNaN(t) ? null : t;
}
function idFrom(parts){
  return btoa(unescape(encodeURIComponent(parts.join("|")))).replace(/=+$/,"").slice(0,140);
}
function normTag(t){
  t = (t||"").toString().toLowerCase();
  if (t==="cura"||t==="curacion") return "curaci√≥n";
  if (t==="item") return "√≠tem";
  return t;
}
function isAdminEntry(entry){
  const msg = (entry.message||entry.msg||"").toString();
  return msg.includes("[ADMIN]");
}
function guessIsUse(entry){
  const a = (entry.action||entry.type||"").toString().toLowerCase();
  if (a) return a==="use";
  // heur√≠stica: mensajes t√≠picos
  const m = (entry.message||entry.msg||"").toLowerCase();
  return /us[√≥o]|utiliz|aplic[√≥o]/.test(m);
}

onAuthStateChanged(auth, (u)=>{
  currentUser = u;
  if (u){ log(`‚úî Sesi√≥n: ${u.email||u.uid}`,"ok"); btnRun.disabled = false; }
  else { log("‚Ñπ Inicia sesi√≥n para continuar."); btnRun.disabled = true; }
});
btnAuth.onclick = async ()=>{
  try{ await signInWithPopup(auth, new GoogleAuthProvider()); }catch(e){ log("‚úñ "+e.message,"err"); }
};
btnRun.onclick = async ()=>{ if(!currentUser) return; await run(); };

async function run(){
  const profCol = (profilesPath.value||"profiles").trim();
  let usageFound=0, usageWrite=0, sentFound=0, sentWrite=0, recvFound=0, recvWrite=0;

  // 1) profiles
  try{
    log(`‚Äî Escaneando ${profCol}‚Ä¶`);
    const ps = await getDocs(collection(db, profCol));
    for (const d of ps.docs){
      const uid = d.id;
      const data = d.data()||{};
      const logs = [].concat(data.useLog||[], data.usage||[]);
      for (const e of logs){
        if (!e) continue;
        if (isAdminEntry(e)) continue;
        if (!guessIsUse(e)) continue;
        const t = asMillis(e.createdAt||e.time||e.timestamp)||Date.now();
        const id = idFrom(["use", uid, e.cardName||e.name||"?", normTag(e.tag||e.label||"?"), t]);
        usageFound++;
        await setDoc(doc(db,"usageLogs", id), {
          uid,
          userName: data.displayName || data.userName || uid,
          cardName: e.cardName||e.name||"",
          tag: normTag(e.tag||e.label||""),
          action:"use",
          createdAt: Timestamp.fromMillis(t)
        }, { merge:false }).catch(()=>{});
        usageWrite++;
      }
    }
  }catch(e){ log("   ‚úñ profiles: "+e.message,"err"); }

  // 2) inventories (root)
  try{
    log("‚Äî Escaneando inventories (ra√≠z)‚Ä¶");
    const inv = await getDocs(collection(db,"inventories"));
    for (const d of inv.docs){
      const uid = d.id;
      const data = d.data()||{};
      const logs = [].concat(data.useLog||[], data.usage||[]);
      for (const e of logs){
        if (!e) continue;
        if (isAdminEntry(e)) continue;
        if (!guessIsUse(e)) continue;
        const t = asMillis(e.createdAt||e.time||e.timestamp)||Date.now();
        const id = idFrom(["use", uid, e.cardName||e.name||"?", normTag(e.tag||e.label||"?"), t]);
        usageFound++;
        await setDoc(doc(db,"usageLogs", id), {
          uid,
          userName: data.userName || uid,
          cardName: e.cardName||e.name||"",
          tag: normTag(e.tag||e.label||""),
          action:"use",
          createdAt: Timestamp.fromMillis(t)
        }, { merge:false }).catch(()=>{});
        usageWrite++;
      }
    }
  }catch(e){ log("   ‚úñ inventories ra√≠z: "+e.message,"err"); }

  // 3) inventories (collectionGroup)
  try{
    log("‚Äî Escaneando collectionGroup('inventories')‚Ä¶");
    const cg = await getDocs(collectionGroup(db,"inventories"));
    for (const d of cg.docs){
      const data = d.data()||{};
      const uid = data.uid || d.id;
      const logs = [].concat(data.useLog||[], data.usage||[]);
      for (const e of logs){
        if (!e) continue;
        if (isAdminEntry(e)) continue;
        if (!guessIsUse(e)) continue;
        const t = asMillis(e.createdAt||e.time||e.timestamp)||Date.now();
        const id = idFrom(["use", uid, e.cardName||e.name||"?", normTag(e.tag||e.label||"?"), t]);
        usageFound++;
        await setDoc(doc(db,"usageLogs", id), {
          uid,
          userName: data.userName || uid,
          cardName: e.cardName||e.name||"",
          tag: normTag(e.tag||e.label||""),
          action:"use",
          createdAt: Timestamp.fromMillis(t)
        }, { merge:false }).catch(()=>{});
        usageWrite++;
      }
    }
  }catch(e){ log("   ‚úñ inventories CG: "+e.message,"err"); }

  // 4) attacks
  if (chkAttacks.checked){
    try{
      log("‚Äî Escaneando attackRequests‚Ä¶");
      const at = await getDocs(collection(db,"attackRequests"));
      for (const d of at.docs){
        const a = d.data()||{};
        if (a.attackerId && a.victimId){
          const t = asMillis(a.createdAt||a.timestamp)||Date.now();
          const idS = idFrom(["sent", d.id]);
          await setDoc(doc(db,"attackLogs", idS), {
            type:"sent",
            attackerId: a.attackerId,
            attackerName: a.attackerName || a.attackerId,
            victimId: a.victimId,
            createdAt: Timestamp.fromMillis(t)
          }, { merge:false }).catch(()=>{});
          sentFound++; sentWrite++;
        }
        if ((a.status||"").toLowerCase()==="applied"){
          const tr = asMillis(a.appliedAt||a.updatedAt||a.createdAt||a.timestamp)||Date.now();
          const idR = idFrom(["recv", d.id]);
          await setDoc(doc(db,"attackLogs", idR), {
            type:"received",
            victimId: a.victimId,
            victimName: a.victimName || a.victimId,
            attackerId: a.attackerId || null,
            createdAt: Timestamp.fromMillis(tr)
          }, { merge:false }).catch(()=>{});
          recvFound++; recvWrite++;
        }
      }
    }catch(e){ log("   ‚úñ attackRequests: "+e.message,"err"); }
  }

  log(`‚úî usos: ${usageWrite} (detectados ${usageFound}) ‚Äî sent: ${sentWrite} / recv: ${recvWrite}`, "ok");
  log("‚úÖ Hecho. Abre el Tracker.");
}
</script>
</body>
</html>
