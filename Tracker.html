<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Tracker de Cartas • Radar & Ataques</title>
  <style>
    :root{
      --bg:#0b1020;--panel:#121937cc;--txt:#e8ecff;--muted:#a9b4ff;--accent:#7cf8ff;--accent2:#ff7cf2;--gold:#ffd166;--shadow:0 10px 30px rgba(0,0,0,.45);
    }
    *{box-sizing:border-box}
    body{margin:0; font-family:ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Inter, Helvetica, Arial; color:var(--txt); background: radial-gradient(1200px 600px at 20% -10%, #20309644 0%, transparent 60%), radial-gradient(1000px 600px at 120% 10%, #7c19b944 0%, transparent 50%), linear-gradient(180deg,#0a0f21 0%, #070b16 100%); min-height:100svh}
    header{padding:18px 20px; display:flex; gap:14px; align-items:center; justify-content:space-between; position:sticky; top:0; backdrop-filter: blur(8px); background:linear-gradient(180deg, #0b1020dd, #0b102055); border-bottom:1px solid #ffffff18; z-index:20}
    .brand{display:flex; align-items:center; gap:12px}
    .logo{width:36px; height:36px; border-radius:10px; background: conic-gradient(from 210deg, var(--accent), var(--accent2), var(--accent)); box-shadow:0 0 20px #7cf8ff55 inset, 0 0 30px #ff7cf255}
    h1{font-size:18px; margin:0; letter-spacing:.5px}
    .actions{display:flex; gap:8px; flex-wrap:wrap}
    button, .ghost{background:linear-gradient(180deg, #1a2356, #111a40); color:var(--txt); border:1px solid #6ea8ff33; box-shadow: var(--shadow); padding:10px 14px; border-radius:12px; cursor:pointer; font-weight:600; letter-spacing:.2px; transition:.2s transform,.2s filter,.2s opacity,.2s background}
    button:hover{transform:translateY(-1px); filter:brightness(1.08)}
    .ghost{background:transparent; border-color:#ffffff1e}
    .pill{padding:6px 10px; border-radius:999px; background:#ffffff12; color:var(--muted); font-size:12px; border:1px solid #ffffff1a}

    main{padding:18px; max-width:1200px; margin:0 auto; display:grid; gap:18px; grid-template-columns: 1fr 400px}
    @media (max-width:1150px){ main{grid-template-columns:1fr} }

    .card{background:linear-gradient(180deg,#121937dd,#0f1639cc); border:1px solid #93b4ff22; border-radius:18px; padding:16px; box-shadow: var(--shadow)}
    .card h2{margin:0 0 10px; font-size:16px; letter-spacing:.3px}

    .toolbar{display:flex; flex-wrap:wrap; gap:8px; margin-bottom:12px}
    .tab{padding:8px 12px; border-radius:999px; border:1px solid #ffffff22; background:#ffffff10; color:var(--txt); cursor:pointer; font-weight:700; font-size:13px}
    .tab.active{outline:2px solid #7cf8ff88}

    .center{display:grid; place-items:center}
    #radarWrap{position:relative; width:min(640px, 90vw); aspect-ratio:1; margin:auto}
    #radar{position:absolute; inset:0}
    .label{position:absolute; transform:translate(-50%,-50%); font-size:12px; color:#cfe3ff}

    .side{display:grid; gap:14px}
    table{width:100%; border-collapse:separate; border-spacing:0 6px}
    th,td{padding:8px 10px; font-size:13px}
    thead th{color:var(--muted)}
    tbody tr{background:#111743aa; border:1px solid #7ea2ff1f}
    .mono{font-variant-numeric: tabular-nums}

    .achievements{display:grid; grid-template-columns: repeat(2,1fr); gap:10px}
    .badge{background:#0f1642; border:1px solid #ffffff22; border-radius:14px; padding:10px; font-size:13px}
    .badge b{color:#fff}
  </style>
</head>
<body>
  <header>
    <div class="brand">
      <div class="logo"></div>
      <h1>Tracker de Cartas • Radar & Ataques</h1>
      <span class="pill" id="mode">Local</span>
    </div>
    <div class="actions">
      <button id="homeBtn">Home</button>
    </div>
  </header>

  <main>
    <section class="card">
      <h2 style="display:flex; align-items:center; gap:8px">Uso por etiqueta (Radar)</h2>
      <div class="toolbar" id="tagsBar"></div>
      <div class="center">
        <div id="radarWrap">
          <canvas id="radar"></canvas>
          <!-- labels puestos por JS -->
        </div>
      </div>
    </section>

    <aside class="side">
      <section class="card">
        <h2>Historial de ataques (quién ataca a quién)</h2>
        <div id="attacksTableWrap"></div>
      </section>
      <section class="card">
        <h2>Ranking de más atacados</h2>
        <table>
          <thead><tr><th>#</th><th>Jugador</th><th class="mono">Golpes</th></tr></thead>
          <tbody id="mostHitBody"></tbody>
        </table>
      </section>
    </aside>
  </main>

  <section class="card" style="max-width:1200px; margin:0 auto 20px;">
    <h2>Logros semanales (divertiditos)</h2>
    <div class="achievements" id="achievements"></div>
  </section>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
    import { getFirestore, collection, query, where, onSnapshot, orderBy, serverTimestamp, getDocs } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';
    import { getAuth, onAuthStateChanged, signInAnonymously } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';

    // —— Configura tu Firebase aquí ——
    const firebaseConfig = {
      apiKey: "AIzaSyCPhWAShfR33sAuZ2H4Y2BAGnF8wkkv_S0",
      authDomain: "pokerandom-ce300.firebaseapp.com",
      projectId: "pokerandom-ce300",
      storageBucket: "pokerandom-ce300.appspot.com",
      messagingSenderId: "637348459448",
      appId: "1:637348459448:web:4ab19e68bcce734692554d"
    };

    // ======== Configuración del tracker ========
    const TAGS = ["curación","ataque","defensa","economía","gacha","ítem","captura"];
    const LOGS_COLLECTION = 'usageLogs'; // <-- ajusta al nombre real de tu colección de usos
    const ATTACKS_COLLECTION = 'attackRequests'; // ya existe en tu proyecto

    // Mapeo de nombres reales (profiles.displayName) a alias visibles
    const NAME_ALIASES = {
      'Ariel': 'Eri',
      'Arturo Manteola Llamas': 'Arturo',
      'Juan Caballero': 'Juan',
      'Enrique Sainz Gessler': 'Enrique',
      'Abel García': 'Abel',
      'Víctor': 'Fuya'
    };

    // Si quieres forzar orden/plantilla de jugadores:
    const DISPLAY_ORDER = ['Enrique','Fuya','Eri','Abel','Juan','Arturo'];

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    onAuthStateChanged(auth, async (user) => {
      if(!user){ await signInAnonymously(auth); return; }
      document.getElementById('mode').textContent = 'Online (anon)';
      boot();
    });

    document.getElementById('homeBtn').addEventListener('click', ()=>{ window.location.href='index.html'; });

    // ======== Estado ========
    let users = []; // [{uid, name, alias}]
    let countsByTag = {}; // tag -> alias -> count
    let attacksMatrix = {}; // attackerAlias -> targetAlias -> count
    let hitsTotals = {}; // targetAlias -> total

    TAGS.forEach(t=> countsByTag[t] = {});

    // ======== Carga base ========
    async function boot(){
      // 1) Cargar perfiles (para obtener displayName y mapear a alias)
      const snap = await getDocs(collection(db,'profiles'));
      users = [];
      snap.forEach(d=>{
        const prof = d.data();
        const name = prof.displayName || 'Desconocido';
        const alias = NAME_ALIASES[name] || name; // por si falta en el mapping
        users.push({ uid: d.id, name, alias });
      });
      // Orden consistente
      users.sort((a,b)=> DISPLAY_ORDER.indexOf(a.alias) - DISPLAY_ORDER.indexOf(b.alias));

      // Inicializa contadores
      users.forEach(u=>{
        TAGS.forEach(t=> countsByTag[t][u.alias] = 0);
        attacksMatrix[u.alias] = {};
        users.forEach(v=> attacksMatrix[u.alias][v.alias] = 0);
        hitsTotals[u.alias] = 0;
      });

      // 2) Suscribirse a usos de cartas (solo acción de uso real)
      // Nota: ajusta los campos si tu colección guarda otros nombres: p.ej. action=='use', tag en TAGS
      onSnapshot(collection(db, LOGS_COLLECTION), (qs)=>{
        // Reinicia
        TAGS.forEach(t=>{ for(const k in countsByTag[t]) countsByTag[t][k]=0; });
        qs.forEach(doc=>{
          const r = doc.data();
          if(r.action && r.action !== 'use') return; // ignorar compras/admin
          const tag = (r.tag || '').toLowerCase();
          const userName = r.userName || r.user || r.userDisplay || r.ownerName || '';
          const alias = NAME_ALIASES[userName] || userName;
          if(TAGS.includes(tag)){
            if(countsByTag[tag][alias] != null){ countsByTag[tag][alias]++; }
          }
        });
        renderRadar(currentTag);
        renderAchievements();
      });

      // 3) Suscribirse a ataques (attackRequests)
      onSnapshot(collection(db, ATTACKS_COLLECTION), (qs)=>{
        // Reinicia
        users.forEach(u=>{ users.forEach(v=> attacksMatrix[u.alias][v.alias]=0); hitsTotals[u.alias]=0; });
        qs.forEach(doc=>{
          const a = doc.data();
          const attackerName = a.attackerName || a.attackerDisplay || a.attackerIdName || '';
          const victimName   = a.victimName   || a.victimDisplay   || a.victimIdName   || '';
          const att = NAME_ALIASES[attackerName] || attackerName;
          const vic = NAME_ALIASES[victimName]   || victimName;
          if(att && vic && attacksMatrix[att] && attacksMatrix[att][vic] != null){
            attacksMatrix[att][vic]++;
            hitsTotals[vic]++; 
          }
        });
        renderAttacksMatrix();
        renderMostHit();
        renderAchievements();
      });

      setupUI();
    }

    // ======== UI: tags & radar ========
    const tagsBar = document.getElementById('tagsBar');
    let currentTag = TAGS[0];
    function setupUI(){
      TAGS.forEach(t=>{
        const b=document.createElement('button'); b.className='tab'; b.textContent=t.toUpperCase();
        if(t===currentTag) b.classList.add('active');
        b.addEventListener('click', ()=>{ currentTag=t; document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active')); b.classList.add('active'); renderRadar(currentTag); });
        tagsBar.appendChild(b);
      });
      renderRadar(currentTag);
    }

    const canvas = document.getElementById('radar');
    const wrap = document.getElementById('radarWrap');
    function sizeCanvas(){ canvas.width=wrap.clientWidth; canvas.height=wrap.clientWidth; }
    window.addEventListener('resize', ()=>{ sizeCanvas(); renderRadar(currentTag); });
    sizeCanvas();

    function renderRadar(tag){
      if(!canvas.getContext) return; const ctx = canvas.getContext('2d');
      ctx.clearRect(0,0,canvas.width,canvas.height);
      const cx=canvas.width/2, cy=canvas.height/2; const R=canvas.width*0.38;

      // Labels en hexágono
      wrap.querySelectorAll('.label').forEach(n=>n.remove());
      const players = users.map(u=>u.alias);
      const N = Math.max(6, players.length);
      const pts = [];
      const max = Math.max(1, ...players.map(p=> countsByTag[tag]?.[p] || 0));
      for(let i=0;i<players.length;i++){
        const ang = -Math.PI/2 + i * (2*Math.PI/players.length);
        const label = document.createElement('div'); label.className='label'; label.textContent = players[i];
        label.style.left = (cx + Math.cos(ang)*(R+18))+'px';
        label.style.top  = (cy + Math.sin(ang)*(R+18))+'px';
        wrap.appendChild(label);

        const value = countsByTag[tag]?.[players[i]] || 0;
        const r = R * (value / (max||1));
        pts.push([cx + Math.cos(ang)*r, cy + Math.sin(ang)*r]);
      }

      // rejilla
      ctx.strokeStyle = 'rgba(255,255,255,.15)';
      for(let k=1;k<=4;k++){
        const r = R*k/4; drawPolygon(ctx, players.length, cx, cy, r);
      }
      // contorno
      ctx.strokeStyle = 'rgba(124,248,255,.85)'; ctx.lineWidth=2; drawPolyline(ctx, pts, true);
      // relleno bonito
      ctx.fillStyle = 'rgba(124,248,255,.18)'; fillPolygon(ctx, pts);

      // título pequeño
      ctx.fillStyle = '#cfe3ff'; ctx.font = '600 14px ui-sans-serif, system-ui'; ctx.textAlign='center';
      ctx.fillText(`Etiqueta: ${tag.toUpperCase()} • máx usos: ${Math.max(...players.map(p=> countsByTag[tag]?.[p]||0),0)}`, cx, cy+R+40);
    }

    function drawPolygon(ctx, n, cx, cy, r){ ctx.beginPath(); for(let i=0;i<n;i++){ const ang=-Math.PI/2 + i*(2*Math.PI/n); const x=cx+Math.cos(ang)*r; const y=cy+Math.sin(ang)*r; if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y); } ctx.closePath(); ctx.stroke(); }
    function drawPolyline(ctx, pts, closed=false){ ctx.beginPath(); pts.forEach(([x,y],i)=> i? ctx.lineTo(x,y): ctx.moveTo(x,y)); if(closed) ctx.closePath(); ctx.stroke(); }
    function fillPolygon(ctx, pts){ ctx.beginPath(); pts.forEach(([x,y],i)=> i? ctx.lineTo(x,y): ctx.moveTo(x,y)); ctx.closePath(); ctx.fill(); }

    // ======== Ataques ========
    function renderAttacksMatrix(){
      const players = users.map(u=>u.alias);
      let html = '<table><thead><tr><th>Atacante ↓ / Objetivo →</th>' + players.map(p=>`<th>${p}</th>`).join('') + '</tr></thead><tbody>';
      players.forEach(att=>{
        html += `<tr><td><b>${att}</b></td>`;
        players.forEach(vic=>{ const v = attacksMatrix[att][vic]||0; html += `<td class="mono" style="text-align:center">${v}</td>`; });
        html += '</tr>';
      });
      html += '</tbody></table>';
      document.getElementById('attacksTableWrap').innerHTML = html;
    }

    function renderMostHit(){
      const tbody = document.getElementById('mostHitBody'); tbody.innerHTML='';
      const arr = users.map(u=>({ alias:u.alias, v: hitsTotals[u.alias]||0 }));
      arr.sort((a,b)=> b.v-a.v);
      arr.forEach((r,i)=>{
        const tr=document.createElement('tr'); tr.innerHTML = `<td>${i+1}</td><td>${r.alias}</td><td class="mono" style="text-align:right">${r.v}</td>`; tbody.appendChild(tr);
      });
    }

    // ======== Logros ========
    function renderAchievements(){
      const box = document.getElementById('achievements'); box.innerHTML='';
      const leaders = {};
      TAGS.forEach(tag=>{
        let best=null, bestV=-1; for(const alias in countsByTag[tag]){ const v=countsByTag[tag][alias]; if(v>bestV){ bestV=v; best=alias; } }
        leaders[tag] = {alias: best, v: bestV};
      });
      // más atacado
      let mostHitAlias=null, mostHitV=-1; for(const a in hitsTotals){ const v=hitsTotals[a]; if(v>mostHitV){ mostHitV=v; mostHitAlias=a; } }

      const fun = [];
      if(mostHitAlias) fun.push({icon:'🛡️', text:`<b>${mostHitAlias}</b> ha sido la <b>piñata oficial</b> del server (${mostHitV} ataques recibidos).`});
      if(leaders['curación'].alias) fun.push({icon:'💊', text:`<b>${leaders['curación'].alias}</b> es quien más se ha curado (${leaders['curación'].v}). ¿Todo bien, doc?`});
      if(leaders['ataque'].alias) fun.push({icon:'⚔️', text:`<b>${leaders['ataque'].alias}</b> está en modo <b>berserker</b> (${leaders['ataque'].v} cartas de ataque).`});
      if(leaders['defensa'].alias) fun.push({icon:'🧱', text:`<b>${leaders['defensa'].alias}</b> activó la <b>muralla china</b> (${leaders['defensa'].v} defensas).`});
      if(leaders['economía'].alias) fun.push({icon:'💰', text:`<b>${leaders['economía'].alias}</b> juega al <b>monopoly</b> (${leaders['economía'].v} cartas de economía).`});
      if(leaders['gacha'].alias) fun.push({icon:'🎰', text:`<b>${leaders['gacha'].alias}</b> vive del <b>azar</b> (${leaders['gacha'].v} gacha).`});
      if(leaders['ítem'].alias) fun.push({icon:'🎒', text:`<b>${leaders['ítem'].alias}</b> cargado hasta las trancas (${leaders['ítem'].v} ítems).`});
      if(leaders['captura'].alias) fun.push({icon:'🧿', text:`<b>${leaders['captura'].alias}</b> <b>cazatalentos</b> del grupo (${leaders['captura'].v} capturas).`});

      fun.forEach(f=>{ const d=document.createElement('div'); d.className='badge'; d.innerHTML = `${f.icon} ${f.text}`; box.appendChild(d); });
    }

  </script>
</body>
</html>
