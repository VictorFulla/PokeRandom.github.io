<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Tracker ‚Äî RandomLock</title>
<style>
:root{--bg:#0d0f14;--panel:#151922;--edge:rgba(255,255,255,.08);--text:#e7ecf5;--muted:#9aa4b2;--accent:#7c5cff;--br:16px}
*{box-sizing:border-box}html,body{height:100%}
body{margin:0;background:linear-gradient(180deg,#0b0e13,#0d1016);color:var(--text);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto}
.wrap{max-width:1200px;margin:0 auto;padding:16px}
.card{background:var(--panel);border:1px solid var(--edge);border-radius:var(--br);padding:16px;box-shadow:0 10px 30px rgba(0,0,0,.3)}
.grid{display:grid;gap:16px;grid-template-columns:2fr 1fr}
@media(max-width:1080px){.grid{grid-template-columns:1fr}}
.section-title{margin:0 0 12px;font-size:18px;display:flex;gap:8px;align-items:center}
.small{font-size:12px;color:var(--muted)}
.badge{display:inline-flex;gap:6px;align-items:center;padding:2px 8px;border-radius:999px;background:#0e121a;border:1px solid var(--edge);font-size:12px}
.hr{height:1px;background:var(--edge);margin:12px 0}
.controls{display:flex;gap:8px;flex-wrap:wrap;align-items:center;justify-content:space-between;margin-bottom:8px}
.filterRow{display:flex;gap:8px;flex-wrap:wrap;align-items:center}

.hexWrap{display:flex;align-items:center;justify-content:center;padding:10px}
.board{position:relative;width:640px;max-width:100%;aspect-ratio:1/1;margin:0 auto}
.userNode{position:absolute;transform:translate(-50%,-50%);background:#0e121a;border:1px solid var(--edge);border-radius:12px;padding:6px 10px;white-space:nowrap;font-weight:800;font-size:14px;box-shadow:0 8px 24px rgba(0,0,0,.35)}
.userNode .small{display:block;font-weight:600}
.userNode.leader{outline:2px solid var(--accent);box-shadow:0 0 0 4px rgba(124,92,255,.2)}
svg{position:absolute;inset:0}

.tags{display:flex;gap:8px;flex-wrap:wrap;justify-content:center;margin-bottom:8px}
.tagChip{display:inline-flex;gap:6px;align-items:center;padding:6px 10px;border-radius:999px;background:#0e121a;border:1px solid var(--edge);font-weight:800}
.tagChip .who{opacity:.85;font-weight:700}

.rankList{display:flex;flex-direction:column;gap:6px}
.rankItem{display:flex;align-items:center;gap:8px;justify-content:space-between;background:#0e121a;border:1px solid var(--edge);border-radius:10px;padding:8px 10px}
.rankItem .name{font-weight:800}
.rankItem .count{font-variant-numeric:tabular-nums;font-weight:900}

.achievements{display:grid;gap:8px;grid-template-columns:repeat(2,minmax(160px,1fr))}
@media(max-width:560px){.achievements{grid-template-columns:1fr}}
.achItem{background:#0e121a;border:1px solid var(--edge);border-radius:10px;padding:10px}

.btn{background:#0e121a;border:1px solid var(--edge);color:#fff;border-radius:999px;padding:6px 10px;cursor:pointer}
.btn.active{outline:2px solid var(--accent)}
select{background:#0e121a;color:#fff;border:1px solid var(--edge);border-radius:10px;padding:6px 10px}
</style>
</head>
<body>
<div class="wrap">
  <h1 class="section-title">üìà Tracker de cartas <span class="small">en vivo</span></h1>

  <div class="controls card">
    <div class="filterRow">
      <span class="small">Filtrar etiqueta:</span>
      <button class="btn" data-tag="">Todas</button>
      <button class="btn" data-tag="ataque">Ataque</button>
      <button class="btn" data-tag="defensa">Defensa</button>
      <button class="btn" data-tag="econom√≠a">Econom√≠a</button>
      <button class="btn" data-tag="curaci√≥n">Curaci√≥n</button>
      <button class="btn" data-tag="gacha">Gacha</button>
      <button class="btn" data-tag="√≠tem">√çtem</button>
      <button class="btn" data-tag="captura">Captura</button>
    </div>
    <div class="filterRow">
      <span class="small">Rango:</span>
      <select id="rangeSel">
        <option value="all">Todo el hist√≥rico</option>
        <option value="7">√öltimos 7 d√≠as</option>
        <option value="30">√öltimos 30 d√≠as</option>
        <option value="90">√öltimos 90 d√≠as</option>
      </select>
    </div>
  </div>

  <div id="tagRow" class="tags"></div>

  <div class="grid">
    <section class="card">
      <div class="section-title">üî∑ Diagrama hexagonal de uso por usuario</div>
      <div class="hexWrap">
        <div class="board" id="board">
          <svg id="hexSvg" viewBox="0 0 100 100" preserveAspectRatio="none"></svg>
        </div>
      </div>
      <div class="hr"></div>
      <div class="section-title">üèÖ Frases‚Äëlogro</div>
      <div id="achv" class="achievements"></div>
    </section>

    <aside class="card">
      <div class="section-title">‚öîÔ∏è Rankings</div>
      <div class="small">Se actualizan con eventos reales (no incluye ADMIN).</div>
      <div class="hr"></div>

      <h3 class="small">Ataques ejecutados</h3>
      <div id="rankSent" class="rankList"></div>

      <div class="hr"></div>
      <h3 class="small">Ataques recibidos</h3>
      <div id="rankRecv" class="rankList"></div>
    </aside>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
import { getFirestore, collection, query, where, orderBy, onSnapshot, getDocs, serverTimestamp, addDoc } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCPhWAShfR33sAuZ2H4Y2BAGnF8wkkv_S0",
  authDomain: "pokerandom-ce300.firebaseapp.com",
  projectId: "pokerandom-ce300",
  storageBucket: "pokerandom-ce300.firebasestorage.app",
  messagingSenderId: "637348459448",
  appId: "1:637348459448:web:4ab19e68bcce734692554d"
};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const TAGS = ["ataque","defensa","econom√≠a","curaci√≥n","gacha","√≠tem","captura"];
const $ = s => document.querySelector(s);
const board = $("#board"), svg = $("#hexSvg");
const tagRow = $("#tagRow"), rankSent = $("#rankSent"), rankRecv = $("#rankRecv"), achv = $("#achv");
const rangeSel = $("#rangeSel");
let tagFilter = ""; // "" = todos

// UI buttons
document.querySelectorAll(".btn[data-tag]").forEach(btn=>{
  btn.onclick = ()=>{
    document.querySelectorAll(".btn[data-tag]").forEach(b=>b.classList.remove("active"));
    btn.classList.add("active");
    tagFilter = (btn.dataset.tag||"").toLowerCase();
    recomputeAndRender();
  };
});
document.querySelector('.btn[data-tag=""]').classList.add("active");
rangeSel.onchange = ()=> recomputeAndRender();

let users = []; // [{id,name}]
let rawUsage = []; // array de {uid, tag, createdAt}
let rawSent = [];  // {attackerId, createdAt}
let rawRecv = [];  // {victimId, createdAt}

const POS = [
  {x:50,y:5},{x:90,y:25},{x:90,y:75},{x:50,y:95},{x:10,y:75},{x:10,y:25},
];
function renderHexGrid(){
  const pts = POS.map(p=>`${p.x},${p.y}`).join(" ");
  svg.innerHTML = `<polygon points="${pts}" fill="none" stroke="rgba(255,255,255,.15)" stroke-width="1"/>`;
}
renderHexGrid();

function timePass(createdAt){
  const r = rangeSel.value;
  if (r==="all") return true;
  const days = parseInt(r,10);
  const t = createdAt?.toMillis ? createdAt.toMillis() : (createdAt?.seconds? createdAt.seconds*1000 : Date.parse(createdAt)||0);
  if (!t) return false;
  const cutoff = Date.now() - days*86400000;
  return t >= cutoff;
}

function recomputeAndRender(){
  const countsByUserTag = {};
  const sentByUser = {}, recvByUser = {};
  const ensure = (uid)=>{
    countsByUserTag[uid] = countsByUserTag[uid] || Object.fromEntries(TAGS.map(t=>[t,0]));
    sentByUser[uid] = sentByUser[uid] || 0;
    recvByUser[uid] = recvByUser[uid] || 0;
  };

  rawUsage.filter(u => (!tagFilter || (u.tag||"").toLowerCase()===tagFilter) && timePass(u.createdAt)).forEach(u=>{
    ensure(u.uid);
    const tag = (u.tag||"").toLowerCase();
    if (TAGS.includes(tag)) countsByUserTag[u.uid][tag]++;
  });
  rawSent.filter(e=> timePass(e.createdAt)).forEach(e=>{ ensure(e.attackerId); sentByUser[e.attackerId]++; });
  rawRecv.filter(e=> timePass(e.createdAt)).forEach(e=>{ ensure(e.victimId);   recvByUser[e.victimId]++; });

  // Render users on hex
  [...board.querySelectorAll(".userNode")].forEach(n=>n.remove());
  users.slice(0,6).forEach((u,i)=>{
    const n = document.createElement("div");
    n.className = "userNode";
    n.style.left = POS[i].x+"%";
    n.style.top  = POS[i].y+"%";
    const total = Object.values(countsByUserTag[u.id]||{}).reduce((a,b)=>a+b,0);
    n.innerHTML = `<div>${u.name}</div><span class="small">usos: ${total}</span>`;
    board.appendChild(n);
  });
  // leaders by total
  const totals = users.map(u=>({uid:u.id,sum:Object.values(countsByUserTag[u.id]||{}).reduce((a,b)=>a+b,0)}));
  const max = Math.max(0, ...totals.map(t=>t.sum));
  totals.filter(t=>t.sum===max && max>0).forEach(t=>{
    const i = users.findIndex(u=>u.id===t.uid);
    const node = board.querySelectorAll(".userNode")[i];
    if (node) node.classList.add("leader");
  });

  // chips l√≠der por etiqueta (respetando filtro: si hay filtro, solo mostramos esa etiqueta)
  tagRow.innerHTML = "";
  const tagsToShow = tagFilter? [tagFilter] : TAGS;
  tagsToShow.forEach(tag=>{
    const entries = users.map(u=>({uid:u.id, n:(countsByUserTag[u.id]?.[tag]||0)}));
    const m = Math.max(0, ...entries.map(e=>e.n));
    const leaders = entries.filter(e=>e.n===m && m>0).map(e=> users.find(x=>x.id===e.uid)?.name || e.uid).join(", ") || "‚Äî";
    const chip = document.createElement("div");
    chip.className = "tagChip";
    chip.innerHTML = `<span>üè∑Ô∏è ${tag}</span> <span class="who small">‚Ä¢ l√≠der: ${leaders} (${m})</span>`;
    tagRow.appendChild(chip);
  });

  // rankings
  function renderList(dest, map){
    const arr = users.map(u=>({name:u.name, n:map[u.id]||0})).sort((a,b)=>b.n-a.n).slice(0,6);
    dest.innerHTML = arr.map(r=>`<div class="rankItem"><span class="name">${r.name}</span><span class="count">${r.n}</span></div>`).join("");
  }
  renderList(rankSent, sentByUser);
  renderList(rankRecv, recvByUser);

  // logros
  const ach = [];
  const most = tag => {
    const arr = users.map(u=>({uid:u.id, n:(countsByUserTag[u.id]?.[tag]||0)}));
    const m = Math.max(0, ...arr.map(a=>a.n));
    return arr.filter(a=>a.n===m && m>0).map(a=> users.find(x=>x.id===a.uid)?.name || a.uid).join(", ") || null;
  };
  const avaro = most("econom√≠a"); if(avaro) ach.push(`üí∞ <b>${avaro}</b> es el m√°s avaricioso: ha usado m√°s cartas de econom√≠a.`);
  const agresivo = most("ataque"); if(agresivo) ach.push(`‚öîÔ∏è <b>${agresivo}</b> es el m√°s agresivo: lidera en cartas de ataque.`);
  const tanque = most("defensa"); if(tanque) ach.push(`üõ°Ô∏è <b>${tanque}</b> vive en guardia: top en defensa.`);
  const botiquin = most("curaci√≥n"); if(botiquin) ach.push(`ü©π <b>${botiquin}</b> farmacia ambulante: top en curaci√≥n.`);
  const gachatier = most("gacha"); if(gachatier) ach.push(`üé≤ <b>${gachatier}</b> el lud√≥pata: abusa del gacha.`);
  const itemlord = most("√≠tem"); if(itemlord) ach.push(`üéí <b>${itemlord}</b> el acumulador de trastos: top en √≠tems.`);
  const cazador = most("captura"); if(cazador) ach.push(`üï∏Ô∏è <b>${cazador}</b> pok√©‚Äëpoacher: top en capturas.`);
  const punching = users.map(u=>({name:u.name, n: rawRecv.filter(e=>e.victimId===u.id && timePass(e.createdAt)).length})).sort((a,b)=>b.n-a.n)[0];
  if (punching && punching.n>0) ach.push(`üòµ <b>${punching.name}</b> es el saco de boxeo: el m√°s atacado.`);
  achv.innerHTML = ach.map(t=>`<div class="achItem small">${t}</div>`).join("") || `<div class="small">Nada a√∫n‚Ä¶ ¬°usen cartas!</div>`;
}

async function bootstrap(){
  // 1) Usuarios
  const ps = await getDocs(collection(db,"profiles"));
  users = ps.docs.map(d=>({id:d.id, name: d.data().displayName || d.id})).slice(0,6);

  // 2) Cargar HIST√ìRICO + realtime
  const uq = query(collection(db,"usageLogs"), where("action","==","use"), orderBy("createdAt","asc"));
  const aq = query(collection(db,"attackLogs"), orderBy("createdAt","asc"));
  // Full fetch para mostrar pasado (si la colecci√≥n ya tiene datos)
  const u0 = await getDocs(uq);
  rawUsage = u0.docs.map(d=>d.data());
  const a0 = await getDocs(aq);
  rawSent = a0.docs.filter(d=>d.data().type==="sent").map(d=>d.data());
  rawRecv = a0.docs.filter(d=>d.data().type==="received").map(d=>d.data());
  recomputeAndRender();

  // Suscripciones en vivo
  onSnapshot(uq, (s)=>{
    s.docChanges().forEach(ch=>{
      if (ch.type==="added"){ rawUsage.push(ch.doc.data()); }
    });
    recomputeAndRender();
  });
  onSnapshot(aq, (s)=>{
    s.docChanges().forEach(ch=>{
      const d=ch.doc.data();
      if (ch.type==="added"){
        if (d.type==="sent") rawSent.push(d);
        else if (d.type==="received") rawRecv.push(d);
      }
    });
    recomputeAndRender();
  });
}

onAuthStateChanged(auth, ()=> bootstrap().catch(console.error));
</script>
</body>
</html>