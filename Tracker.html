<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Tracker ‚Äî RandomLock</title>
<style>
:root{
  --bg:#0d0f14; --panel:#151922; --edge:rgba(255,255,255,.08);
  --text:#e7ecf5; --muted:#9aa4b2; --accent:#7c5cff; --br:16px;
}
*{box-sizing:border-box} html,body{height:100%}
body{margin:0;background:linear-gradient(180deg,#0b0e13,#0d1016);color:var(--text);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto}
.wrap{max-width:1200px;margin:0 auto;padding:16px}
.card{background:var(--panel);border:1px solid var(--edge);border-radius:var(--br);padding:16px;box-shadow:0 10px 30px rgba(0,0,0,.3)}
.grid{display:grid;gap:16px;grid-template-columns:2fr 1fr}
@media(max-width:1080px){.grid{grid-template-columns:1fr}}
.section-title{margin:0 0 12px;font-size:18px;display:flex;gap:8px;align-items:center}
.small{font-size:12px;color:var(--muted)}
.badge{display:inline-flex;gap:6px;align-items:center;padding:2px 8px;border-radius:999px;background:#0e121a;border:1px solid var(--edge);font-size:12px}
.hr{height:1px;background:var(--edge);margin:12px 0}

/* Hex board */
.hexWrap{display:flex;align-items:center;justify-content:center;padding:10px}
.board{position:relative;width:640px;max-width:100%;aspect-ratio:1/1;margin:0 auto}
.userNode{
  position:absolute; transform:translate(-50%,-50%);
  background:#0e121a; border:1px solid var(--edge); border-radius:12px;
  padding:6px 10px; white-space:nowrap; font-weight:800; font-size:14px;
  box-shadow:0 8px 24px rgba(0,0,0,.35);
}
.userNode .small{display:block; font-weight:600}
.userNode.leader{outline:2px solid var(--accent); box-shadow:0 0 0 4px rgba(124,92,255,.2)}

svg{position:absolute; inset:0}

/* Tag chips */
.tags{display:flex;gap:8px;flex-wrap:wrap;justify-content:center;margin-bottom:8px}
.tagChip{display:inline-flex;gap:6px;align-items:center;padding:6px 10px;border-radius:999px;background:#0e121a;border:1px solid var(--edge);font-weight:800}
.tagChip .who{opacity:.85;font-weight:700}

/* Rankings */
.rankList{display:flex;flex-direction:column;gap:6px}
.rankItem{display:flex;align-items:center;gap:8px;justify-content:space-between;background:#0e121a;border:1px solid var(--edge);border-radius:10px;padding:8px 10px}
.rankItem .name{font-weight:800}
.rankItem .count{font-variant-numeric:tabular-nums; font-weight:900}

/* Logros */
.achievements{display:grid;gap:8px;grid-template-columns:repeat(2,minmax(160px,1fr))}
@media(max-width:560px){.achievements{grid-template-columns:1fr}}
.achItem{background:#0e121a;border:1px solid var(--edge);border-radius:10px;padding:10px}
</style>
</head>
<body>
<div class="wrap">
  <h1 class="section-title">üìà Tracker de cartas <span class="small">en vivo</span></h1>

  <!-- Etiquetas con l√≠der actual -->
  <div id="tagRow" class="tags"></div>

  <div class="grid">
    <!-- Panel principal: Hex + frases -->
    <section class="card">
      <div class="section-title">üî∑ Diagrama hexagonal de uso por usuario</div>
      <div class="hexWrap">
        <div class="board" id="board">
          <!-- SVG para malla -->
          <svg id="hexSvg" viewBox="0 0 100 100" preserveAspectRatio="none"></svg>
          <!-- nodos de usuarios se inyectan aqu√≠ -->
        </div>
      </div>
      <div class="hr"></div>
      <div class="section-title">üèÖ Frases-logro (temporada completa)</div>
      <div id="achv" class="achievements"></div>
    </section>

    <!-- Sidebar: Rankings -->
    <aside class="card">
      <div class="section-title">‚öîÔ∏è Rankings</div>
      <div class="small">Se actualizan con eventos reales (no incluye ADMIN).</div>
      <div class="hr"></div>

      <h3 class="small">Ataques ejecutados</h3>
      <div id="rankSent" class="rankList"></div>

      <div class="hr"></div>
      <h3 class="small">Ataques recibidos</h3>
      <div id="rankRecv" class="rankList"></div>
    </aside>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
import {
  getFirestore, collection, query, where, orderBy, onSnapshot, getDocs
} from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCPhWAShfR33sAuZ2H4Y2BAGnF8wkkv_S0",
  authDomain: "pokerandom-ce300.firebaseapp.com",
  projectId: "pokerandom-ce300",
  storageBucket: "pokerandom-ce300.firebasestorage.app",
  messagingSenderId: "637348459448",
  appId: "1:637348459448:web:4ab19e68bcce734692554d"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const TAGS = ["ataque","defensa","econom√≠a","curaci√≥n","gacha","√≠tem","captura"];

const $ = s => document.querySelector(s);
const board = $("#board");
const svg = $("#hexSvg");
const tagRow = $("#tagRow");
const rankSent = $("#rankSent");
const rankRecv = $("#rankRecv");
const achv = $("#achv");

let users = []; // [{id, name}]
let countsByUserTag = {}; // uid -> {tag -> n}
let sentByUser = {};      // uid -> n
let recvByUser = {};      // uid -> n

function nameOf(uid){ return users.find(u=>u.id===uid)?.name || uid.slice(0,6); }

// --- Layout hex (6 posiciones) ---
const POS = [
  {x:50, y:5},    // top
  {x:90, y:25},
  {x:90, y:75},
  {x:50, y:95},   // bottom
  {x:10, y:75},
  {x:10, y:25},
];
function renderHexGrid(){
  // dibuja hex√°gono
  const pts = POS.map(p=>`${p.x},${p.y}`).join(" ");
  svg.innerHTML = `<polygon points="${pts}" fill="none" stroke="rgba(255,255,255,.15)" stroke-width="1"/>`;
}
renderHexGrid();

function ensureUser(uid,name){
  if (!users.some(u=>u.id===uid)){
    users.push({id:uid, name});
  }
  countsByUserTag[uid] = countsByUserTag[uid] || {};
  TAGS.forEach(t=> countsByUserTag[uid][t] = countsByUserTag[uid][t] || 0);
  sentByUser[uid] = sentByUser[uid] || 0;
  recvByUser[uid] = recvByUser[uid] || 0;
}

function renderUsers(){
  // limpia nodos
  [...board.querySelectorAll(".userNode")].forEach(n=>n.remove());
  users.slice(0,6).forEach((u, i)=>{
    const n = document.createElement("div");
    n.className = "userNode";
    n.style.left = POS[i].x + "%";
    n.style.top  = POS[i].y + "%";
    const totalUsos = TAGS.reduce((a,t)=>a+(countsByUserTag[u.id]?.[t]||0),0);
    n.innerHTML = `<div>${u.name}</div><span class="small">usos: ${totalUsos}</span>`;
    board.appendChild(n);
  });
  // resaltar l√≠deres globales por total
  const totals = users.map(u=>({uid:u.id, sum:TAGS.reduce((a,t)=>a+(countsByUserTag[u.id]?.[t]||0),0)}));
  const max = Math.max(0, ...totals.map(t=>t.sum));
  totals.filter(t=>t.sum===max && max>0).forEach(t=>{
    const idx = users.findIndex(u=>u.id===t.uid);
    const node = board.querySelectorAll(".userNode")[idx];
    if (node) node.classList.add("leader");
  });
}

function renderTagLeaders(){
  tagRow.innerHTML = "";
  TAGS.forEach(tag=>{
    let entries = users.map(u=>({uid:u.id, n:countsByUserTag[u.id]?.[tag]||0}));
    const max = Math.max(0, ...entries.map(e=>e.n));
    const leaders = entries.filter(e=>e.n===max && max>0).map(e=>nameOf(e.uid)).join(", ") || "‚Äî";
    const chip = document.createElement("div");
    chip.className = "tagChip";
    chip.innerHTML = `<span>üè∑Ô∏è ${tag}</span> <span class="who small">‚Ä¢ l√≠der: ${leaders} (${max})</span>`;
    tagRow.appendChild(chip);
  });
}

function renderRanks(){
  function renderList(dest, map){
    const arr = users.map(u=>({name:u.name, n:map[u.id]||0})).sort((a,b)=>b.n-a.n).slice(0,6);
    dest.innerHTML = arr.map(row=>`<div class="rankItem"><span class="name">${row.name}</span><span class="count">${row.n}</span></div>`).join("");
  }
  renderList(rankSent, sentByUser);
  renderList(rankRecv, recvByUser);
}

function renderAchievements(){
  const ach = [];
  const most = tag => {
    const arr = users.map(u=>({uid:u.id, n:(countsByUserTag[u.id]?.[tag]||0)}));
    const max = Math.max(0, ...arr.map(a=>a.n));
    return arr.filter(a=>a.n===max && max>0).map(a=>nameOf(a.uid)).join(", ") || null;
  };
  const avaro = most("econom√≠a"); if (avaro) ach.push(`üí∞ <b>${avaro}</b> es el m√°s avaricioso: ha usado m√°s cartas de econom√≠a.`);
  const agresivo = most("ataque"); if (agresivo) ach.push(`‚öîÔ∏è <b>${agresivo}</b> es el m√°s agresivo: lidera en cartas de ataque.`);
  const tanque = most("defensa"); if (tanque) ach.push(`üõ°Ô∏è <b>${tanque}</b> vive en guardia: top en cartas de defensa.`);
  const botiquin = most("curaci√≥n"); if (botiquin) ach.push(`ü©π <b>${botiquin}</b> farmacia ambulante: top en curaci√≥n.`);
  const gachatier = most("gacha"); if (gachatier) ach.push(`üé≤ <b>${gachatier}</b> el lud√≥pata: abusa del gacha.`);
  const itemlord = most("√≠tem"); if (itemlord) ach.push(`üéí <b>${itemlord}</b> el acumulador de trastos: top en √≠tems.`);
  const cazador = most("captura"); if (cazador) ach.push(`üï∏Ô∏è <b>${cazador}</b> pok√©-poacher: top en capturas.`);
  const punching = Object.entries(recvByUser).sort((a,b)=>b[1]-a[1])[0];
  if (punching && punching[1]>0) ach.push(`üòµ <b>${nameOf(punching[0])}</b> es el saco de boxeo: el m√°s atacado.`);

  achv.innerHTML = ach.map(t=>`<div class="achItem small">${t}</div>`).join("") || `<div class="small">Nada a√∫n‚Ä¶ ¬°usen cartas!</div>`;
}

// === Subs en vivo ===
async function bootstrap(){
  // 1) Perfiles (para nombres y lista fija de 6)
  // Reutilizamos lo que ya rellenas en profiles desde index.html (colecci√≥n "profiles")
  const snap = await getDocs(collection(db, "profiles"));
  users = snap.docs.map(d=>({id:d.id, name: d.data().displayName || d.id})).slice(0,6);
  users.forEach(u=> ensureUser(u.id, u.name));
  renderUsers();

  // 2) USAGE: todos los usos reales (action=="use")
  const uq = query(collection(db,"usageLogs"), where("action","==","use"), orderBy("createdAt","asc"));
  onSnapshot(uq, (s)=>{
    s.docChanges().forEach(ch=>{
      const d = ch.doc.data() || {};
      const uid = d.uid; const tag = (d.tag||"").toLowerCase();
      if (!uid || !TAGS.includes(tag)) return;
      ensureUser(uid, d.userName || uid);
      countsByUserTag[uid][tag] = (countsByUserTag[uid][tag]||0) + 1;
    });
    renderUsers(); renderTagLeaders(); renderAchievements();
  });

  // 3) ATAQUES: contadores sent/received
  const aq = query(collection(db,"attackLogs"), orderBy("createdAt","asc"));
  onSnapshot(aq, (s)=>{
    s.docChanges().forEach(ch=>{
      const d = ch.doc.data() || {};
      if (d.type === "sent" && d.attackerId){
        ensureUser(d.attackerId, d.attackerName || d.attackerId);
        sentByUser[d.attackerId] = (sentByUser[d.attackerId]||0) + 1;
      }
      if (d.type === "received" && d.victimId){
        ensureUser(d.victimId, d.victimName || d.victimId);
        recvByUser[d.victimId] = (recvByUser[d.victimId]||0) + 1;
      }
    });
    renderRanks(); renderAchievements();
  });
}

onAuthStateChanged(auth, (u)=>{
  if (!u){ /* puedes exigir login si quieres */ }
  bootstrap();
});
</script>
</body>
</html>
