<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Random Lock Wobalonga ‚Äî v5</title>
  <style>
    :root{
      --bg:#0d0f14;--panel:#151922;--edge:rgba(255,255,255,.08);
      --text:#e9eef7;--muted:#a7b0c0;--accent:#7c5cff;--accent-2:#5f47ff;
      --good:#22c55e;--bad:#ef4444;--warn:#f59e0b;--br:16px
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:linear-gradient(180deg,#0b0e13,#0d1016);color:var(--text);font:14px/1.4 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu}
    .wrap{max-width:1240px;margin:0 auto;padding:16px}

    header{position:sticky;top:0;z-index:50;backdrop-filter:saturate(1.2) blur(8px);background:rgba(13,16,22,.75);border-bottom:1px solid var(--edge)}
    header .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    h1.logo{margin:0;font-size:22px;letter-spacing:.3px;display:flex;align-items:center;gap:10px}
    h1.logo .brand{font-weight:900;background:linear-gradient(92deg,#fff,#a08cff);-webkit-background-clip:text;background-clip:text;color:transparent;text-shadow:0 0 18px rgba(124,92,255,.25)}
    .sub{font-size:12px;color:var(--muted)}

    .btn{background:var(--accent);border:none;color:#fff;border-radius:12px;padding:10px 14px;cursor:pointer;transition:.15s}
    .btn:hover{transform:translateY(-1px)}
    .btn.alt{background:#0e121a;border:1px solid var(--edge);color:var(--text)}
    .btn.good{background:var(--good)}
    .btn.bad{background:var(--bad)}
    .btn.warn{background:var(--warn);color:#2d1500}
    .chip{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:999px;border:1px solid var(--edge);background:#0e121a}

    .grid{display:grid;gap:16px;grid-template-columns:2fr 1fr}
    @media(max-width:1040px){.grid{grid-template-columns:1fr}}

    .card{background:var(--panel);border:1px solid var(--edge);border-radius:var(--br);padding:16px;box-shadow:0 10px 30px rgba(0,0,0,.28)}
    .section-title{margin:0 0 12px 0;font-size:18px;display:flex;align-items:center;gap:8px}
    .small{font-size:12px;color:var(--muted)}
    .hr{height:1px;background:var(--edge);margin:10px 0}

    /* Inventario */
    .toolbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .cards{display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:12px}
    .cardSlot{position:relative;background:#0e121a;border:1px solid var(--edge);border-radius:14px;padding:10px;cursor:pointer;transition:.15s}
    .cardSlot:hover{transform:translateY(-2px)}
    .cardSlot .imgWrap{aspect-ratio:1/1;border-radius:10px;overflow:hidden;border:1px solid var(--edge);display:grid;place-items:center;background:#0b0e13}
    .cardSlot img{max-width:100%;max-height:100%;display:block;filter:contrast(1.05)}
    .cardSlot.dim img{filter:grayscale(1) contrast(.8) opacity(.5)}
    .cardSlot .title{font-weight:700;margin-top:8px}
    .cardSlot .meta{font-size:12px;color:var(--muted)}
    .cardSlot .qty{position:absolute;top:8px;right:8px;background:#111;border:1px solid var(--edge);padding:2px 6px;border-radius:10px;font-size:12px}

    /* Modales */
    .modal{position:fixed;inset:0;background:rgba(0,0,0,0.6);display:none;align-items:center;justify-content:center;padding:18px}
    .modal[aria-hidden="false"]{display:flex}
    .modal .panel{background:var(--panel);border:1px solid var(--edge);border-radius:18px;max-width:820px;width:100%;padding:16px;display:grid;gap:14px;grid-template-columns:1fr 1fr;max-height:90vh;overflow-y:auto;overflow-x:hidden}
    .closeX{justify-self:end;background:#111;border:1px solid var(--edge);color:var(--text);border-radius:8px;padding:6px 10px;cursor:pointer}

    /* Popups de notificaci√≥n: una columna, carta centrada */
    #inboxModal .panel, #attackModal .panel { grid-template-columns: 1fr; max-width: 720px; }
    #inboxPreview.cards, #attackPreview.cards { grid-template-columns: 1fr; justify-items: center; }
    #inboxPreview .cardSlot, #attackPreview .cardSlot { width: 260px; }
    #inboxModal .hr, #attackModal .hr { display: none; }

    /* Wallet chip arriba dcha */
    .rightBar{margin-left:auto;display:flex;gap:8px;align-items:center}
    .kpi{font-weight:900;font-size:18px}

    /* Logs */
    .logs{max-height:300px;overflow:auto;border:1px solid var(--edge);border-radius:12px;padding:8px}
    .logs ul{list-style:none;margin:0;padding:0;display:grid;gap:6px}
    .logs li{padding:6px 8px;border:1px dashed var(--edge);border-radius:8px}
    .logs li.win{color:var(--good)}
    .logs li.lose{color:var(--bad)}
    .log-admin{ color:#b19cff; }

    /* FAB admin flotante */
    .fab{position:fixed;right:16px;bottom:16px;padding:12px 16px;border-radius:999px;border:1px solid var(--edge);background:#111;color:#fff;box-shadow:0 6px 18px rgba(0,0,0,0.35);cursor:pointer;z-index:9999}
    .fab:hover{transform:translateY(-1px)}
    .admin-tag{background:#633cff;color:#fff;border-radius:6px;padding:2px 6px;font-size:12px;margin-right:6px}

    .input{width:100%;background:#0e121a;border:1px solid var(--edge);border-radius:10px;color:var(--text);padding:8px 10px}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .badge{background:#0e121a;border:1px solid var(--edge);padding:2px 6px;border-radius:999px;font-size:11px}
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <div class="row">
        <h1 class="logo"><span class="brand">Random Lock Wobalonga</span> <span class="sub">inventario + ruleta</span></h1>
        <div class="rightBar">
          <div class="chip">
            <span>ü™ô</span>
            <span id="coins" class="kpi">0</span>
            <span class="sub">monedas</span>
          </div>
          <div class="chip"><span>üßø</span><span id="karma" class="kpi">0</span><span class="sub">karma</span></div>
          <button id="btnLoginGoogle" class="btn alt">Entrar con Google</button>
          <button id="btnLogout" class="btn alt" style="display:none">Salir</button>
        </div>
      </div>
    </div>
  </header>

  <main class="wrap grid">
    <section>
      <div class="card">
        <div class="section-title">Inventario</div>
        <div class="toolbar">
          <label class="small"><input type="checkbox" id="hideZero"/> Ocultar 0</label>
          <select id="filterType" class="input" style="max-width:200px">
            <option value="">Todos los tipos</option>
            <option value="Curacion">Curaci√≥n</option>
            <option value="ataque">Ataque</option>
            <option value="gacha">Gacha</option>
            <option value="economia">Econom√≠a</option>
            <option value="defensa">Defensa</option>
            <option value="item">√çtem</option>
            <option value="captura">Captura</option>
          </select>
        </div>
        <div id="inventory" class="cards" style="margin-top:12px"></div>
      </div>

      <div class="card" style="margin-top:16px">
        <div class="section-title">Ruleta</div>
        <div class="grid2">
          <button id="spinPaid" class="btn">Tirar (gasta 1 Ruleta)</button>
          <button id="spinFree" class="btn alt">Tirada gratis (post-gym)</button>
        </div>
        <div class="small" style="margin-top:8px">Resultados: <span id="slotText" class="badge">‚Äî</span></div>
      </div>
    </section>

    <aside>
      <div class="card">
        <div class="section-title">Monedero</div>
        <div class="grid2">
          <button id="add1" class="btn good">+1</button>
          <button id="sub1" class="btn bad">‚àí1</button>
        </div>
        <div class="hr"></div>
        <div class="grid2">
          <button id="btnLider" class="btn alt">L√≠der completado</button>
          <button id="btnImportante" class="btn alt">Combate importante</button>
        </div>
      </div>

      <div class="card" style="margin-top:16px">
        <div class="section-title">Historial</div>
        <div class="logs"><ul id="walletLogList"></ul></div>
        <div class="hr"></div>
        <div class="section-title small">Cartas usadas</div>
        <div class="logs"><ul id="useLogList"></ul></div>
      </div>
    </aside>
  </main>

  <!-- FAB ADMIN -->
  <button id="adminFab" class="fab" title="Admin cartas">Admin</button>
  <!-- Modal ADMIN -->
  <div id="adminModal" class="modal" aria-hidden="true">
    <div class="panel" role="dialog" aria-label="Administrador de cartas" style="grid-template-columns:1fr;max-width:720px">
      <button class="closeX" id="adminCloseX">Cerrar</button>
      <h3>üõ†Ô∏è Administrador de cartas</h3>
      <div class="small">Selecciona carta y cantidad. Puedes <strong>a√±adir</strong> o <strong>retirar</strong>. Se registra como <span class="admin-tag">[ADMIN]</span>.</div>
      <div class="grid2" style="margin-top:8px">
        <div>
          <label class="small" for="adminCardSelect">Carta</label>
          <select id="adminCardSelect" class="input"></select>
        </div>
        <div>
          <label class="small" for="adminQty">Cantidad</label>
          <input id="adminQty" type="number" min="1" value="1" class="input" />
        </div>
      </div>
      <div class="flex" style="display:flex;gap:10px;margin-top:10px">
        <button id="adminAddBtn" class="btn good">A√±adir</button>
        <button id="adminRemoveBtn" class="btn bad">Retirar</button>
      </div>
    </div>
  </div>

  <!-- Modal ROBO (v√≠ctima) -->
  <div id="inboxModal" class="modal" aria-hidden="true">
    <div class="panel" role="dialog" aria-label="Notificaci√≥n de robo" style="grid-template-columns:1fr;max-width:720px">
      <button class="closeX" id="inboxCloseX">Cerrar</button>
      <h3>‚ö†Ô∏è Te han robado una carta</h3>
      <div class="small" id="inboxText">‚Ä¶</div>
      <div id="inboxPreview" class="cards" style="margin-top:10px"></div>
      <div class="flex"><button id="inboxApply" class="btn bad">OK (restar de mi inventario)</button></div>
    </div>
  </div>

  <!-- Modal ATAQUE (v√≠ctima) -->
  <div id="attackModal" class="modal" aria-hidden="true">
    <div class="panel" role="dialog" aria-label="Notificaci√≥n de ataque" style="grid-template-columns:1fr;max-width:720px">
      <button class="closeX" id="attackCloseX">Cerrar</button>
      <h3>‚öîÔ∏è Has recibido un ataque</h3>
      <div class="small" id="attackText">‚Ä¶</div>
      <div id="attackPreview" class="cards" style="margin-top:10px"></div>
      <div id="defenseButtons" class="flex"><button id="attackOk" class="btn bad">OK (recibir ataque)</button></div>
    </div>
  </div>

  <!-- Modal REWARD (ruleta) -->
  <div id="rewardModal" class="modal" aria-hidden="true">
    <div class="panel" role="dialog" aria-label="Recompensa">
      <button class="closeX" id="rewardCloseX">Cerrar</button>
      <h3 id="rewardName">Recompensa</h3>
      <div id="rewardMeta" class="small"></div>
      <div class="cards" style="grid-template-columns:1fr;justify-items:center">
        <div class="cardSlot" style="width:260px">
          <div class="imgWrap"><img id="rewardImg" alt="reward" /></div>
        </div>
      </div>
      <div class="flex"><button id="rewardClose" class="btn alt">OK</button></div>
    </div>
  </div>

  <!-- Modal SHUFFLE (barajear) -->
  <div id="shuffleModal" class="modal" aria-hidden="true">
    <div class="panel" role="dialog" aria-label="Barajear cartas" style="grid-template-columns:1fr">
      <button class="closeX" id="shuffleCloseX">Cerrar</button>
      <h3>üîÄ Barajear cartas</h3>
      <div class="small">Elige <strong>3</strong> unidades de tu inventario (pueden ser repetidas). Recibir√°s <strong>2</strong> nuevas ponderadas por rareza.</div>
      <div class="small">Seleccionadas: <span id="shuffleCount" class="badge">0</span></div>
      <div id="shufflePickGrid" class="cards" style="margin-top:8px"></div>
      <div class="flex"><button id="shuffleConfirm" class="btn" disabled>Confirmar barajeo</button><button id="shuffleCancel" class="btn alt">Cancelar</button></div>
    </div>
  </div>

  <script type="module">
    // ===== Firebase SDK (modular) =====
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
    import { getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";
    import { getFirestore, collection, doc, getDoc, setDoc, updateDoc, addDoc, onSnapshot, query, where, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

    // üëâ TU CONFIG (la que ya me pasaste)
    const firebaseConfig = {
      apiKey: "AIzaSyCPhWAShfR33sAuZ2H4Y2BAGnF8wkkv_S0",
      authDomain: "pokerandom-ce300.firebaseapp.com",
      projectId: "pokerandom-ce300",
      storageBucket: "pokerandom-ce300.firebasestorage.app",
      messagingSenderId: "637348459448",
      appId: "1:637348459448:web:4ab19e68bcce734692554d"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // ===== Helpers =====
    const $ = sel => document.querySelector(sel);
    const esc = s => String(s??"").replace(/[&<>"']/g, c => ({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#039;"}[c]));
    const toast = (t)=>{ console.log("[toast]", t); };

    // ===== Estado =====
    const cardsBase = [
      // coste, tipo, nombre, desc
      {cost:2,type:"Curacion",name:"Objeto curativo",desc:"Permite comprar un objeto curativo de una tienda."},
      {cost:7,type:"Curacion",name:"Dama curativa",desc:"Puedes comprar hasta 5 objetos curativos en la misma tienda."},
      {cost:4,type:"Gacha",name:"Ruleta",desc:"Puedes tirar una ruleta que otorga una carta aleatoria."},
      {cost:99,type:"ataque",name:"Robo de monedas",desc:"Robas 5 monedas a otro jugador en cualquier momento."},
      {cost:0,type:"economia",name:"Venta ilegal",desc:"Libera un Pok√©mon y recibe 2 monedas."},
      {cost:10,type:"economia",name:"10 monedas",desc:"Recibes 10 monedas al instante."},
      {cost:3,type:"economia",name:"Monedero perdido",desc:"Recibes de 1 a 5 monedas aleatorias."},
      {cost:2,type:"economia",name:"Apuesta",desc:"Recibes 3 monedas m√°s si no pierdes Pok√©mon contra el siguiente l√≠der."},
      {cost:10,type:"captura",name:"Captura shiny",desc:"Una captura extra en ruta y se vuelve shiny."},
      {cost:2,type:"captura",name:"Skip pokemon",desc:"Antes de capturar, puedes skipear el primer Pok√©mon que salga."},
      {cost:10,type:"captura",name:"Recaptura",desc:"Puedes recapturar."},
      {cost:4,type:"captura",name:"Reroll",desc:"Tras ver el primer Pok√©mon, puedes skipearlo e ir a por el siguiente."},
      {cost:4,type:"item",name:"Masterball",desc:"Obtienes una Masterball."},
      {cost:7,type:"item",name:"Compra MT",desc:"Permite comprar una MT en una tienda."},
      {cost:10,type:"item",name:"Capsula habilidad",desc:"Obtienes una c√°psula habilidad."},
      {cost:10,type:"item",name:"Piedra Evolutiva",desc:"Canjea por una piedra evolutiva a elecci√≥n."},
      {cost:10,type:"item",name:"MegaPiedra",desc:"Obtienes una mega piedra a elecci√≥n."},
      {cost:4,type:"Gacha",name:"Caja sorpresa",desc:"Cambia un √≠tem por otro random del mismo tipo."},
      {cost:10,type:"item",name:"Objeto fuerte",desc:"Obtienes un objeto competitivo a elecci√≥n."},
      {cost:10,type:"Curacion",name:"Revivir Pokemon",desc:"Revive un Pok√©mon."},
      {cost:10,type:"Curacion",name:"Revivir Inicial",desc:"Revive a tu inicial una vez."},
      {cost:7,type:"Curacion",name:"Cambio de inicial",desc:"Designa a otro Pok√©mon vivo como inicial."},
      {cost:10,type:"defensa",name:"Reversa",desc:"(Descartado sistema de defensa en app)."},
      {cost:7,type:"defensa",name:"Bloqueo",desc:"(Descartado sistema de defensa en app)."},
      {cost:10,type:"Curacion",name:"Bendici√≥n de Arceus",desc:"El primer Pok√©mon que muera en el combate no morir√° realmente."},
      {cost:7,type:"ataque",name:"Robo Curativo",desc:"Robas 3 objetos curativos a un rival."},
      {cost:4,type:"ataque",name:"Desgaste",desc:"El rival no puede sacar/meter pok√©mon antes del siguiente l√≠der."},
      {cost:7,type:"ataque",name:"Liberaci√≥n",desc:"Escoge dos pok√©mon del rival; √©l decide uno a liberar."},
      {cost:10,type:"ataque",name:"Robo de caja",desc:"Robas un Pok√©mon de la caja del rival."},
      {cost:13,type:"ataque",name:"Robo de equipo",desc:"Robas un Pok√©mon aleatorio del equipo rival."},
      {cost:7,type:"ataque",name:"bloqueo pokemon",desc:"Bloquea un Pok√©mon rival hasta el siguiente l√≠der."},
      {cost:7,type:"ataque",name:"destructor",desc:"El rival jugar√° con 5 Pok√©mon hasta el siguiente l√≠der."},
      {cost:5,type:"ataque",name:"Mismo destino",desc:"Libera uno y el rival libera otro que comparta tipo."},
      {cost:4,type:"ataque",name:"envenenamiento",desc:"El rival debe tirar 2 curas de su inventario."},
      {cost:10,type:"gacha",name:"Prime",desc:"Si no muere en combates, 31 IVs en todo; al reusar, shiny."},
      {cost:4,type:"defensa",name:"Venganza",desc:"(Descartado sistema de defensa en app)."},
      {cost:4,type:"gacha",name:"Apuesta Segura",desc:"Si ganas a todos, +15 monedas; si pierdes, pagas 5 a cada uno."},
      {cost:10,type:"ataque",name:"Cambio repentino",desc:"Cambia la habilidad de un Pok√©mon rival salvo que pague 15."},
      {cost:0,type:"item",name:"Intercambio",desc:"Intercambia un Pok√©mon con un rival si ambos quieren. (Cuesta 2 monedas en app)."},
      {cost:2,type:"defensa",name:"Regalo",desc:"(Se notifica s√≥lo)."},
      {cost:10,type:"defensa",name:"Maldici√≥n",desc:"(Se notifica s√≥lo, sin defensas autom√°ticas)."},
      {cost:7,type:"ataque",name:"Robo sigiloso",desc:"Robas una carta del rival (con notificaci√≥n)."},
      {cost:7,type:"defensa",name:"Buff permanente",desc:"Sube 8 IVs a un Pok√©mon."},
      {cost:2,type:"defensa",name:"Protecci√≥n del d√©bil",desc:"(Descartado sistema de defensa en app)."},
      {cost:4,type:"gacha",name:"Barajear cartas",desc:"Elige 3 unidades y recibe 2 nuevas ponderadas por rareza."}
    ].map((c,i)=>({
      ...c,
      id: (c.name||"")
        .normalize("NFD").replace(/[\u0300-\u036f]/g,"")
        .toLowerCase().replace(/[^a-z0-9]+/g,"-").replace(/(^-|-$)/g,"") || `c${String(i+1).padStart(2,"0")}`
    }));

    let currentUser = null;
    let state = { coins:0, karma:0, cards: cardsBase.map(x=>({...x, qty:0})), walletLog:[], useLog:[] };

    // ===== Firestore refs =====
    const invCol = collection(db, "inventories");
    const profileCol = collection(db, "profiles");
    const stealCol = collection(db, "stealRequests");
    const attackCol = collection(db, "attackRequests");

    let unsubInv=null, unsubSteal=null, unsubAttack=null;

    // ===== Auth UI =====
    const btnLoginGoogle = $("#btnLoginGoogle");
    const btnLogout = $("#btnLogout");
    btnLoginGoogle.onclick = async ()=>{
      try{ await signInWithPopup(auth, new GoogleAuthProvider()); }catch(e){ alert("Error login Google: "+e.message); }
    };
    btnLogout.onclick = ()=> signOut(auth);

    onAuthStateChanged(auth, async (user)=>{
      currentUser = user || null;
      $("#btnLoginGoogle").style.display = user?"none":"inline-flex";
      $("#btnLogout").style.display = user?"inline-flex":"none";
      if(!user){
        if(unsubInv){unsubInv();unsubInv=null}
        if(unsubSteal){unsubSteal();unsubSteal=null}
        if(unsubAttack){unsubAttack();unsubAttack=null}
        state = { coins:0, karma:0, cards: cardsBase.map(x=>({...x, qty:0})), walletLog:[], useLog:[] };
        render();
        return;
      }

      // crear perfil m√≠nimo
      await setDoc(doc(profileCol, user.uid), {
        displayName: user.displayName || user.email || user.uid,
        updatedAt: serverTimestamp()
      }, {merge:true});

      // suscribir inventario del usuario
      const invRef = doc(invCol, user.uid);
      unsubInv = onSnapshot(invRef, async (snap)=>{
        if(!snap.exists()){
          await setDoc(invRef, state);
          return;
        }
        const data = snap.data();
        // blindajes por si faltan campos
        state.coins = data.coins ?? 0;
        state.karma = data.karma ?? 0;
        state.walletLog = data.walletLog ?? [];
        state.useLog = data.useLog ?? [];
        // merge cards
        const byId = new Map(cardsBase.map(c=>[c.id,c]));
        const loaded = (data.cards||[]).map(c=>({ ...(byId.get(c.id)||{}), ...c }));
        // a√±adir las que falten
        cardsBase.forEach(b=>{ if(!loaded.find(x=>x.id===b.id)) loaded.push({...b, qty:0}); });
        state.cards = loaded;
        render();
      });

      // bandeja de robos y ataques
      subscribeStealInbox(user.uid);
      subscribeAttackInbox(user.uid);
    });

    // ===== Guardar (debounce) =====
    let saveTimer=null; function scheduleSave(){
      clearTimeout(saveTimer);
      saveTimer=setTimeout(async()=>{
        if(!currentUser) return;
        await setDoc(doc(invCol, currentUser.uid), state, {merge:true});
      },300);
    }

    // ===== Render =====
    function render(){
      $("#coins").textContent = Math.trunc(state.coins||0);
      $("#karma").textContent = Math.trunc(state.karma||0);
      renderInventory();
      renderWalletLog();
      renderUseLog();
    }

    function renderInventory(){
      const hideZero = $("#hideZero").checked;
      const type = $("#filterType").value || "";
      const grid = $("#inventory");
      grid.innerHTML="";
      let list = [...state.cards];
      if(type) list = list.filter(c=> (c.type||"").toLowerCase()===type.toLowerCase());
      list.forEach(c=>{
        if(hideZero && (c.qty||0)<=0) return;
        const el = document.createElement("div"); el.className="cardSlot"; if((c.qty||0)<=0) el.classList.add("dim");
        el.innerHTML = `
          <div class="imgWrap"><img alt="${esc(c.name)}" src="img/${c.id}.png" onerror="this.onerror=null;this.src='img/${c.id}.jpg'"/></div>
          <div class="title">${esc(c.name)}</div>
          <div class="meta"><span class="badge">${esc(c.type)}</span> ¬∑ <span class="badge">${c.cost} ü™ô</span></div>
          <div class="qty">√ó ${Math.trunc(c.qty||0)}</div>
        `;
        el.onclick = ()=> openCard(c.id);
        grid.appendChild(el);
      });
    }

    function renderWalletLog(){
      const ul = $("#walletLogList"); if(!ul) return; ul.innerHTML="";
      const log = (state.walletLog||[]).slice().reverse();
      for(const it of log){
        const li=document.createElement("li");
        if(it.delta>0) li.classList.add("win");
        if(it.delta<0) li.classList.add("lose");
        li.textContent = `${new Date(it.date).toLocaleString()} ‚Äî ${it.note} (${it.delta>0?"+":""}${it.delta})`;
        ul.appendChild(li);
      }
    }

    function renderUseLog(){
      const ul = $("#useLogList"); if(!ul) return; ul.innerHTML="";
      const log = (state.useLog||[]).slice().reverse();
      for(const it of log){
        const li=document.createElement("li");
        if(typeof it.delta === "number"){
          if(it.delta>0) li.classList.add("win");
          if(it.delta<0) li.classList.add("lose");
        }
        if(it.admin) li.classList.add("log-admin");
        li.textContent = `${new Date(it.date).toLocaleString()} ‚Äî ${it.name}`;
        ul.appendChild(li);
      }
    }

    // ===== Card modal (simple) =====
    let currentCardId=null;
    function openCard(id){
      currentCardId = id;
      const c = state.cards.find(x=>x.id===id); if(!c) return;
      const canUse = (c.qty||0)>0 && !!currentUser;
      const confirmUse = confirm(`¬øUsar "${c.name}"?` + (canUse?"":"\n(No tienes unidades)"));
      if(confirmUse) onUse();
    }

    // ===== Monedero =====
    const logCoins=(delta,note)=>{
      (state.walletLog ||= []).push({date:new Date().toISOString(), delta, note});
    };
    const setCoins = (n)=>{ state.coins = Math.max(0, Math.trunc(n||0)); };
    const addCoins = (n,note)=>{ state.coins = Math.max(0, Math.trunc((state.coins||0)+n)); logCoins(n,note); };

    $("#add1").onclick=()=>{ addCoins(1,"+1 manual"); scheduleSave(); render(); };
    $("#sub1").onclick=()=>{ addCoins(-1,"‚àí1 manual"); scheduleSave(); render(); };

    $("#btnLider").onclick=async()=>{
      const ok = confirm("¬øHas completado un l√≠der? Si no perdiste ning√∫n Pok√©mon, obtienes +3 extra.");
      if(!ok) return;
      const noLoss = confirm("¬øConfirmas que NO perdiste ning√∫n Pok√©mon?");
      const gain = noLoss? 9 : 6;
      addCoins(gain, `L√≠der completado (+${gain})`);
      scheduleSave(); render();
    };

    $("#btnImportante").onclick=async()=>{
      const ok = confirm("¬øCombate importante ganado? Si no perdiste Pok√©mon, +2 extra.");
      if(!ok) return;
      const noLoss = confirm("¬øConfirmas que NO perdiste ning√∫n Pok√©mon?");
      const gain = 5 + (noLoss?2:0);
      addCoins(gain, `Combate importante (+${gain})`);
      scheduleSave(); render();
    };

    // ===== USAR carta =====
    async function onUse(){
      if (!currentUser) return;
      const c = state.cards.find(x => x.id === currentCardId); if (!c) return;
      if ((c.qty || 0) <= 0) { alert("No tienes esta carta."); return; }

      const spend = ()=>{ c.qty = Math.max(0, (c.qty||0)-1); };

      // Econom√≠a autom√°ticas
      if (c.name.toLowerCase() === "10 monedas") {
        spend(); addCoins(10, "Carta 10 monedas");
        (state.useLog||=[]).push({date:new Date().toISOString(),name:"Usaste 10 monedas (+10) (‚àí1)"});
        scheduleSave(); render(); return;
      }
      if (c.name.toLowerCase() === "venta ilegal") {
        spend(); addCoins(2, "Venta ilegal");
        (state.useLog||=[]).push({date:new Date().toISOString(),name:"Usaste Venta ilegal (+2) (‚àí1)"});
        scheduleSave(); render(); return;
      }
      if (c.name.toLowerCase() === "monedero perdido") {
        spend(); const n = 1 + Math.floor(Math.random()*5); addCoins(n, "Monedero perdido");
        (state.useLog||=[]).push({date:new Date().toISOString(),name:`Usaste Monedero perdido (+${n}) (‚àí1)`});
        scheduleSave(); render(); return;
      }
      if (c.name.toLowerCase() === "robo de monedas") {
        spend(); addCoins(5, "Robo de monedas");
        (state.useLog||=[]).push({date:new Date().toISOString(),name:"Usaste Robo de monedas (+5) (‚àí1)"});
        scheduleSave(); render(); return;
      }

      // Robo sigiloso ‚Üí se gasta al confirmar robo
      if (c.name.toLowerCase() === "robo sigiloso") { openSteal(); return; }
      // Barajear cartas ‚Üí se gasta al confirmar barajeo
      if (c.name.toLowerCase() === "barajear cartas") { openShuffle(); return; }

      // Ataques gen√©ricos (notificaci√≥n y gasta carta)
      if ((c.type||"").toLowerCase()==="ataque"){
        const target = await pickUser(`¬øA qui√©n quieres atacar con ‚Äú${c.name}‚Äù?`);
        if(!target) return;
        state.karma = (state.karma||0) + 1;
        await addDoc(attackCol, {
          attackerId: currentUser.uid,
          attackerName: currentUser.displayName || currentUser.email || currentUser.uid,
          victimId: target.uid,
          cardName: c.name,
          status: "pending",
          createdAt: serverTimestamp()
        });
        spend();
        (state.useLog||=[]).push({date:new Date().toISOString(),name:`Ataque enviado: ${c.name} ‚Üí ${target.name} (‚àí1)`});
        scheduleSave(); render(); return;
      }

      // Resto: efecto in-game, se gasta igualmente
      spend();
      (state.useLog||=[]).push({date:new Date().toISOString(),name:`Usaste ${c.name} (efecto en partida) (‚àí1)`});
      scheduleSave(); render();
      alert("Esta carta se aplica en la partida (fuera de la app). Ya se ha descontado del inventario.");
      return;
    }

    // ===== Ruleta =====
    const slotText=$("#slotText");
    $("#spinPaid").onclick=async()=>{
      const ru = state.cards.find(c=>c.name.toLowerCase()==="ruleta");
      if(!ru || (ru.qty||0)<=0){ alert("No tienes tiradas de Ruleta."); return; }
      if(!confirm("¬øGastar 1 Ruleta? Esto es aleatorio üòÖ")) return;
      ru.qty-=1; const res=await doSpin(); showReward(res); (state.useLog||=[]).push({date:new Date().toISOString(),name:`Ganaste por ruleta: ${res.name} (+1)`}); scheduleSave(); render();
    };
    $("#spinFree").onclick=()=>{
      if(!confirm("¬øHas vencido a un l√≠der de gimnasio? Te doy 1 Ruleta gratis.")) return;
      const ru = state.cards.find(c=>c.name.toLowerCase()==="ruleta"); if(!ru) return; ru.qty=(ru.qty||0)+1; scheduleSave(); render();
    };
    async function doSpin(){
      const fixed = ["10 monedas","Monedero perdido"]; // fijas
      const pool = state.cards.filter(c=>[13,10,7,4,2].includes(c.cost));
      const pick = pool[Math.floor(Math.random()*pool.length)];
      const got = state.cards.find(c=>c.id===pick.id); got.qty=(got.qty||0)+1; slotText.textContent=pick.name; return pick;
    }
    function showReward(card){
      $("#rewardName").textContent = card.name;
      $("#rewardMeta").textContent = `${card.type} ¬∑ ${card.cost} ü™ô`;
      const img=$("#rewardImg"); img.onerror=null; img.src=`img/${card.id}.png`; img.onerror=()=>{img.src=`img/${card.id}.jpg`};
      toggleModal($("#rewardModal"), true);
    }
    $("#rewardClose").onclick=()=>toggleModal($("#rewardModal"),false);
    $("#rewardCloseX").onclick=()=>toggleModal($("#rewardModal"),false);

    // ===== Barajear =====
    const shuffleModal=$("#shuffleModal"), shufflePickGrid=$("#shufflePickGrid"), shuffleConfirm=$("#shuffleConfirm"), shuffleCount=$("#shuffleCount");
    let shufflePick={};
    function openShuffle(){
      shufflePick={}; shuffleCount.textContent="0"; shufflePickGrid.innerHTML="";
      state.cards.filter(c=>(c.qty||0)>0).forEach(c=>{
        const slot=document.createElement("div"); slot.className="cardSlot"; slot.dataset.id=c.id;
        slot.innerHTML = `
          <div class="imgWrap"><img alt="${esc(c.name)}" src="img/${c.id}.png" onerror="this.onerror=null;this.src='img/${c.id}.jpg'"/></div>
          <div class="title">${esc(c.name)}</div>
          <div class="meta"><span class="badge">${esc(c.type)}</span> ¬∑ <span class="badge">${c.cost} ü™ô</span></div>
          <div class="qty">√ó ${Math.trunc(c.qty||0)}</div>
        `;
        const ctr=document.createElement("div"); ctr.style.display="flex"; ctr.style.gap="6px"; ctr.style.marginTop="6px";
        const less=document.createElement("button"); less.className="btn alt"; less.textContent="‚àí";
        const num=document.createElement("span"); num.className="badge"; num.textContent="0";
        const more=document.createElement("button"); more.className="btn alt"; more.textContent="+";
        let picked=0;
        function total(){ return Object.values(shufflePick).reduce((a,b)=>a+b,0); }
        more.onclick=()=>{ if((picked+total())>=3) return; if(picked>=c.qty) return; picked++; shufflePick[c.id]=picked; num.textContent=String(picked); update(); };
        less.onclick=()=>{ if(picked<=0) return; picked--; if(picked<=0) delete shufflePick[c.id]; else shufflePick[c.id]=picked; num.textContent=String(picked); update(); };
        function update(){ shuffleCount.textContent=String(Object.values(shufflePick).reduce((a,b)=>a+b,0)); shuffleConfirm.disabled = (Object.values(shufflePick).reduce((a,b)=>a+b,0)!==3); }
        ctr.appendChild(less); ctr.appendChild(num); ctr.appendChild(more); slot.appendChild(ctr);
        shufflePickGrid.appendChild(slot);
      });
      toggleModal(shuffleModal,true);
    }
    $("#shuffleCancel").onclick=()=>toggleModal(shuffleModal,false);
    $("#shuffleCloseX").onclick=()=>toggleModal(shuffleModal,false);
    $("#shuffleConfirm").onclick=()=>{
      if(Object.values(shufflePick).reduce((a,b)=>a+b,0)!==3) return;
      // restar seleccionadas
      Object.entries(shufflePick).forEach(([id,n])=>{
        const c=state.cards.find(x=>x.id===id); c.qty=Math.max(0,(c.qty||0)-n);
      });
      // gastar la propia carta "Barajear cartas"
      const sh = state.cards.find(x=>x.name.toLowerCase()==="barajear cartas"); if(sh && (sh.qty||0)>0) sh.qty-=1;
      // dar 2 nuevas (ponderaci√≥n simple por coste)
      function pick(){ const pool=[]; state.cards.forEach(c=>{ const w = c.cost>=10?5: c.cost>=7?3: c.cost>=4?2:1; for(let i=0;i<w;i++) pool.push(c); }); return pool[Math.floor(Math.random()*pool.length)]; }
      const r1=pick(), r2=pick(); r1.qty=(r1.qty||0)+1; r2.qty=(r2.qty||0)+1;
      (state.useLog||=[]).push({date:new Date().toISOString(),name:`Barajear: ${r1.name} y ${r2.name} (+1,+1)`});
      scheduleSave(); render(); toggleModal(shuffleModal,false);
      alert(`Nuevas cartas: ${r1.name} y ${r2.name}`);
    };

    // ===== Notificaciones (ROBO) =====
    const inboxModal=$("#inboxModal"), inboxText=$("#inboxText"), inboxPreview=$("#inboxPreview");
    const inboxApply=$("#inboxApply"), inboxCloseX=$("#inboxCloseX");
    let currentInboxId=null, currentInboxData=null;

    inboxCloseX.onclick = async ()=>{
      if(currentInboxId){ await updateDoc(doc(stealCol, currentInboxId), { seenByVictim:true, seenAt:serverTimestamp() }); }
      toggleModal(inboxModal,false); currentInboxId=null; currentInboxData=null;
    };

    function subscribeStealInbox(uid){
      if(unsubSteal){unsubSteal();unsubSteal=null}
      const qv = query(stealCol, where("victimId","==",uid), where("status","==","pending"));
      unsubSteal = onSnapshot(qv,(snap)=>{
        const docs=snap.docs; if(!docs.length) return; const first=docs.find(d=>!d.data().seenByVictim)||docs[0];
        showStealInbox(first.id, first.data());
      });
    }

    async function showStealInbox(docId, data){
      currentInboxId=docId; currentInboxData=data;
      const attacker = data.attackerName || data.attackerId || "Alguien";
      inboxText.innerHTML = `<strong>${esc(attacker)}</strong> te ha robado <strong>${esc(data.cardName||"una carta")}</strong>.`;
      try{ await updateDoc(doc(stealCol, currentInboxId), { seenByVictim:true, seenAt:serverTimestamp() }); }catch{}
      // preview
      inboxPreview.innerHTML="";
      const cardDef = state.cards.find(c=>c.id===data.cardId) || {id:data.cardId,name:data.cardName||"Carta",type:"",cost:"?"};
      const slot=document.createElement("div"); slot.className="cardSlot"; slot.style.width="260px";
      slot.innerHTML=`<div class="imgWrap"><img alt="${esc(cardDef.name)}" src="img/${cardDef.id}.png" onerror="this.onerror=null;this.src='img/${cardDef.id}.jpg'"/></div><div class="title">${esc(cardDef.name)}</div><div class="meta"><span class="badge">${esc(cardDef.type||"")}</span> ¬∑ <span class="badge">${cardDef.cost} ü™ô</span></div>`;
      inboxPreview.appendChild(slot);

      inboxApply.onclick = async ()=>{
        if(!currentInboxId || !currentInboxData){ toggleModal(inboxModal,false); return; }
        toggleModal(inboxModal,false);
        const _docId=currentInboxId, _data=currentInboxData; currentInboxId=null; currentInboxData=null;
        try{
          const cid=_data.cardId; const local=state.cards.find(x=>x.id===cid);
          if(local && (local.qty||0)>0){ local.qty=Math.max(0,(local.qty||0)-1); (state.useLog||=[]).push({date:new Date().toISOString(),cardId:cid,name:`Te robaron ${_data.cardName} (‚àí1)`,note:`Por ${_data.attackerName||_data.attackerId}`}); }
          await updateDoc(doc(stealCol,_docId), { status:"applied", appliedAt:serverTimestamp(), seenByVictim:true });
          scheduleSave(); render();
        }catch(e){ console.error(e); }
      };

      toggleModal(inboxModal,true);
    }

    // ===== Notificaciones (ATAQUE) =====
    const attackModal=$("#attackModal"), attackText=$("#attackText"), attackPreview=$("#attackPreview"), defenseButtons=$("#defenseButtons"), attackCloseX=$("#attackCloseX");
    let currentAttackId=null, currentAttackData=null;

    attackCloseX.onclick=()=>{ toggleModal(attackModal,false); currentAttackId=null; currentAttackData=null; };

    function subscribeAttackInbox(uid){
      if(unsubAttack){unsubAttack();unsubAttack=null}
      const qv = query(attackCol, where("victimId","==",uid), where("status","==","pending"));
      unsubAttack = onSnapshot(qv,(snap)=>{
        const docs=snap.docs; if(!docs.length) return; showAttackInbox(docs[0].id, docs[0].data());
      });
    }

    async function showAttackInbox(docId, data){
      currentAttackId=docId; currentAttackData=data;
      const attacker = data.attackerName || data.attackerId || "Alguien";
      attackText.innerHTML = `<strong>${esc(attacker)}</strong> te ha atacado con <strong>${esc(data.cardName)}</strong>.`;
      attackPreview.innerHTML=""; const guess = state.cards.find(c=>c.name.toLowerCase()===data.cardName.toLowerCase());
      const slot=document.createElement("div"); slot.className="cardSlot"; slot.style.width="260px";
      const id=guess?guess.id:"c01";
      slot.innerHTML=`<div class=\"imgWrap\"><img alt=\"${esc(data.cardName)}\" src=\"img/${id}.png\" onerror=\"this.onerror=null;this.src='img/${id}.jpg'\"/></div><div class=\"title\">${esc(data.cardName)}</div>`;
      attackPreview.appendChild(slot);
      defenseButtons.innerHTML="";
      const okBtn=document.createElement("button"); okBtn.className="btn bad"; okBtn.textContent="OK (recibir ataque)";
      okBtn.onclick = async ()=>{
        toggleModal(attackModal,false); const _docId=currentAttackId; currentAttackId=null; currentAttackData=null;
        try{ state.karma=(state.karma||0)-1; await updateDoc(doc(attackCol,_docId), {status:"applied", resolvedAt:serverTimestamp()}); toast("Ataque aplicado: karma ‚àí1"); scheduleSave(); render(); }catch(e){ console.error(e); }
      };
      defenseButtons.appendChild(okBtn);
      toggleModal(attackModal,true);
    }

    // ===== Robo sigiloso (UI m√≠nima) =====
    async function pickUser(promptText){
      // Carga perfiles para seleccionar
      const users=[]; // snapshot manual
      // Simple: pedir UID o nombre via prompt (puedes cambiar a desplegable real si ya tienes lista en memoria)
      const target = window.prompt(promptText+"\n(Escribe UID del rival)");
      if(!target) return null;
      return { uid: target, name: target };
    }

    let stealSelectedCardId=null, stealSelectedCardName=null, stealTarget=null;
    function openSteal(){
      // Elegir rival
      pickUser("¬øA qui√©n quieres robar?").then(target=>{
        if(!target) return; stealTarget=target;
        // Elegir carta del rival (flujo simple: pedimos nombre exacto)
        const name = window.prompt("Nombre de la carta a robar (exacto):"); if(!name) return;
        const myCard = state.cards.find(c=>c.name.toLowerCase()===name.toLowerCase());
        if(!myCard){ alert("Esa carta no existe en tu set."); return; }
        stealSelectedCardId = myCard.id; stealSelectedCardName=myCard.name;
        // Al ladr√≥n se le suma ya
        myCard.qty=(myCard.qty||0)+1; (state.useLog||=[]).push({date:new Date().toISOString(),name:`Robo sigiloso: a√±adida ${myCard.name} (+1)`});
        // Gastar la carta de Robo sigiloso + karma +1
        const stealCard = state.cards.find(x=>x.name.toLowerCase()==="robo sigiloso"); if(stealCard && (stealCard.qty||0)>0) stealCard.qty-=1;
        state.karma=(state.karma||0)+1;
        scheduleSave(); render();
        // Crear notificaci√≥n a la v√≠ctima
        addDoc(stealCol, { attackerId: currentUser.uid, attackerName: currentUser.displayName||currentUser.email||currentUser.uid, victimId: stealTarget.uid, cardId: stealSelectedCardId, cardName: stealSelectedCardName, status:"pending", seenByVictim:false, createdAt:serverTimestamp() });
        alert("Robo enviado. El rival confirmar√° la resta.");
      });
    }

    // ===== Admin cartas =====
    const adminFab=$("#adminFab"), adminModal=$("#adminModal"), adminCloseX=$("#adminCloseX");
    const adminCardSelect=$("#adminCardSelect"), adminQty=$("#adminQty"), adminAddBtn=$("#adminAddBtn"), adminRemoveBtn=$("#adminRemoveBtn");

    adminFab.onclick=()=>{
      if(!currentUser){ alert("Necesitas estar autenticado."); return; }
      fillAdminSelect(); adminQty.value="1"; toggleModal(adminModal,true);
    };
    adminCloseX.onclick=()=>toggleModal(adminModal,false);

    function fillAdminSelect(){
      const cards=[...state.cards]; cards.sort((a,b)=> (a.type||"").localeCompare(b.type||"") || (a.name||"").localeCompare(b.name||""));
      adminCardSelect.innerHTML=""; for(const c of cards){ const opt=document.createElement("option"); opt.value=c.id; opt.textContent=`${c.name} ‚Äî ${c.type} ¬∑ ${c.cost}ü™ô`; adminCardSelect.appendChild(opt); }
    }
    function logAdmin(delta, card){ (state.useLog||=[]).push({date:new Date().toISOString(), name:`[ADMIN] ${delta>0?"+":""}${delta} ${card.name}`, admin:true, delta}); }

    adminAddBtn.onclick=()=>{
      if(!currentUser){ alert("No puedes usar admin ahora."); return; }
      const id=adminCardSelect.value; const n=Math.max(1,Math.trunc(Number(adminQty.value)||1));
      const card=state.cards.find(c=>c.id===id); if(!card){ alert("Carta no encontrada"); return; }
      card.qty=(card.qty||0)+n; logAdmin(+n, card); toast(`[ADMIN] +${n} ${card.name}`); scheduleSave(); render();
    };
    adminRemoveBtn.onclick=()=>{
      if(!currentUser){ alert("No puedes usar admin ahora."); return; }
      const id=adminCardSelect.value; const n=Math.max(1,Math.trunc(Number(adminQty.value)||1));
      const card=state.cards.find(c=>c.id===id); if(!card){ alert("Carta no encontrada"); return; }
      const before=(card.qty||0); const real=Math.min(before,n); card.qty=Math.max(0,before-real); logAdmin(-real, card); toast(`[ADMIN] ‚àí${real} ${card.name}`); scheduleSave(); render();
    };

    // ===== Util =====
    function toggleModal(el,show){ if(!el) return; el.setAttribute("aria-hidden", show?"false":"true"); }

    // Filtros
    $("#hideZero").onchange=render; $("#filterType").onchange=render;

    // Primer render
    render();
  </script>
</body>
</html>
