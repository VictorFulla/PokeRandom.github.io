// functions/index.js
const functions = require("firebase-functions");
const admin = require("firebase-admin");
admin.initializeApp();
const db = admin.firestore();

exports.stealCard = functions.https.onCall(async (data, context) => {
  const attackerUid = context.auth?.uid;
  if (!attackerUid) throw new functions.https.HttpsError("unauthenticated", "Debes estar autenticado.");
  const victimUid = String(data?.victimUid||"");
  const cardId = String(data?.cardId||"");
  if (!victimUid || !cardId) throw new functions.https.HttpsError("invalid-argument","Faltan parámetros.");

  const attackerRef = db.collection("inventories").doc(attackerUid);
  const victimRef = db.collection("inventories").doc(victimUid);
  const victimProfileRef = db.collection("profiles").doc(victimUid);

  return await db.runTransaction(async (tx)=>{
    const [attSnap, vicSnap, profSnap] = await Promise.all([tx.get(attackerRef), tx.get(victimRef), tx.get(victimProfileRef)]);
    if(!attSnap.exists) throw new functions.https.HttpsError("failed-precondition","Inventario atacante inexistente.");
    if(!vicSnap.exists) throw new functions.https.HttpsError("failed-precondition","Inventario víctima inexistente.");
    const attacker = attSnap.data();
    const victim = vicSnap.data();

    // Buscar carta en víctima
    const vIdx = (victim.cards||[]).findIndex(c=>c.id===cardId);
    if(vIdx<0) throw new functions.https.HttpsError("failed-precondition","La víctima no posee esa carta.");
    const vCard = victim.cards[vIdx];
    if((vCard.qty||0)<=0) throw new functions.https.HttpsError("failed-precondition","La víctima no tiene unidades disponibles.");

    // Restar 1 a víctima
    vCard.qty = (vCard.qty||0)-1;

    // Sumar 1 al atacante (crear entrada si no existe)
    const aCards = attacker.cards||[];
    let aCard = aCards.find(c=>c.id===cardId);
    if(!aCard){
      // Copiamos metadatos desde víctima para mantener consistencia
      aCard = {id:vCard.id, name:vCard.name, type:vCard.type, cost:vCard.cost, desc:vCard.desc, qty:0};
      aCards.push(aCard);
    }
    aCard.qty = (aCard.qty||0)+1;

    // Karma +1 atacante
    attacker.karma = (attacker.karma||0)+1;

    // Logs
    (attacker.useLog ||= []).push({date:new Date().toISOString(), cardId, name:`Robaste ${vCard.name} (+1)`, note:`A ${profSnap.data()?.displayName||victimUid}`});
    (victim.useLog ||= []).push({date:new Date().toISOString(), cardId, name:`Te robaron ${vCard.name} (−1)`, note:`Por ${context.auth.token.email || attackerUid}`});

    tx.update(attackerRef, {cards:aCards, karma: attacker.karma, useLog: attacker.useLog, updatedAt: admin.firestore.FieldValue.serverTimestamp()});
    tx.update(victimRef, {cards:victim.cards, useLog: victim.useLog, updatedAt: admin.firestore.FieldValue.serverTimestamp()});
    return {victimName: profSnap.data()?.displayName || null};
  });
});
