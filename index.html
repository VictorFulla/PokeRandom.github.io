<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Random Lock Wubalonga â€” v4.8</title>
<style>
:root{--bg:#0d0f14;--panel:#151922;--edge:rgba(255,255,255,.08);--text:#e7ecf5;--muted:#9aa4b2;--accent:#7c5cff;--good:#22c55e;--bad:#ef4444;--warn:#f59e0b;--br:16px}
*{box-sizing:border-box}html,body{height:100%}
body{margin:0;background:linear-gradient(180deg,#0b0e13,#0d1016);color:var(--text);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu}
.wrap{max-width:1240px;margin:0 auto;padding:16px}
header{position:sticky;top:0;z-index:50;backdrop-filter:saturate(1.2) blur(10px);background:rgba(13,16,22,.75);border-bottom:1px solid var(--edge)}
header .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
h1.logo{margin:0;font-size:22px;letter-spacing:.3px;display:flex;align-items:center;gap:10px;background:linear-gradient(90deg,#a78bfa,#60a5fa);-webkit-background-clip:text;background-clip:text;color:transparent;text-shadow:0 0 18px rgba(124,92,255,.25)}
.logo .sub{font-size:12px;color:var(--muted);letter-spacing:.5px}
.btn{background:var(--accent);border:none;color:#fff;border-radius:12px;padding:10px 14px;cursor:pointer;transition:.15s}
.btn:hover{transform:translateY(-1px)}.btn.alt{background:#0e121a;border:1px solid var(--edge)}.btn.good{background:var(--good);color:#07240f}.btn.bad{background:var(--bad)}.btn.warn{background:var(--warn);color:#2d1500}
.kpi{font-weight:900;font-size:26px}.mono{font-family:ui-monospace,Menlo,Consolas,monospace}
.grid{display:grid;gap:16px;grid-template-columns:2fr 1fr}@media(max-width:1040px){.grid{grid-template-columns:1fr}}
.card{background:var(--panel);border:1px solid var(--edge);border-radius:var(--br);padding:16px;box-shadow:0 10px 30px rgba(0,0,0,.3)}
.section-title{margin:0 0 12px 0;font-size:18px;display:flex;align-items:center;gap:8px}
.small{font-size:12px;color:var(--muted)}.hr{height:1px;background:var(--edge);margin:12px 0}
input,select{background:#0e121a;color:var(--text);border:1px solid var(--edge);border-radius:12px;padding:10px}
select{min-width:180px}.right{margin-left:auto}.flex{display:flex;gap:10px;align-items:center;flex-wrap:wrap}.spacer{flex:1}
.badge{display:inline-flex;gap:6px;align-items:center;padding:2px 8px;border-radius:999px;background:#0e121a;border:1px solid var(--edge);font-size:12px}
.cards{display:grid;gap:12px;grid-template-columns:repeat(5,minmax(150px,1fr))}
@media(max-width:1200px){.cards{grid-template-columns:repeat(4,minmax(140px,1fr))}}
@media(max-width:900px){.cards{grid-template-columns:repeat(3,minmax(130px,1fr))}}
@media(max-width:640px){.cards{grid-template-columns:repeat(2,minmax(120px,1fr))}}
.cardSlot{position:relative;background:#0e121a;border:1px solid var(--edge);border-radius:14px;padding:10px;display:flex;flex-direction:column;gap:8px;transition:.15s;cursor:pointer;min-height:200px}
.cardSlot:hover{transform:translateY(-2px);box-shadow:0 10px 30px rgba(0,0,0,.25)}
.cardSlot .imgWrap{background:linear-gradient(180deg,#0b0e13,#10141c);border:1px solid var(--edge);border-radius:10px;aspect-ratio:1/1;display:flex;align-items:center;justify-content:center;overflow:hidden}
.cardSlot img{max-width:100%;max-height:100%}.cardSlot .title{font-weight:800;font-size:14px}
.qty{position:absolute;top:8px;right:8px;background:rgba(34,197,94,.15);color:#86efac;border:1px solid rgba(34,197,94,.35);padding:2px 8px;border-radius:999px;font-size:12px;font-weight:800}
.zero{filter:grayscale(1) contrast(.8) opacity(.6)}
.toast{position:fixed;left:50%;bottom:24px;transform:translateX(-50%);background:#0e121a;border:1px solid var(--edge);border-radius:12px;padding:10px 14px;z-index:120;opacity:0;transition:.3s;pointer-events:none}
.toast.show{opacity:1;transform:translateX(-50%) translateY(-6px)}
.gain{color:#86efac}.loss{color:#fecaca}
.readonly{opacity:.82;filter:saturate(.9)}
.tools{position:relative}
.toolsBtn{background:#0e121a;border:1px solid var(--edge);border-radius:12px;padding:10px 14px;cursor:pointer;display:flex;gap:10px;align-items:center;font-size:15px;color:#fff}
.toolsBtn .coinDot{display:inline-flex;align-items:center;gap:8px;padding:4px 10px;border-radius:999px;background:rgba(255,255,255,.08);border:1px solid var(--edge);color:#fff;font-weight:800}
.toolsPanel{position:absolute;right:0;top:44px;min-width:260px;background:#0e121a;border:1px solid var(--edge);border-radius:12px;padding:10px;display:none;z-index:200}
.toolsPanel.show{display:block}.toolsRow{display:flex;justify-content:space-between;align-items:center;gap:10px;margin-bottom:8px}
.slot{height:56px;display:flex;align-items:center;justify-content:center;border:1px dashed var(--edge);border-radius:10px;overflow:hidden}
.slotText{font-weight:800}
.modal{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;padding:20px;z-index:100}
.modal.show{display:flex}
.modal .panel{background:var(--panel);border:1px solid var(--edge);border-radius:18px;max-width:820px;width:100%;padding:16px;display:grid;gap:14px;grid-template-columns:1fr 1fr;max-height:90vh;overflow:auto}
@media(max-width:760px){.modal .panel{grid-template-columns:1fr}}
.modal .bigImg{aspect-ratio:1/1;border:1px solid var(--edge);border-radius:12px;background:#0e121a;display:flex;align-items:center;justify-content:center;overflow:hidden}
.modal h3{margin:0}.modal .closeX{position:absolute;top:8px;right:12px;background:#00000066;border:1px solid var(--edge);color:#fff;border-radius:10px;padding:6px 10px;cursor:pointer}
/* picked highlight */
.picked{outline:2px solid #60a5fa; box-shadow:0 0 0 3px #60a5fa22 inset}
/* spy tint */
.spyTint body, .spyTint main{filter:hue-rotate(-25deg) saturate(1.1)}
</style>
</head>
<body>
<header>
  <div class="wrap row">
    <h1 class="logo">Random Lock Wubalonga <span class="sub">â€¢ v4.8</span></h1>

    <div class="badge" id="whoAmI">Sin sesiÃ³n</div>
    <button id="btnGoogle" class="btn good">Entrar con Google</button>
    <button id="btnEmail" class="btn alt">Email/ContraseÃ±a</button>
    <button id="btnLogout" class="btn warn" style="display:none">Salir</button>

    <div class="spacer"></div>

    <!-- Espiar -->
    <div class="tools" id="spyTools" style="display:none">
      <button id="btnSpy" class="btn alt">ğŸ‘ï¸ Espiar</button>
      <div id="spyMenu" class="toolsPanel"></div>
      <div id="spyInfo" style="display:none" class="badge">Espiando a: <strong id="spyName"></strong> <button id="spyExit" class="btn alt" style="margin-left:8px">Volver</button></div>
    </div>

    <!-- Herramientas -->
    <div class="tools" id="toolsBox" style="display:none">
      <button id="toolsBtn" class="toolsBtn" title="Herramientas">
        <span class="coinDot">ğŸª™ <span id="coinsMini">0</span></span> â‹¯
      </button>
      <div id="toolsPanel" class="toolsPanel">
        <div class="toolsRow">
          <div><span class="small">Monedas:</span> <span class="kpi mono" id="coins">0</span></div>
          <button id="coinMenuBtn" class="btn alt" style="padding:6px 10px">Â±</button>
        </div>
        <div class="toolsRow">
          <div><span class="small">Karma ğŸ˜ˆ:</span> <span class="kpi mono" id="karma">0</span></div>
          <button id="karmaBtn" class="btn alt" style="padding:6px 10px">He recibido un ataque</button>
        </div>
        <div class="hr"></div>
        <div class="toolsRow">
          <button id="exportBtn" class="btn alt" style="padding:6px 10px">Exportar</button>
          <label class="btn alt" style="padding:6px 10px">Importar <input id="importFile" type="file" accept="application/json" style="display:none"></label>
          <button id="resetBtn" class="btn warn" style="padding:6px 10px">Reiniciar</button>
        </div>
      </div>
    </div>
  </div>
</header>

<main class="wrap" style="padding-top:18px">
  <!-- Debufos visibles -->
  <div id="debuffBar" class="flex small" style="margin-bottom:8px;gap:8px;display:none"></div>

  <div class="grid">
    <section class="card" id="mainSection">
      <div class="section-title">
        ğŸƒ Inventario de cartas
        <span class="small">(clic para ver y comprar/usar)</span>
        <div class="spacer"></div>
        <label class="small" style="display:flex;gap:8px;align-items:center">
          <select id="typeFilter">
            <option value="">Todas las categorÃ­as</option>
            <option value="curaciÃ³n">CuraciÃ³n</option><option value="ataque">Ataque</option>
            <option value="defensa">Defensa</option><option value="economÃ­a">EconomÃ­a</option>
            <option value="gacha">Gacha</option><option value="Ã­tem">Ãtem</option><option value="captura">Captura</option>
          </select>
          <label style="display:flex;gap:6px;align-items:center">
            <input type="checkbox" id="hideZero"/> Ocultar sin tener
          </label>
        </label>
      </div>
      <div id="cardsGrid" class="cards"></div>
    </section>

    <aside class="card">
      <div class="section-title">ğŸ° Ruleta</div>
      <div class="small">Incluye <strong>10 monedas</strong> + <strong>Monedero perdido</strong> + 1 legendaria (10/13) + 1 Ã©pica (7) + 3 de 4 + 4 de 2.</div>
      <div class="hr"></div>
      <div class="slot"><div id="slotText" class="slotText">â€”</div></div>
      <div class="flex" style="margin-top:10px">
        <button id="spinPaid" class="btn">Tirar (gasta 1 â€œRuletaâ€)</button>
        <button id="spinFree" class="btn good">Tirada gratis (post-gym)</button>
        <div class="spacer"></div>
        <span class="badge">Tienes â€œRuletaâ€: <span id="ruletaQty">0</span></span>
      </div>

      <div class="hr"></div>
      <div class="section-title">ğŸ“’ Registros</div>
      <details>
        <summary class="flex"><span class="chev">â–¶</span> Historial de monedas</summary>
        <div class="details" style="border:1px dashed var(--edge);border-radius:12px;padding:10px;margin-top:8px">
          <div id="walletLog" class="small"></div>
        </div>
      </details>
      <div class="hr"></div>
      <details>
        <summary class="flex"><span class="chev">â–¶</span> Historial de cartas</summary>
        <div class="details" style="border:1px dashed var(--edge);border-radius:12px;padding:10px;margin-top:8px">
          <div id="useLog" class="small"></div>
        </div>
      </details>
    </aside>
  </div>
  <div class="footer small">Firestore por usuario. Robos/ataques con defensas. Exporta tu perfil para backup.</div>
</main>

<div id="toast" class="toast"></div>

<!-- Modal Monedas -->
<div id="coinModal" class="modal" aria-hidden="true">
  <div class="panel" role="dialog" aria-label="Ajustar monedas">
    <button class="closeX" id="coinCloseX">Cerrar</button>
    <div style="grid-column:1/-1"><h3>ğŸ’° Ajustar monedas</h3><div class="small">Enteros. No negativos.</div></div>
    <div>
      <label class="small">Cantidad</label>
      <input id="coinAmount" type="number" step="1" min="0" placeholder="0"/>
      <label class="small" style="margin-top:8px;display:block">Motivo (opcional)</label>
      <input id="coinReason" type="text" placeholder="p. ej. Recompensa del juego X"/>
    </div>
    <div>
      <label class="small">AcciÃ³n</label>
      <div class="flex" style="margin-top:8px">
        <button id="coinAdd" class="btn good">+ Ingreso</button>
        <button id="coinSub" class="btn bad">âˆ’ Gasto</button>
        <button id="coinClose" class="btn alt right">Cerrar</button>
      </div>
    </div>
    <div style="grid-column:1/-1" class="hr"></div>
    <div>
      <div class="small" style="margin-bottom:6px">Atajos de partida</div>
      <div class="flex">
        <button id="btnLeader" class="btn">ğŸ† LÃ­der completado</button>
        <button id="btnBoss" class="btn alt">âš”ï¸ Combate importante</button>
      </div>
      <div class="small" style="margin-top:6px">LÃ­der: +6 (o +9 sin bajas). Importante: +5 (o +7 sin bajas).</div>
    </div>
  </div>
</div>

<!-- Modal Carta -->
<div id="cardModal" class="modal" aria-hidden="true">
  <div class="panel" role="dialog" aria-label="Detalle de carta">
    <button class="closeX" id="cardCloseX">Cerrar</button>
    <div class="bigImg"><img id="cardImgBig" alt="Carta" style="max-width:100%;max-height:100%"></div>
    <div>
      <h3 id="cardTitle">Carta</h3>
      <div class="small" id="cardTypeCost"></div>
      <div id="cardDesc" class="small" style="margin-top:8px"></div>
      <div class="hr"></div>
      <div class="flex">
        <span class="badge">Precio: <span id="cardPrice">0</span> ğŸª™</span>
        <span class="badge">Tienes: <span id="cardQty">0</span></span>
      </div>
      <div class="hr"></div>
      <div class="flex">
        <button id="buyBtn" class="btn">Comprar</button>
        <button id="useBtn" class="btn alt">Usar</button>
        <button id="closeCard" class="btn right alt">Cerrar</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal Recompensa ruleta -->
<div id="rewardModal" class="modal" aria-hidden="true">
  <div class="panel" role="dialog" aria-label="Recompensa de ruleta">
    <button class="closeX" id="rewardCloseX">Cerrar</button>
    <div class="bigImg"><img id="rewardImg" alt="Carta ganada" style="max-width:100%;max-height:100%"></div>
    <div>
      <h3 class="rewardTitle">ğŸ‰ Â¡Has obtenido <span id="rewardName"></span>!</h3>
      <div class="small" id="rewardMeta"></div>
      <div style="margin-top:8px" id="rewardDesc" class="small"></div>
      <div class="hr"></div>
      <button id="rewardClose" class="btn alt right">Cerrar</button>
    </div>
  </div>
</div>

<!-- Modal NotificaciÃ³n de ROBO (vÃ­ctima) -->
<div id="inboxModal" class="modal" aria-hidden="true">
  <div class="panel" role="dialog" aria-label="NotificaciÃ³n de robo" style="grid-template-columns:1fr">
    <button class="closeX" id="inboxCloseX">Cerrar</button>
    <h3>âš ï¸ Te han robado una carta</h3>
    <div class="small" id="inboxText">â€¦</div>
    <div id="inboxPreview" class="cards" style="margin-top:10px"></div>
    <div class="hr"></div>
    <div class="flex" id="stealDefenseButtons"></div>
    <div class="hr"></div>
    <div class="flex">
      <button id="inboxApply" class="btn bad">OK (restar de mi inventario)</button>
    </div>
  </div>
</div>

<!-- Modal NotificaciÃ³n de ATAQUE (vÃ­ctima) -->
<div id="attackModal" class="modal" aria-hidden="true">
  <div class="panel" role="dialog" aria-label="Ataque recibido" style="grid-template-columns:1fr">
    <button class="closeX" id="attackCloseX">Cerrar</button>
    <h3>âš”ï¸ Â¡Ataque recibido!</h3>
    <div class="small" id="attackText">â€¦</div>
    <div id="attackPreview" class="cards" style="margin-top:10px"></div>
    <div class="hr"></div>
    <div class="flex" id="defenseButtons"></div>
  </div>
</div>

<!-- Modal Robo sigiloso (ladrÃ³n) -->
<div id="stealModal" class="modal" aria-hidden="true">
  <div class="panel" role="dialog" aria-label="Robo sigiloso" style="grid-template-columns:1fr">
    <button class="closeX" id="stealCloseX">Cerrar</button>
    <h3>ğŸ•µï¸â€â™‚ï¸ Robo sigiloso</h3>
    <div class="small">Elige un usuario y UNA carta del inventario del rival. A ti se te suma ahora; al rival se le restarÃ¡ cuando pulse OK.</div>
    <div class="flex">
      <select id="stealTarget"><option value="">â€” Elegir usuario â€”</option></select>
      <button id="stealLoad" class="btn alt">Ver inventario</button>
    </div>
    <div id="stealGrid" class="cards"></div>
    <div class="hr"></div>
    <div class="flex"><button id="stealConfirm" class="btn" disabled>Robar carta seleccionada</button><div class="spacer"></div><button id="stealCancel" class="btn alt">Cancelar</button></div>
  </div>
</div>

<!-- Modal Barajear cartas -->
<div id="shuffleModal" class="modal" aria-hidden="true">
  <div class="panel" role="dialog" aria-label="Barajear cartas" style="grid-template-columns:1fr">
    <button class="closeX" id="shuffleCloseX">Cerrar</button>
    <h3>ğŸ”€ Barajear cartas</h3>
    <div class="small">Elige <strong>3</strong> cartas (por unidades). Se restarÃ¡n y recibirÃ¡s <strong>2</strong> aleatorias, ponderadas por rarezas.</div>
    <div id="shufflePickGrid" class="cards" style="margin-top:10px"></div>
    <div class="hr"></div>
    <div class="flex">
      <div class="badge">Seleccionadas: <span id="shuffleCount">0</span>/3</div>
      <div class="spacer"></div>
      <button id="shuffleConfirm" class="btn" disabled>Barajar</button>
      <button id="shuffleCancel" class="btn alt">Cancelar</button>
    </div>
  </div>
</div>

<!-- Modal Resultado Barajar -->
<div id="shuffleResultModal" class="modal" aria-hidden="true">
  <div class="panel" role="dialog" aria-label="Resultado barajar">
    <button class="closeX" id="shuffleResultCloseX">Cerrar</button>
    <div class="bigImg"><img id="shuffleImg1" alt="Carta 1" style="max-width:100%;max-height:100%"></div>
    <div>
      <h3>ğŸ Nuevas cartas</h3>
      <div id="shuffleNames" class="small"></div>
      <div class="hr"></div>
      <button id="shuffleResultClose" class="btn alt right">Cerrar</button>
    </div>
  </div>
</div>

<!-- Modal selector de usuario reutilizable -->
<div id="targetModal" class="modal" aria-hidden="true">
  <div class="panel" role="dialog" aria-label="Elegir usuario" style="grid-template-columns:1fr">
    <button class="closeX" id="targetCloseX">Cerrar</button>
    <h3 id="targetTitle">Selecciona usuario</h3>
    <div class="flex">
      <select id="targetSelect"><option value="">â€” Elegir â€”</option></select>
      <button id="targetOk" class="btn">Aceptar</button>
      <button id="targetCancel" class="btn alt">Cancelar</button>
    </div>
  </div>
</div>

<script type="module">
/* ========= Firebase ========= */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
import {
  getAuth, onAuthStateChanged, signInWithPopup, signInWithRedirect, GoogleAuthProvider,
  signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, updateProfile,
  getRedirectResult
} from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";

import {
  getFirestore, doc, getDoc, setDoc, onSnapshot, enableIndexedDbPersistence,
  collection, query, where, addDoc, updateDoc, serverTimestamp, getDocs
} from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCPhWAShfR33sAuZ2H4Y2BAGnF8wkkv_S0",
  authDomain: "pokerandom-ce300.firebaseapp.com",
  projectId: "pokerandom-ce300",
  storageBucket: "pokerandom-ce300.firebasestorage.app",
  messagingSenderId: "637348459448",
  appId: "1:637348459448:web:4ab19e68bcce734692554d"
};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
// Recoger resultado redirect (por si el popup fue bloqueado)
(async ()=>{ try{ await getRedirectResult(auth); }catch(e){ console.warn(e);} })();
const db = getFirestore(app);
enableIndexedDbPersistence(db).catch(()=>{});

/* ========= Helpers ========= */
const $ = s => document.querySelector(s);
const toast = (m)=>{ const t=$("#toast"); t.textContent=m; t.classList.add("show"); setTimeout(()=>t.classList.remove("show"),1800); };
const esc = s => String(s??"").replace(/[&<>"']/g,c=>({"&":"&amp;","<":"&lt;","&gt;":"&gt;","\"":"&quot;","'":"&#039;"}[c]));
const slugType = t => t.trim().toLowerCase().replace("curacion","curaciÃ³n").replace("economia","economÃ­a").replace("item","Ã­tem");
const tierOf = c => (c===13||c===10)?"legendaria": c===7?"Ã©pica": c===4?"rara": c===2?"comÃºn": (c===0||c===99)?"especial":"otra";
const capFirst = s => { if(!s) return ""; let t=String(s).trim(); t=t.replace(/\bpokemon(es)?\b/gi,m=>m.toLowerCase().endsWith("es")?"PokÃ©mones":"PokÃ©mon"); t=t.replace(/\busala\b/gi,"Ãºsala").replace(/\busa la\b/gi,"Ãºsala"); t=t.replace(/\bpage\b/gi,"pague"); return t.charAt(0).toUpperCase()+t.slice(1); };
const randInt = (n)=> Math.floor(Math.random()*n);

/* ========= Datos base ========= */
const rawList = [
  [2,"Curacion","Objeto curativo","permite comprar un objeto curativo de una tienda."],
  [7,"Curacion","Dama curativa","Puedes comprar hasta 5 objetos curativos en la misma tienda."],
  [4,"Gacha","Ruleta","Puedes tirar ruleta en la que obtendrÃ¡s una carta aleatoria."],
  [99,"Ataque","Robo de monedas","Puedes robar 5 monedas a otro jugador en cualquier momento."],
  [0,"economia","Venta ilegal","libera un pokemon y recibe 2 monedas."],
  [10,"economia","10 monedas","recibes 10 monedas al instante."],
  [3,"economia","Monedero perdido","recibes de 1 a 5 monedas aleatorias."],
  [2,"economia","Apuesta","Recibes 3 monedas mÃ¡s si no pierdes pokemon contra el siguiente lÃ­der de gimnasio."],
  [10,"captura","Captura shiny","puedes capturar una vez mÃ¡s en ruta y ese pokemon se volverÃ¡ shiny."],
  [2,"captura","Skip pokemon","al usarla antes de capturar, puedes decidir si skipear el primer pokÃ©mon que salga. Esto no contarÃ¡ como primer pokÃ©mon de ruta y pÃ­ldoras volver a intentar capturar."],
  [10,"captura","Recaptura","puedes recapturar"],
  [4,"captura","Reroll","puedes usarla tras aparecer el primer pokÃ©mon y podrÃ¡s skipearlo e ir a por el siguiente."],
  [4,"item","Masterball","obtienes una masterball."],
  [7,"item","Compra MT","Ãºsala para poder comprar una MT en una tienda del juego"],
  [10,"item","Capsula habilidad","Ãºsala para obtener una cÃ¡psula habilidad."],
  [10,"item","Piedra Evolutiva","Ãšsala para canjearla por una piedra evolutiva a tu elecciÃ³n."],
  [10,"item","MegaPiedra","Ãšsala para obtener una mega piedra a tu elecciÃ³n."],
  [4,"Gacha","Caja sorpresa","Cambia un item por otro random del mismo tipo."],
  [10,"item","Objeto fuerte","obtienes un objeto competitivo a tu elecciÃ³n."],
  [10,"Curacion","Revivir Pokemon","revive un pokemon"],
  [10,"Curacion","Revivir Inicial","Revive a tu inicial una vez (no cuenta para el uso de revivir, es decir, pÃ­ldoras  revivir a un inicial que haya sido revivido por la carta revivir)"],
  [7,"Curacion","Cambio de inicial","puedes designar a otro pokÃ©mon vivo de tu elecciÃ³n como inicial"],
  [10,"defensa","Reversa","bloqueas y devuelves la carta de ataque del rival"],
  [7,"defensa","Bloqueo","bloquear la carta del rival"],
  [10,"curacion","BendiciÃ³n de Arceus","usala antes de un combate y el primer pokemon muerto, no morirÃ¡ realmente."],
  [7,"ataque","Robo Curativo","robas 3 objetos curativos a un rival"],
  [4,"ataque","Desgaste","Obligas a un rival a no poder sacar ni meter pokemons antes del siguiente combate contra un lÃ­der."],
  [7,"ataque","LiberaciÃ³n","escoge dos pokemons del rival y Ã©l decidirÃ¡ uno al que liberar."],
  [10,"ataque","Robo de caja","roba el pokÃ©mon a tu elecciÃ³n de la caja del rival"],
  [13,"ataque","Robo de equipo","roba un pokÃ©mon aleatorio del equipo del rival"],
  [7,"ataque","bloqueo pokemon","bloquea un pokÃ©mon rival hasta el siguiente lÃ­der (en los combates tambiÃ©n estaba bloqueado y por tanto no lo podrÃ¡ usar)"],
  [7,"ataque","destructor","obligas al rival a jugar con solo 5 pokemons hasta el siguiente lÃ­der"],
  [5,"ataque","Mismo destino","tu liberas un pokemon y el rival deberÃ¡ liberar otro que comparta uno de los tipos"],
  [4,"ataque","envenenamiento","el rival deber tirar 2 curas de su inventario"],
  [10,"gacha","Prime","si tu pokÃ©mon elegido con la carta no muere en los combates contra los demÃ¡s, recibirÃ¡ 31 IVS en todo, si lo vuelves a usar, se volverÃ¡ shiny"],
  [4,"defensa","Venganza","si te han tirado 2 o mÃ¡s cartas el mismo jugador, puedes tirar de ruleta o robarle un pokÃ©mon aleatorio de su caja."],
  [4,"gacha","Apuesta Segura","Apuesta que vas a ganar los combates contra los demÃ¡s jugadores. si Ganas, recibes 15 monedas, si pierdes, debes dar 5 monedas a cada jugador que te gano."],
  [10,"ataque","Cambio repentino","Un pokÃ©mon de un rival cambiarÃ¡ su habilidad al menos que el rival page 15 monedas"],
  [0,"item","Intercambio","Intercambia un pokÃ©mon con un rival si ambos quieren."],
  [2,"defensa","Regalo","EnvÃ­as un objeto curativo aleatorio a un rival. A cambio, si te lanza una carta negativa, tendrÃ¡s que devolver el regalo por 3 de su propio inventario."],
  [10,"defensa","MaldiciÃ³n","Maldices a un rival, si ese jugador tiene 3 de karma negativo o mÃ¡s, puedes robarle una carta a tu elecciÃ³n."],
  [7,"Ataque","Robo sigiloso","Robas una carta del rival"],
  [7,"defensa","Buff permanente","subes 8 puntos todos los IVS de un pokÃ©mon a tu elecciÃ³n"],
  [2,"defensa","ProtecciÃ³n del dÃ©bil","usa cuando te tiren una carta de ataque, tira una moneda; si sale cara, te proteges y el rival recupera su carta; si sale cruz, recibes el ataque y pierdes esta carta."],
  [4,"gacha","Barajear cartas","Elige 3 cartas de tu inventario; recibes 2 cartas aleatorias ponderadas por rareza."]
];
let cardsBase = rawList.map((r,i)=>({id:"c"+String(i+1).padStart(2,"0"),cost:+r[0],type:slugType(r[1]),name:r[2].trim(),desc:capFirst(r[3]||""),qty:0}));
// Ajuste: Intercambio pasa a costar 2
cardsBase = cardsBase.map(c=> c.name.toLowerCase()==="intercambio" ? {...c, cost:2} : c);

/* ========= Estado ========= */
let currentUser=null, spyUid=null, unsubInv=null, unsubProfiles=null, unsubInbox=null, unsubAttackInbox=null, unsubDebuffs=null;
let profiles=[];
let state={coins:0,karma:0,cards:cardsBase,walletLog:[],useLog:[],updatedAt:null};

/* ========= Refs ========= */
const invRef = uid => doc(db,"inventories",uid);
const profRef = uid => doc(db,"profiles",uid);
const stealCol = collection(db,"stealRequests");
const attackCol = collection(db,"attackRequests");
const debuffCol = collection(db,"debuffs");

/* ========= UI comunes ========= */
const coinsEl=$("#coins"), coinsMini=$("#coinsMini"), karmaEl=$("#karma");
const gridEl=$("#cardsGrid"), walletLogEl=$("#walletLog"), useLogEl=$("#useLog");
const typeFilter=$("#typeFilter"), hideZero=$("#hideZero");
const toolsBtn=$("#toolsBtn"), toolsPanel=$("#toolsPanel");
toolsBtn.onclick=(e)=>{e.stopPropagation();toolsPanel.classList.toggle("show")};
document.body.addEventListener("click",()=>toolsPanel.classList.remove("show"));
typeFilter.onchange=render; hideZero.onchange=render;

/* ========= Exportar / Importar / Reiniciar ========= */
$("#exportBtn").onclick = ()=>{
  const filename = `wobalonga_${(currentUser?.displayName||currentUser?.email||"anon").replace(/[^a-z0-9_-]/gi,"_")}_${new Date().toISOString().slice(0,10)}.json`;
  const blob = new Blob([JSON.stringify(state,null,2)], {type:"application/json"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = filename;
  a.click();
  setTimeout(()=>URL.revokeObjectURL(a.href), 1000);
};
$("#importFile").onchange = async (e)=>{
  const file = e.target.files?.[0]; if(!file) return;
  try{
    const text = await file.text();
    const data = JSON.parse(text);
    state.coins = Math.max(0, Math.trunc(data.coins||0));
    state.karma = Math.trunc(data.karma||0);
    if(Array.isArray(data.cards)){
      const map = new Map(data.cards.map(c=>[c.id, Math.max(0, Math.trunc(c.qty||0))]));
      state.cards.forEach(c=>{ c.qty = map.get(c.id)||0; });
    }
    state.walletLog = Array.isArray(data.walletLog)?data.walletLog:[];
    state.useLog    = Array.isArray(data.useLog)?data.useLog:[];
    toast("ğŸ“¥ Importado");
    scheduleSave(); render();
  }catch(err){ alert("Import invÃ¡lido"); }
};
$("#resetBtn").onclick = ()=>{
  if(!confirm("Â¿Seguro que quieres reiniciar tu inventario?")) return;
  if(!confirm("Esto no tiene deshacer. Â¿Confirmas?")) return;
  state.coins = 0; state.karma = 0; state.cards.forEach(c=> c.qty = 0);
  state.walletLog = []; state.useLog = [];
  toast("ğŸ§¹ Reiniciado");
  scheduleSave(); render();
};

/* ========= Auth ========= */
const who=$("#whoAmI"), btnGoogle=$("#btnGoogle"), btnEmail=$("#btnEmail"), btnLogout=$("#btnLogout");
const toolsBox=$("#toolsBox"), spyTools=$("#spyTools");
btnGoogle.onclick = async () => {
  try {
    const p = new GoogleAuthProvider();
    p.setCustomParameters({ prompt: "select_account" });
    await signInWithPopup(auth, p);
  } catch (e) {
    if (e.code === "auth/popup-blocked" || e.code === "auth/popup-closed-by-user") {
      try { await signInWithRedirect(auth, new GoogleAuthProvider()); } catch (e2) { alert("Redirect fallÃ³: " + (e2.code || e2.message)); }
    } else if (e.code === "auth/unauthorized-domain") {
      alert("Dominio no autorizado en Firebase.");
    } else {
      alert("Error Google: " + (e.code || e.message));
    }
  }
};

btnEmail.onclick=async()=>{const email=prompt("Email:");if(!email)return;const pass=prompt("ContraseÃ±a:");if(!pass)return;try{await signInWithEmailAndPassword(auth,email,pass)}catch(e){if(e.code==="auth/user-not-found"||e.code==="auth/invalid-credential"){if(confirm("No existe ese usuario. Â¿Crear cuenta con ese email?")){try{const cred=await createUserWithEmailAndPassword(auth,email,pass);const name=prompt("Nombre para mostrar (opcional):")||"";if(name)await updateProfile(cred.user,{displayName:name});toast("Cuenta creada âœ…")}catch(e2){alert("Error creando: "+e2.code)}}return}if(e.code==="auth/unauthorized-domain"){alert("Dominio no autorizado en Firebase.");return}alert("Error email/contraseÃ±a: "+e.code)}};
btnLogout.onclick=()=>signOut(auth);

async function ensureProfile(u){
  const d=await getDoc(profRef(u.uid));
  const payload={displayName:u.displayName||(u.email?u.email.split("@")[0]:"Jugador"),email:u.email||null,updatedAt:serverTimestamp()};
  if(!d.exists()) payload.createdAt=serverTimestamp();
  await setDoc(profRef(u.uid),payload,{merge:true});
}
async function initInventoryIfMissing(uid){
  const d=await getDoc(invRef(uid));
  if(!d.exists()){
    await setDoc(invRef(uid),{coins:0,karma:0,cards:cardsBase,walletLog:[],useLog:[],updatedAt:serverTimestamp()});
  }
}

onAuthStateChanged(auth, async (user)=>{
  if(user){
    currentUser=user;
    who.textContent = user.displayName || user.email || user.uid;
    btnGoogle.style.display="none"; btnEmail.style.display="none"; btnLogout.style.display="inline-block";
    toolsBox.style.display="block"; spyTools.style.display="block";
    document.documentElement.classList.remove("spyTint");
    await ensureProfile(user);
    await initInventoryIfMissing(user.uid);
    subscribeProfiles();
    subscribeInventory(user.uid);
    subscribeStealInbox(user.uid);
    subscribeAttackInbox(user.uid);
    subscribeDebuffs(user.uid);
  }else{
    currentUser=null;
    who.textContent="Sin sesiÃ³n";
    btnGoogle.style.display="inline-block"; btnEmail.style.display="inline-block"; btnLogout.style.display="none";
    toolsBox.style.display="none"; spyTools.style.display="none";
    unsubscribeAll();
    state={coins:0,karma:0,cards:cardsBase.map(x=>({...x,qty:0})),walletLog:[],useLog:[]};
    render();
  }
});

function unsubscribeAll(){
  [unsubInv,unsubProfiles,unsubInbox,unsubAttackInbox,unsubDebuffs].forEach(fn=>{try{fn&&fn()}catch{}});
  unsubInv=unsubProfiles=unsubInbox=unsubAttackInbox=unsubDebuffs=null;
}

/* ========= Subs ========= */
function subscribeProfiles(){
  if(unsubProfiles){unsubProfiles();unsubProfiles=null}
  unsubProfiles=onSnapshot(collection(db,"profiles"),(snap)=>{
    profiles=snap.docs.map(d=>({id:d.id,...d.data()}));
    renderSpyMenu();
    // select para robo
    const me=currentUser?.uid;
    const opts=['<option value="">â€” Elegir usuario â€”</option>'].concat(
      profiles.filter(p=>p.id!==me).map(p=>`<option value="${p.id}">${esc(p.displayName||p.email||p.id)}</option>`)
    );
    const tsel=$("#stealTarget"); if(tsel) tsel.innerHTML=opts.join("");
  });
}
function subscribeInventory(uid){
  if(unsubInv){unsubInv();unsubInv=null}
  unsubInv=onSnapshot(invRef(uid),(snap)=>{ if(!snap.exists())return; state=snap.data()||state; render(); });
}
function subscribeStealInbox(uid){
  if(unsubInbox){unsubInbox();unsubInbox=null}
  const qv = query(stealCol, where("victimId","==",uid), where("status","==","pending"), where("seenByVictim","in",[false,null]));
  unsubInbox=onSnapshot(qv,(snap)=>{
    const unseen = snap.docs.filter(d=>!d.data().seenByVictim);
    if(!unseen.length) return;
    showStealInbox(unseen[0].id, unseen[0].data());
  });
}
function subscribeAttackInbox(uid){
  if(unsubAttackInbox){unsubAttackInbox();unsubAttackInbox=null}
  const qv=query(attackCol, where("victimId","==",uid), where("status","==","pending"));
  unsubAttackInbox=onSnapshot(qv,(snap)=>{ const docs=snap.docs; if(!docs.length) return; showAttackInbox(docs[0].id, docs[0].data()); });
}
function subscribeDebuffs(uid){
  if(unsubDebuffs){unsubDebuffs();unsubDebuffs=null}
  const qv=query(debuffCol, where("targetId","==",uid), where("active","==",true));
  let initial=true;
  unsubDebuffs=onSnapshot(qv,(snap)=>{
    if(initial){ initial=false; render(); return; }
    snap.docChanges().forEach(ch=>{
      if(ch.type==="added"){
        const d=ch.doc.data();
        if(d.type==="curse") toast(`ğŸª„ Te han maldecido (${d.fromName||d.fromId})`);
        if(d.type==="gift")  toast(`ğŸ Regalo pendiente de ${d.giverName||d.giverId}`);
      }
    });
    render();
  });
}

/* ========= Guardado ========= */
let saveTimer=null;
function scheduleSave(){ if(spyUid||!currentUser) return; clearTimeout(saveTimer); saveTimer=setTimeout(()=>saveNow().catch(()=>{}),350); }
async function saveNow(){ await setDoc(invRef(currentUser.uid), {...state, updatedAt:serverTimestamp()}, {merge:true}); }

/* ========= Render ========= */
function render(){
  $("#mainSection").classList.toggle("readonly", !!spyUid);
  coinsEl.textContent=String(state.coins||0);
  coinsMini.textContent=String(state.coins||0);
  karmaEl.textContent=String(state.karma||0);

  gridEl.innerHTML="";
  const f=(typeFilter.value||"").trim(), hide=hideZero.checked;
  state.cards.forEach(card=>{
    if(spyUid && (card.qty||0)<=0) return; // espiar: solo las que tiene
    if(f && card.type!==f) return; if(hide && (card.qty||0)<=0) return;
    const slot=document.createElement("div"); slot.className="cardSlot"+((card.qty||0)<=0?" zero":""); slot.dataset.id=card.id;
    const imgWrap=document.createElement("div"); imgWrap.className="imgWrap";
    const img=document.createElement("img"); img.alt=card.name; img.src=`img/${card.id}.png`; img.onerror=()=>{ if(!img.dataset.tryJ){ img.dataset.tryJ=1; img.src=`img/${card.id}.jpg`; } };
    imgWrap.appendChild(img);
    const title=document.createElement("div"); title.className="title"; title.textContent=card.name;
    const meta=document.createElement("div"); meta.className="small"; meta.innerHTML=`<span class="badge">${esc(card.type)}</span> Â· <span class="badge">${card.cost} ğŸª™ Â· ${esc(tierOf(card.cost))}</span>`;
    if(card.qty>0){ const qty=document.createElement("div"); qty.className="qty"; qty.textContent="Ã— "+card.qty; slot.appendChild(qty); }
    slot.appendChild(imgWrap); slot.appendChild(title); slot.appendChild(meta);
    slot.onclick=()=> openCard(card.id);
    gridEl.appendChild(slot);
  });

  walletLogEl.innerHTML=(state.walletLog||[]).slice().reverse().map(l=>{
    const gain=l.type==="ingreso"; const cls=gain?"gain":"loss"; const sign=gain?"+":"âˆ’";
    const note=l.note?` â€” <span class="small">${esc(l.note)}</span>`:"";
    return `<div class="${cls}"><span class="small">${new Date(l.date).toLocaleString()}</span> Â· <strong>${esc(l.type)}</strong> Â· <span class="mono">${sign} ${Math.trunc(l.amount)}</span>${note}</div>`;
  }).join("");
  useLogEl.innerHTML=(state.useLog||[]).slice().reverse().map(u=>{
    const gain=/Compraste|Ganaste por ruleta|AÃ±adida|aÃ±adida|\(\+1\)|pendiente/i.test(u.name);
    const cls=gain?"gain":"loss";
    const note=u.note?` â€” <span class="small">${esc(u.note)}</span>`:"";
    return `<div class="${cls}"><span class="small">${new Date(u.date).toLocaleString()}</span> Â· ${esc(u.name)}${note}</div>`;
  }).join("");

  const r=state.cards.find(c=>c.name.toLowerCase()==="ruleta"); $("#ruletaQty").textContent=r?(r.qty||0):0;

  // Debufos visibles
  (async ()=>{
    if(!currentUser){ $("#debuffBar").style.display="none"; return; }
    const q = query(debuffCol, where("targetId","==",currentUser.uid), where("active","==",true));
    const snaps = await getDocs(q);
    const items = snaps.docs.map(d=>({id:d.id, ...d.data()}));
    const bar = $("#debuffBar");
    if(!items.length){ bar.style.display="none"; bar.innerHTML=""; return; }
    bar.style.display="flex";
    bar.innerHTML = items.map(it=>{
      if(it.type==="curse") return `<span class="badge">ğŸª„ MaldiciÃ³n de <strong>${esc(it.fromName||it.fromId)}</strong></span>`;
      if(it.type==="gift")  return `<span class="badge">ğŸ Regalo pendiente con <strong>${esc(it.giverName||it.giverId)}</strong></span>`;
      return "";
    }).join("");
  })();
}

/* ========= Header extra ========= */
$("#karmaBtn").onclick=async()=>{
  if(!currentUser) return;
  if(confirm("Â¿Has recibido un ataque?")){
    state.karma=(state.karma||0)-1; toast("âš¡ Karma reducido (ataque recibido)"); scheduleSave(); render();
  }
};

/* ========= Modales comunes ========= */
const modals=[...document.querySelectorAll(".modal")];
function toggleModal(el,show){el.classList.toggle("show",!!show);el.setAttribute("aria-hidden",show?"false":"true")}
modals.forEach(m=>m.addEventListener("click",(e)=>{if(e.target===m)toggleModal(m,false)}));
window.addEventListener("keydown",(e)=>{if(e.key==="Escape"){modals.forEach(m=>toggleModal(m,false))}});

/* ========= Monedero ========= */
$("#coinMenuBtn").onclick=()=>toggleModal($("#coinModal"),true);
$("#coinClose").onclick=()=>toggleModal($("#coinModal"),false);
$("#coinCloseX").onclick=()=>toggleModal($("#coinModal"),false);
$("#coinAdd").onclick=()=>coinOp("ingreso");
$("#coinSub").onclick=()=>coinOp("gasto");
$("#btnLeader").onclick=quickLeader;
$("#btnBoss").onclick=quickBoss;
function coinOp(kind){
  if(spyUid||!currentUser) return;
  const amt=Math.max(0,Math.trunc(Number($("#coinAmount").value))); if(!amt){alert("Cantidad invÃ¡lida");return}
  const note=($("#coinReason").value||"").trim();
  if(kind==="ingreso"){state.coins+=amt;toast(`ğŸª™ +${amt} monedas`)}
  else{ if(state.coins<amt){alert("No tienes suficientes monedas");return} state.coins-=amt;toast(`ğŸ’¸ -${amt} monedas`)}
  state.walletLog.push({date:new Date().toISOString(),type:kind,amount:amt,note});
  $("#coinAmount").value="";$("#coinReason").value="";
  scheduleSave(); toggleModal($("#coinModal"),false); render();
}
function quickLeader(){ if(spyUid||!currentUser)return; const lost=confirm("Â¿Has perdido algÃºn PokÃ©mon contra el lÃ­der?\nAceptar = SÃ Â· Cancelar = NO"); const total=lost?6:9; state.coins+=total; toast(`ğŸ† +${total} monedas (${lost?"con":"sin"} bajas)`); state.walletLog.push({date:new Date().toISOString(),type:"ingreso",amount:total,note:`LÃ­der completado (${lost?"con":"sin"} bajas)`}); scheduleSave(); render();}
function quickBoss(){ if(spyUid||!currentUser)return; const lost=confirm("Â¿Has perdido algÃºn PokÃ©mon en el combate importante?\nAceptar = SÃ Â· Cancelar = NO"); const total=lost?5:7; state.coins+=total; toast(`âš”ï¸ +${total} monedas (${lost?"con":"sin"} bajas)`); state.walletLog.push({date:new Date().toISOString(),type:"ingreso",amount:total,note:`Combate importante (${lost?"con":"sin"} bajas)`}); scheduleSave(); render(); }

/* ========= Carta modal ========= */
const cardModal=$("#cardModal");
$("#closeCard").onclick=()=>toggleModal(cardModal,false);
$("#cardCloseX").onclick=()=>toggleModal(cardModal,false);
let currentCardId=null;
$("#buyBtn").onclick=onBuy; $("#useBtn").onclick=onUse;

function openCard(id){
  currentCardId=id; const c=state.cards.find(x=>x.id===id); if(!c)return;
  const big=$("#cardImgBig"); big.removeAttribute("data-tried"); big.onerror=null;
  big.src=`img/${c.id}.png`; big.onerror=()=>{ if(!big.dataset.tried){ big.dataset.tried=1; big.src=`img/${c.id}.jpg`;} };
  $("#cardTitle").textContent=c.name;
  $("#cardTypeCost").innerHTML=`<span class="badge">${esc(c.type)}</span> Â· <span class="badge">${c.cost} ğŸª™ Â· ${esc(tierOf(c.cost))}</span>`;
  $("#cardDesc").textContent=c.desc||"";
  $("#cardPrice").textContent=Math.trunc(c.cost||0);
  $("#cardQty").textContent=Math.trunc(c.qty||0);
  $("#useBtn").disabled=(c.qty||0)<=0 || !!spyUid || !currentUser;
  $("#buyBtn").disabled=!!spyUid || !currentUser;
  toggleModal(cardModal,true);
}

function onBuy(){
  if(spyUid||!currentUser)return;
  const c=state.cards.find(x=>x.id===currentCardId); if(!c)return;
  const price=Math.trunc(c.cost||0);
  if(state.coins<price){alert("No tienes suficientes monedas para comprar esta carta.");return}
  state.coins-=price; c.qty=(c.qty||0)+1;
  state.walletLog.push({date:new Date().toISOString(),type:"gasto",amount:price,note:`Compra: ${c.name}`});
  state.useLog.push({date:new Date().toISOString(),cardId:c.id,name:`Compraste ${c.name} (+1)`,note:"Compra"});
  toast(`ğŸ›’ Compraste ${c.name} (+1)`); scheduleSave(); render(); openCard(c.id);
}

/* ========= Utils ========= */
function findCardByName(name){ return state.cards.find(c=>c.name.toLowerCase()===name.toLowerCase()); }
function addCoins(amount,note){ state.coins+=amount; state.walletLog.push({date:new Date().toISOString(),type:"ingreso",amount,note}); }

/* ========= Robo sigiloso (por notificaciÃ³n) ========= */
const stealModal=$("#stealModal"), stealTarget=$("#stealTarget"), stealLoad=$("#stealLoad"), stealGrid=$("#stealGrid");
const stealConfirm=$("#stealConfirm"), stealCancel=$("#stealCancel"), stealCloseX=$("#stealCloseX");
let stealSelectedCardId=null, stealSelectedCardName=null, victimSnapshot=null;
stealCancel.onclick=()=>toggleModal(stealModal,false);
stealCloseX.onclick=()=>toggleModal(stealModal,false);

function openSteal(){
  stealSelectedCardId=null; stealSelectedCardName=null; stealGrid.innerHTML="";
  stealConfirm.disabled=true;
  toggleModal(stealModal,true);
}
stealLoad.onclick=async()=>{
  const uid=stealTarget.value; if(!uid){alert("Elige un usuario");return}
  const snap=await getDoc(invRef(uid)); if(!snap.exists()){alert("Inventario no encontrado");return}
  victimSnapshot=snap.data();
  stealGrid.innerHTML="";
  victimSnapshot.cards.filter(c=> (c.qty||0)>0).forEach(c=>{
    const slot=document.createElement("div"); slot.className="cardSlot"; slot.dataset.id=c.id;
    const imgWrap=document.createElement("div"); imgWrap.className="imgWrap";
    const img=document.createElement("img"); img.alt=c.name; img.src=`img/${c.id}.png`; img.onerror=()=>{ if(!img.dataset.tryJ){ img.dataset.tryJ=1; img.src=`img/${c.id}.jpg`; } };
    imgWrap.appendChild(img);
    const title=document.createElement("div"); title.className="title"; title.textContent=c.name;
    const meta=document.createElement("div"); meta.className="small"; meta.innerHTML=`<span class="badge">${esc(c.type)}</span> Â· <span class="badge">${c.cost} ğŸª™</span>`;
    slot.onclick=()=>{
      [...stealGrid.children].forEach(e=>e.classList.remove("picked"));
      slot.classList.add("picked");
      stealSelectedCardId=c.id; stealSelectedCardName=c.name; stealConfirm.disabled=false;
    };
    if(c.qty>0){ const qty=document.createElement("div"); qty.className="qty"; qty.textContent="Ã— "+c.qty; slot.appendChild(qty); }
    slot.appendChild(imgWrap); slot.appendChild(title); slot.appendChild(meta);
    stealGrid.appendChild(slot);
  });
};
stealConfirm.onclick=async()=>{
  if(!currentUser) return;
  const uid=stealTarget.value; if(!uid||!stealSelectedCardId) return;
  // Sumo al ladrÃ³n ahora
  const mine = state.cards.find(c=>c.id===stealSelectedCardId); if(mine){ mine.qty=(mine.qty||0)+1; }
  state.useLog.push({date:new Date().toISOString(), name:`Robo sigiloso: aÃ±adida ${stealSelectedCardName} (+1)`, note:`de ${uid}`});
  scheduleSave(); render(); toggleModal(stealModal,false);
  // NotificaciÃ³n a la vÃ­ctima
  await addDoc(stealCol, {
    attackerId: currentUser.uid, attackerName: currentUser.displayName||currentUser.email||currentUser.uid,
    victimId: uid,
    cardId: stealSelectedCardId, cardName: stealSelectedCardName,
    status: "pending", seenByVictim: false, createdAt: serverTimestamp()
  });
  toast("ğŸ•µï¸ Robo enviado. El rival confirmarÃ¡ la resta.");
};

/* ========= Robos (vÃ­ctima) ========= */
const inboxModal=$("#inboxModal"), inboxText=$("#inboxText"), inboxPreview=$("#inboxPreview");
const inboxApply=$("#inboxApply"), inboxCloseX=$("#inboxCloseX");
let currentInboxId=null, currentInboxData=null;

inboxCloseX.onclick=async()=>{
  if(currentInboxId){
    await updateDoc(doc(db,"stealRequests", currentInboxId), {
      seenByVictim: true,
      seenAt: serverTimestamp()
    });
  }
  toggleModal(inboxModal,false);
  currentInboxId=null; currentInboxData=null;
};

async function showStealInbox(docId, data){
  currentInboxId=docId; currentInboxData=data;
  const attacker=data.attackerName||data.attackerId;
  inboxText.innerHTML = `<strong>${esc(attacker)}</strong> te ha robado <strong>${esc(data.cardName || "una carta")}</strong>.`;

  // Marca visto para que no reaparezca tras recargar
  await updateDoc(doc(db,"stealRequests", currentInboxId), {
    seenByVictim: true,
    seenAt: serverTimestamp()
  });

  inboxPreview.innerHTML="";
  const vc = state.cards.find(c=>c.id===data.cardId) || state.cards.find(c=>c.name.toLowerCase()===(data.cardName||"").toLowerCase());
  const block=document.createElement("div"); block.className="cardSlot";
  const imgWrap=document.createElement("div"); imgWrap.className="imgWrap";
  const img=document.createElement("img"); img.alt=vc?.name||data.cardName||"Carta"; img.src=`img/${vc?.id||data.cardId}.png`;
  img.onerror=()=>{ if(!img.dataset.tryJ){ img.dataset.tryJ=1; img.src=`img/${vc?.id||data.cardId}.jpg`; } };
  imgWrap.appendChild(img);
  const title=document.createElement("div"); title.className="title"; title.textContent=vc?.name||data.cardName||"Carta";
  const meta=document.createElement("div"); meta.className="small"; meta.innerHTML=`<span class="badge">${esc(vc?.type||"")}</span> Â· <span class="badge">${vc?.cost||"?"} ğŸª™</span>`;
  const qty=document.createElement("div"); qty.className="qty"; qty.textContent="Ã— "+(vc?.qty||0); block.appendChild(qty);
  block.appendChild(imgWrap); block.appendChild(title); block.appendChild(meta);
  inboxPreview.appendChild(block);

  // DEFENSAS en robo
  const stealDefenseButtons = $("#stealDefenseButtons"); stealDefenseButtons.innerHTML="";
  let myInv; try{ const snap=await getDoc(invRef(currentUser.uid)); myInv=snap.exists()?snap.data():state; }catch{ myInv=state; }
  const qtyOf = (name)=> (myInv.cards.find(c=>c.name.toLowerCase()===name.toLowerCase())?.qty||0);
  const hasReversa = qtyOf("Reversa")>0, hasBloqueo = qtyOf("Bloqueo")>0, hasProtec = qtyOf("ProtecciÃ³n del dÃ©bil")>0;

  const okBtn = document.createElement("button"); okBtn.className="btn bad"; okBtn.textContent="OK (restar de mi inventario)";
  okBtn.onclick = inboxApply.onclick; stealDefenseButtons.appendChild(okBtn);

  if(hasReversa){
    const b=document.createElement("button"); b.className="btn alt"; b.textContent="Usar Reversa";
    b.onclick=async()=>{
      const c=findCardByName("Reversa"); if(c&&c.qty>0) c.qty-=1;
      state.useLog.push({date:new Date().toISOString(), name:"Usaste Reversa (robo) (âˆ’1)"});
      await updateDoc(doc(db,"stealRequests",currentInboxId), {status:"defended", defenseUsed:"reversa", resolvedAt: serverTimestamp(), seenByVictim:true});
      toast("ğŸ›¡ï¸ Reversa usada: robo cancelado"); scheduleSave(); render(); toggleModal(inboxModal,false);
      currentInboxId=null; currentInboxData=null;
    };
    stealDefenseButtons.appendChild(b);
  }
  if(hasBloqueo){
    const b=document.createElement("button"); b.className="btn alt"; b.textContent="Usar Bloqueo";
    b.onclick=async()=>{
      const c=findCardByName("Bloqueo"); if(c&&c.qty>0) c.qty-=1;
      state.useLog.push({date:new Date().toISOString(), name:"Usaste Bloqueo (robo) (âˆ’1)"});
      await updateDoc(doc(db,"stealRequests",currentInboxId), {status:"defended", defenseUsed:"bloqueo", resolvedAt: serverTimestamp(), seenByVictim:true});
      toast("ğŸ›¡ï¸ Bloqueo usado: robo cancelado"); scheduleSave(); render(); toggleModal(inboxModal,false);
      currentInboxId=null; currentInboxData=null;
    };
    stealDefenseButtons.appendChild(b);
  }
  if(hasProtec){
    const b=document.createElement("button"); b.className="btn alt"; b.textContent="Usar ProtecciÃ³n del dÃ©bil (50%)";
    b.onclick=async()=>{
      const c=findCardByName("ProtecciÃ³n del dÃ©bil"); if(!(c&&c.qty>0)) return;
      const cara = Math.random()<0.5;
      if(cara){
        await updateDoc(doc(db,"stealRequests",currentInboxId), {status:"protected_success_refund", defenseUsed:"proteccion", coin:"cara", resolvedAt: serverTimestamp(), seenByVictim:true});
        toast("ğŸª™ Â¡Cara! Te proteges, rival recupera su carta de robo.");
      }else{
        c.qty -= 1;
        await updateDoc(doc(db,"stealRequests",currentInboxId), {status:"protected_fail", defenseUsed:"proteccion", coin:"cruz", resolvedAt: serverTimestamp(), seenByVictim:true});
        const vc2 = state.cards.find(x=>x.id===data.cardId);
        if(vc2 && vc2.qty>0){ vc2.qty -= 1; toast(`ğŸ”» -1 ${vc2.name}`); }
        state.useLog.push({date:new Date().toISOString(),cardId:data.cardId,name:`Te robaron ${data.cardName} (âˆ’1)`,note:`Por ${attacker}`});
        scheduleSave(); render();
      }
      toggleModal(inboxModal,false); currentInboxId=null; currentInboxData=null;
    };
    stealDefenseButtons.appendChild(b);
  }

  toggleModal(inboxModal,true);
}
let stealingOnce=false;
inboxApply.onclick=async()=>{
  if(stealingOnce) return; stealingOnce=true;
  try{
    if(!currentInboxId||!currentInboxData){toggleModal(inboxModal,false);return}
    const cid=currentInboxData.cardId, cname=currentInboxData.cardName||"Carta";
    const vc=state.cards.find(c=>c.id===cid);
    if(vc && (vc.qty||0)>0){
      vc.qty -= 1;
      state.useLog.push({date:new Date().toISOString(),cardId:cid,name:`Te robaron ${cname} (âˆ’1)`,note:`Por ${currentInboxData.attackerName||currentInboxData.attackerId}`});
      toast(`ğŸ”» -1 ${cname}`); scheduleSave(); render();
    }else{ toast("No tenÃ­as esa carta disponible. No se resta."); }
    await updateDoc(doc(db,"stealRequests",currentInboxId),{status:"applied",appliedAt:serverTimestamp(),seenByVictim:true});
    toggleModal(inboxModal,false); currentInboxId=null; currentInboxData=null;
  }finally{ setTimeout(()=>{ stealingOnce=false; }, 600); }
};

/* ========= Ataques (vÃ­ctima) ========= */
const attackModal=$("#attackModal"), attackText=$("#attackText"), attackPreview=$("#attackPreview"), defenseButtons=$("#defenseButtons"), attackCloseX=$("#attackCloseX");
attackCloseX.onclick=()=>toggleModal(attackModal,false);
let currentAttackId=null, currentAttackData=null;

async function showAttackInbox(docId, data){
  currentAttackId=docId; currentAttackData=data;
  const attacker=data.attackerName||data.attackerId;
  attackText.innerHTML=`<strong>${esc(attacker)}</strong> te ha atacado con <strong>${esc(data.cardName)}</strong>.`;
  attackPreview.innerHTML="";
  const vc = state.cards.find(c=>c.name.toLowerCase()===data.cardName.toLowerCase());
  const block=document.createElement("div"); block.className="cardSlot";
  const imgWrap=document.createElement("div"); imgWrap.className="imgWrap";
  const img=document.createElement("img"); img.alt=data.cardName; img.src=`img/${vc?.id||"c01"}.png`; img.onerror=()=>{ if(!img.dataset.tryJ){ img.dataset.tryJ=1; img.src=`img/${vc?.id||"c01"}.jpg`; } };
  imgWrap.appendChild(img);
  const title=document.createElement("div"); title.className="title"; title.textContent=data.cardName;
  block.appendChild(imgWrap); block.appendChild(title);
  attackPreview.appendChild(block);

  let myInv; try{ const snap = await getDoc(invRef(currentUser.uid)); myInv = snap.exists()? snap.data(): state; }catch{ myInv=state; }
  const qtyOf = (name)=> (myInv.cards.find(c=>c.name.toLowerCase()===name.toLowerCase())?.qty||0);

  defenseButtons.innerHTML="";
  const hasReversa = qtyOf("Reversa")>0;
  const hasBloqueo = qtyOf("Bloqueo")>0;
  const hasProtec  = qtyOf("ProtecciÃ³n del dÃ©bil")>0;

  const okBtn = document.createElement("button"); okBtn.className="btn bad"; okBtn.textContent="OK (recibir ataque)";
  okBtn.onclick = async ()=>{
    state.karma=(state.karma||0)-1;
    await updateDoc(doc(db,"attackRequests",currentAttackId), {status:"applied", resolvedAt: serverTimestamp()});
    toast("âš¡ Ataque recibido: karma âˆ’1"); scheduleSave(); render(); toggleModal(attackModal,false);
  };
  defenseButtons.appendChild(okBtn);

  if(hasReversa){
    const b=document.createElement("button"); b.className="btn alt"; b.textContent="Usar Reversa";
    b.onclick=async()=>{
      const c=findCardByName("Reversa"); if(c&&c.qty>0) c.qty-=1;
      await updateDoc(doc(db,"attackRequests",currentAttackId), {status:"defended", defenseUsed:"reversa", resolvedAt: serverTimestamp()});
      state.useLog.push({date:new Date().toISOString(), name:"Usaste Reversa (âˆ’1)"}); toast("ğŸ›¡ï¸ Reversa usada."); scheduleSave(); render(); toggleModal(attackModal,false);
    };
    defenseButtons.appendChild(b);
  }
  if(hasBloqueo){
    const b=document.createElement("button"); b.className="btn alt"; b.textContent="Usar Bloqueo";
    b.onclick=async()=>{
      const c=findCardByName("Bloqueo"); if(c&&c.qty>0) c.qty-=1;
      await updateDoc(doc(db,"attackRequests",currentAttackId), {status:"defended", defenseUsed:"bloqueo", resolvedAt: serverTimestamp()});
      state.useLog.push({date:new Date().toISOString(), name:"Usaste Bloqueo (âˆ’1)"}); toast("ğŸ›¡ï¸ Bloqueo usado."); scheduleSave(); render(); toggleModal(attackModal,false);
    };
    defenseButtons.appendChild(b);
  }
  if(hasProtec){
    const b=document.createElement("button"); b.className="btn alt"; b.textContent="Usar ProtecciÃ³n del dÃ©bil (50%)";
    b.onclick=async()=>{
      const c=findCardByName("ProtecciÃ³n del dÃ©bil"); if(!(c&&c.qty>0)) return;
      const cara = Math.random()<0.5;
      if(cara){
        await updateDoc(doc(db,"attackRequests",currentAttackId), {status:"protected_success_refund", defenseUsed:"proteccion", coin:"cara", resolvedAt: serverTimestamp()});
        toast("ğŸª™ Â¡Cara! Te proteges; el rival recupera su carta.");
      }else{
        c.qty -= 1; state.karma=(state.karma||0)-1;
        await updateDoc(doc(db,"attackRequests",currentAttackId), {status:"protected_fail", defenseUsed:"proteccion", coin:"cruz", resolvedAt: serverTimestamp()});
        toast("ğŸª™ Cruz. Pierdes la carta y recibes el ataque (karma âˆ’1)."); scheduleSave(); render();
      }
      scheduleSave(); render(); toggleModal(attackModal,false);
    };
    defenseButtons.appendChild(b);
  }

  toggleModal(attackModal,true);
}

/* ========= Espiar ========= */
function renderSpyMenu(){
  const me=currentUser?.uid;
  const items=profiles.filter(p=>p.id!==me).map(p=>`<button class="spyItem" data-uid="${p.id}" style="width:100%;text-align:left;background:transparent;color:var(--text);border:1px solid transparent;padding:8px 10px;border-radius:10px;cursor:pointer">${esc(p.displayName||p.email||p.id)}</button>`);
  let box = $("#spyMenu");
  if(!box){
    $("#spyTools").style.display="block";
    const menu=$("#spyMenu");
    $("#btnSpy").onclick=(e)=>{e.stopPropagation();menu.classList.toggle("show")};
    document.body.addEventListener("click",()=>menu.classList.remove("show"));
    menu.addEventListener("click",(e)=>{
      const btn=e.target.closest(".spyItem"); if(!btn)return;
      const uid=btn.getAttribute("data-uid"); menu.classList.remove("show"); if(!uid)return;
      spyUid=uid; $("#spyInfo").style.display="inline-flex";
      const profile=profiles.find(p=>p.id===uid); $("#spyName").textContent=profile?.displayName||profile?.email||uid;
      document.documentElement.classList.add("spyTint");
      subscribeInventory(uid);
    });
    $("#spyExit").onclick=()=>{spyUid=null;$("#spyInfo").style.display="none";document.documentElement.classList.remove("spyTint");if(currentUser)subscribeInventory(currentUser.uid)};
  }
  $("#spyMenu").innerHTML=items.length?items.join(""):'<div class="small">No hay otros usuarios aÃºn.</div>';
}

/* ========= Selector de usuario reutilizable ========= */
function pickUser(title="Selecciona usuario"){
  return new Promise((resolve)=>{
    const m=$("#targetModal"), sel=$("#targetSelect"), ok=$("#targetOk"), cancel=$("#targetCancel"), titleEl=$("#targetTitle"), closeX=$("#targetCloseX");
    titleEl.textContent = title;
    const me=currentUser?.uid;
    sel.innerHTML = ['<option value="">â€” Elegir â€”</option>'].concat(
      profiles.filter(p=>p.id!==me).map(p=>`<option value="${p.id}">${esc(p.displayName||p.email||p.id)}</option>`)
    ).join("");
    function done(val){ toggleModal(m,false); ok.onclick=cancel.onclick=closeX.onclick=null; resolve(val); }
    ok.onclick=()=>{ const v=sel.value; if(!v) return; const p=profiles.find(x=>x.id===v); done({uid:v,name:p?.displayName||p?.email||v}); };
    cancel.onclick=()=>done(null);
    closeX.onclick=()=>done(null);
    toggleModal(m,true);
  });
}

/* ========= USAR carta ========= */
async function onUse(){
  if(spyUid||!currentUser)return;
  const c=state.cards.find(x=>x.id===currentCardId); if(!c)return;
  if((c.qty||0)<=0){alert("No tienes esta carta.");return}
  // Efectos econÃ³micos automÃ¡ticos
  if(c.name==="10 monedas"){ addCoins(10,"Carta 10 monedas"); state.useLog.push({date:new Date().toISOString(),name:"Usaste 10 monedas (+10)"}); toast("ğŸ’° +10 monedas"); }
  else if(c.name.toLowerCase()==="venta ilegal"){ addCoins(2,"Venta ilegal"); state.useLog.push({date:new Date().toISOString(),name:"Usaste Venta ilegal (+2)"}); toast("ğŸª™ +2 (Venta ilegal)"); }
  else if(c.name.toLowerCase()==="monedero perdido"){ const n=1+randInt(5); addCoins(n,"Monedero perdido"); state.useLog.push({date:new Date().toISOString(),name:`Usaste Monedero perdido (+${n})`}); toast(`ğŸ² Monedero perdido: +${n}`); }
  else if(c.name.toLowerCase()==="robo de monedas"){
    const n=5; addCoins(n,"Robo de monedas"); state.useLog.push({date:new Date().toISOString(),name:`Usaste Robo de monedas (+${n})`}); toast("ğŸª™ +5 por Robo de monedas");
  }
  else if(c.name.toLowerCase()==="robo sigiloso"){
    openSteal(); return; // no restamos aÃºn, se resta al cerrar el pop-up de la vÃ­ctima
  }
  else if(c.name.toLowerCase()==="barajear cartas"){
    openShufflePicker(); return;
  }
  else if(c.type==="ataque"){
    // Elegir rival para el ataque y notificar
    const target = await pickUser(`Â¿A quiÃ©n quieres atacar con â€œ${c.name}â€?`);
    if(!target) return;
    state.karma=(state.karma||0)+1; // usar ataque suma karma negativo
    await addDoc(attackCol, {
      attackerId: currentUser.uid, attackerName: currentUser.displayName||currentUser.email||currentUser.uid,
      victimId: target.uid, cardName: c.name, status:"pending", createdAt: serverTimestamp()
    });
    toast(`âš”ï¸ Ataque enviado a ${target.name}`);
  }
  // Restar carta usada (si no fue robo sigiloso ni barajar)
  if(c.name.toLowerCase()!=="robo sigiloso" && c.name.toLowerCase()!=="barajear cartas"){
    c.qty -= 1; state.useLog.push({date:new Date().toISOString(),name:`Usaste ${c.name} (âˆ’1)`});
  }
  scheduleSave(); render(); openCard(c.id);
}

/* ========= Ruleta ========= */
const slotText=$("#slotText"), spinPaid=$("#spinPaid"), spinFree=$("#spinFree");
spinPaid.onclick=async()=>{
  if(!currentUser) return;
  const ok = confirm("Â¿Gastar 1 â€œRuletaâ€? Es totalmente aleatorio. (Prometo no meter NFTs)");
  if(!ok) return;
  const r=state.cards.find(c=>c.name.toLowerCase()==="ruleta"); if(!r||r.qty<=0){ alert("No tienes carta Ruleta."); return; }
  r.qty -= 1; runWheel();
};
spinFree.onclick=async()=>{
  if(!currentUser) return;
  const ok = confirm("Â¿Tirada gratis post-Gym? Â¿Has vencido a un lÃ­der?");
  if(!ok) return;
  runWheel();
};
function wheelPool(){
  const fixed = ["10 monedas","Monedero perdido"];
  const legend = state.cards.filter(c=> c.cost===10 || c.cost===13);
  const epic   = state.cards.filter(c=> c.cost===7);
  const rare   = state.cards.filter(c=> c.cost===4);
  const common = state.cards.filter(c=> c.cost===2);
  function pick(arr){ return arr.length? arr[randInt(arr.length)] : null; }
  const pool = [...fixed];
  if(legend.length) pool.push(pick(legend).name);
  if(epic.length)   pool.push(pick(epic).name);
  for(let i=0;i<3;i++) if(rare.length) pool.push(pick(rare).name);
  for(let i=0;i<4;i++) if(common.length) pool.push(pick(common).name);
  return pool;
}
function runWheel(){
  const pool = wheelPool();
  let i=0; slotText.textContent="Girandoâ€¦";
  const it = setInterval(()=>{ slotText.textContent=pool[i%pool.length]; i++; }, 90);
  setTimeout(()=>{ clearInterval(it);
    const win = pool[randInt(pool.length)];
    const card = state.cards.find(c=>c.name===win);
    if(card){ card.qty=(card.qty||0)+1; state.useLog.push({date:new Date().toISOString(), name:`Ganaste por ruleta: ${card.name} (+1)`}); rewardPopup(card); }
    else if(win==="10 monedas"){ addCoins(10,"Ruleta"); state.useLog.push({date:new Date().toISOString(), name:"Ganaste por ruleta: +10 monedas"}); }
    else if(win==="Monedero perdido"){ const n=1+randInt(5); addCoins(n,"Ruleta (Monedero perdido)"); state.useLog.push({date:new Date().toISOString(), name:`Ruleta â†’ Monedero perdido (+${n})`}); }
    scheduleSave(); render();
  }, 1600);
}
/* ========= Recompensa Modal ========= */
const rewardModal=$("#rewardModal"), rewardClose=$("#rewardClose"), rewardCloseX=$("#rewardCloseX");
function rewardPopup(card){
  $("#rewardName").textContent=card.name;
  $("#rewardMeta").textContent=`${card.type} Â· ${card.cost} ğŸª™ Â· ${tierOf(card.cost)}`;
  $("#rewardDesc").textContent=card.desc||"";
  const img=$("#rewardImg"); img.src=`img/${card.id}.png`; img.onerror=()=>{ img.src=`img/${card.id}.jpg`; };
  toggleModal(rewardModal,true);
}
rewardClose.onclick=()=>toggleModal(rewardModal,false);
rewardCloseX.onclick=()=>toggleModal(rewardModal,false);

/* ========= Barajear cartas ========= */
const shuffleModal=$("#shuffleModal"), shufflePickGrid=$("#shufflePickGrid"), shuffleCount=$("#shuffleCount"), shuffleConfirm=$("#shuffleConfirm"), shuffleCancel=$("#shuffleCancel");
const shuffleResultModal=$("#shuffleResultModal"), shuffleResultClose=$("#shuffleResultClose"), shuffleResultCloseX=$("#shuffleResultCloseX"), shuffleImg1=$("#shuffleImg1"), shuffleNames=$("#shuffleNames");
let shuffleSelection=[];
shuffleCancel.onclick=()=>toggleModal(shuffleModal,false);
shuffleResultClose.onclick=()=>toggleModal(shuffleResultModal,false);
shuffleResultCloseX.onclick=()=>toggleModal(shuffleResultModal,false);
function openShufflePicker(){
  shuffleSelection=[]; shuffleCount.textContent="0"; shufflePickGrid.innerHTML="";
  state.cards.forEach(c=>{
    if((c.qty||0)<=0) return;
    for(let i=0;i<c.qty;i++){
      const slot=document.createElement("div"); slot.className="cardSlot"; slot.dataset.id=c.id;
      const imgWrap=document.createElement("div"); imgWrap.className="imgWrap";
      const img=document.createElement("img"); img.alt=c.name; img.src=`img/${c.id}.png`; img.onerror=()=>{ if(!img.dataset.tryJ){ img.dataset.tryJ=1; img.src=`img/${c.id}.jpg`; } };
      imgWrap.appendChild(img);
      const title=document.createElement("div"); title.className="title"; title.textContent=c.name+" (u)";
      const meta=document.createElement("div"); meta.className="small"; meta.innerHTML=`<span class="badge">${esc(c.type)}</span> Â· <span class="badge">${c.cost} ğŸª™</span>`;
      slot.onclick=()=>{
        if(slot.classList.contains("picked")){
          slot.classList.remove("picked");
          const idx=shuffleSelection.indexOf(c.id); if(idx>=0) shuffleSelection.splice(idx,1);
        }else{
          if(shuffleSelection.length>=3) return;
          slot.classList.add("picked");
          shuffleSelection.push(c.id);
        }
        shuffleCount.textContent=String(shuffleSelection.length);
        shuffleConfirm.disabled = shuffleSelection.length!==3;
      };
      shufflePickGrid.appendChild(slot);
    }
  });
  toggleModal(shuffleModal,true);
}
shuffleConfirm.onclick=()=>{
  if(shuffleSelection.length!==3) return;
  shuffleSelection.forEach(id=>{
    const c=state.cards.find(x=>x.id===id);
    if(c && c.qty>0) c.qty -= 1;
  });
  const weights = {legendaria:5, Ã©pica:3, rara:2, comÃºn:1, especial:1, otra:1};
  const inputCards = shuffleSelection.map(id=>state.cards.find(c=>c.id===id)).filter(Boolean);
  const sumTier = inputCards.reduce((acc,c)=> acc + (weights[tierOf(c.cost)]||1), 0);
  function pickWeighted(){
    const entries = state.cards.map(c=>{
      const base=(weights[tierOf(c.cost)]||1);
      const bonus = Math.min(2, 1 + sumTier/10);
      return {c, w: base*bonus};
    });
    const total = entries.reduce((a,e)=>a+e.w,0);
    let r = Math.random()*total;
    for(const e of entries){ if((r-=e.w)<=0) return e.c; }
    return entries[entries.length-1].c;
  }
  const win1=pickWeighted(), win2=pickWeighted();
  if(win1) win1.qty=(win1.qty||0)+1;
  if(win2) win2.qty=(win2.qty||0)+1;
  const img1 = `img/${win1.id}.png`, img1b=`img/${win1.id}.jpg`;
  $("#shuffleImg1").src = img1; $("#shuffleImg1").onerror=()=>{ $("#shuffleImg1").src=img1b; };
  shuffleNames.innerHTML=`<div class="badge">${esc(win1.name)}</div> <div class="badge">${esc(win2.name)}</div>`;
  toggleModal(shuffleModal,false); toggleModal(shuffleResultModal,true);
  state.useLog.push({date:new Date().toISOString(), name:`Barajear: âˆ’3 ( + ${win1.name}, ${win2.name})`});
  toast(`ğŸ”€ Barajear â†’ ${win1.name} & ${win2.name}`); scheduleSave(); render();
};

/* ========= Ataques: envÃ­o desde cartas ========= */
const attackColRef = attackCol;

/* ========= Steal inbox & Attack inbox already above ========= */

/* ========= BotÃ³n karma recibido ========= */
$("#karmaBtn").onclick=async()=>{
  if(!currentUser) return;
  if(confirm("Â¿Has recibido un ataque?")){
    state.karma=(state.karma||0)-1; toast("âš¡ Karma âˆ’1"); scheduleSave(); render();
  }
};

/* ========= Mini util para abrir robo desde UI (puedes aÃ±adir botÃ³n si quieres) ========= */
window.openSteal = openSteal;
</script>
</body>
</html>
