<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Randomlock Wobalonga ‚Äî v4.4 (Firestore-only)</title>
<style>
:root{--bg:#0d0f14;--panel:#151922;--edge:rgba(255,255,255,.08);--text:#e7ecf5;--muted:#9aa4b2;--accent:#7c5cff;--good:#22c55e;--bad:#ef4444;--warn:#f59e0b;--br:16px}
*{box-sizing:border-box}html,body{height:100%}
body{margin:0;background:linear-gradient(180deg,#0b0e13,#0d1016);color:var(--text);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu;transition:.2s filter,.2s background}
body.spyMode{filter:hue-rotate(-20deg) saturate(1.1)}
.wrap{max-width:1240px;margin:0 auto;padding:16px}
header{position:sticky;top:0;z-index:50;backdrop-filter:saturate(1.2) blur(10px);background:rgba(13,16,22,.75);border-bottom:1px solid var(--edge)}
header .row{display:flex;gap:12px;align-items:center;flex-wrap:nowrap}
h1.logo{margin:0;font-size:22px;letter-spacing:.3px;display:flex;align-items:center;gap:10px;background:linear-gradient(90deg,#a78bfa,#60a5fa);-webkit-background-clip:text;background-clip:text;color:transparent;text-shadow:0 0 18px rgba(124,92,255,.25)}
.logo .sub{font-size:12px;color:var(--muted);letter-spacing:.5px}
.btn{background:var(--accent);border:none;color:#fff;border-radius:12px;padding:10px 14px;cursor:pointer;transition:.15s}
.btn:hover{transform:translateY(-1px)}.btn.alt{background:#0e121a;border:1px solid var(--edge)}.btn.good{background:var(--good);color:#07240f}.btn.bad{background:var(--bad)}.btn.warn{background:var(--warn);color:#2d1500}
.kpi{font-weight:900;font-size:26px}.mono{font-family:ui-monospace,Menlo,Consolas,monospace}
.grid{display:grid;gap:16px;grid-template-columns:2fr 1fr}@media(max-width:1040px){.grid{grid-template-columns:1fr}}
.card{background:var(--panel);border:1px solid var(--edge);border-radius:var(--br);padding:16px;box-shadow:0 10px 30px rgba(0,0,0,.3)}
.section-title{margin:0 0 12px 0;font-size:18px;display:flex;align-items:center;gap:8px}
.small{font-size:12px;color:var(--muted)}.hr{height:1px;background:var(--edge);margin:12px 0}
input,select{background:#0e121a;color:var(--text);border:1px solid var(--edge);border-radius:12px;padding:10px}
select{min-width:180px}.right{margin-left:auto}.flex{display:flex;gap:10px;align-items:center;flex-wrap:wrap}.spacer{flex:1}
.badge{display:inline-flex;gap:6px;align-items:center;padding:2px 8px;border-radius:999px;background:#0e121a;border:1px solid var(--edge);font-size:12px}
.cards{display:grid;gap:12px;grid-template-columns:repeat(5,minmax(150px,1fr))}
@media(max-width:1200px){.cards{grid-template-columns:repeat(4,minmax(140px,1fr))}}
@media(max-width:900px){.cards{grid-template-columns:repeat(3,minmax(130px,1fr))}}
@media(max-width:640px){.cards{grid-template-columns:repeat(2,minmax(120px,1fr))}}
.cardSlot{position:relative;background:#0e121a;border:1px solid var(--edge);border-radius:14px;padding:10px;display:flex;flex-direction:column;gap:8px;transition:.15s;cursor:pointer;min-height:200px}
.cardSlot:hover{transform:translateY(-2px);box-shadow:0 10px 30px rgba(0,0,0,.25)}
.cardSlot .imgWrap{background:linear-gradient(180deg,#0b0e13,#10141c);border:1px solid var(--edge);border-radius:10px;aspect-ratio:1/1;display:flex;align-items:center;justify-content:center;overflow:hidden}
.cardSlot img{max-width:100%;max-height:100%}.cardSlot .title{font-weight:800;font-size:14px}
.qty{position:absolute;top:8px;right:8px;background:rgba(34,197,94,.15);color:#86efac;border:1px solid rgba(34,197,94,.35);padding:2px 8px;border-radius:999px;font-size:12px;font-weight:800}
.zero{filter:grayscale(1) contrast(.8) opacity(.6)}
.modal{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;padding:20px;z-index:100}
.modal.show{display:flex}
.modal .panel{background:var(--panel);border:1px solid var(--edge);border-radius:18px;max-width:780px;width:100%;padding:16px;display:grid;gap:14px;grid-template-columns:1fr 1fr}
@media(max-width:760px){.modal .panel{grid-template-columns:1fr}}
.modal .bigImg{aspect-ratio:1/1;border:1px solid var(--edge);border-radius:12px;background:#0e121a;display:flex;align-items:center;justify-content:center;overflow:hidden}
.modal h3{margin:0}.modal .closeX{position:absolute;top:8px;right:12px;background:#00000066;border:1px solid var(--edge);color:#fff;border-radius:10px;padding:6px 10px;cursor:pointer}
.wheelBox{background:#0e121a;border:1px solid var(--edge);border-radius:14px;padding:12px}
.slot{height:56px;display:flex;align-items:center;justify-content:center;border:1px dashed var(--edge);border-radius:10px;overflow:hidden}
.slotText{font-weight:800}
.toast{position:fixed;left:50%;bottom:24px;transform:translateX(-50%);background:#0e121a;border:1px solid var(--edge);border-radius:12px;padding:10px 14px;z-index:120;opacity:0;transition:.3s;pointer-events:none}
.toast.show{opacity:1;transform:translateX(-50%) translateY(-6px)}
.gain{color:#86efac}.loss{color:#fecaca}
.readonly{opacity:.82;filter:saturate(.9)}
.tools{position:relative}
.toolsBtn{background:#0e121a;border:1px solid var(--edge);border-radius:12px;padding:10px 14px;cursor:pointer;display:flex;gap:10px;align-items:center;font-size:15px}
.toolsBtn .coinDot{display:inline-flex;align-items:center;gap:8px;padding:4px 10px;border-radius:999px;background:rgba(255,255,255,.08);border:1px solid var(--edge);color:#fff;font-weight:800}
.toolsPanel{position:absolute;right:0;top:44px;min-width:260px;background:#0e121a;border:1px solid var(--edge);border-radius:12px;padding:10px;display:none;z-index:200}
.toolsPanel.show{display:block}.toolsRow{display:flex;justify-content:space-between;align-items:center;gap:10px;margin-bottom:8px}
.spyPill{display:inline-flex;align-items:center;gap:8px;background:#0e121a;border:1px dashed var(--edge);border-radius:999px;padding:6px 10px}
.spyMenu{position:absolute;right:0;top:44px;min-width:260px;background:#0e121a;border:1px solid var(--edge);border-radius:12px;padding:8px;display:none;z-index:210}
.spyMenu.show{display:block}
.spyItem{width:100%;text-align:left;background:transparent;color:var(--text);border:1px solid transparent;padding:8px 10px;border-radius:10px;cursor:pointer}
.spyItem:hover{background:rgba(255,255,255,.06);border-color:var(--edge)}
</style>
</head>
<body>
<header>
  <div class="wrap row">
    <h1 class="logo">Randomlock Wobalonga <span class="sub">‚Ä¢ v4.4 Firestore-only</span></h1>

    <div class="badge" id="whoAmI">Sin sesi√≥n</div>
    <button id="btnGoogle" class="btn good">Entrar con Google</button>
    <button id="btnEmail" class="btn alt">Email/Contrase√±a</button>
    <button id="btnLogout" class="btn warn" style="display:none">Salir</button>

    <div class="tools" id="spyBox" style="display:none;position:relative;">
      <button id="btnSpy" class="btn alt">üëÅÔ∏è Espiar</button>
      <div id="spyMenu" class="spyMenu"></div>
      <div id="spyInfo" style="display:none" class="spyPill">
        Espiando a: <strong id="spyName"></strong> (solo lectura)
        <button id="spyExit" class="btn alt">Volver</button>
      </div>
    </div>

    <div class="spacer"></div>

    <div class="tools" style="display:none;margin-left:auto" id="toolsBox">
      <button id="toolsBtn" class="toolsBtn" title="Herramientas">
        <span class="coinDot">ü™ô <span id="coinsMini">0</span></span> ‚ãØ
      </button>
      <div id="toolsPanel" class="toolsPanel">
        <div class="toolsRow">
          <div><span class="small">Monedas:</span> <span class="kpi mono" id="coins">0</span></div>
          <button id="coinMenuBtn" class="btn alt" style="padding:6px 10px">¬±</button>
        </div>
        <div class="toolsRow">
          <div><span class="small">Karma üòà:</span> <span class="kpi mono" id="karma">0</span></div>
          <button id="karmaBtn" class="btn alt" style="padding:6px 10px">He recibido un ataque</button>
        </div>
        <div class="hr"></div>
        <div class="toolsRow">
          <button id="exportBtn" class="btn alt" style="padding:6px 10px">Exportar</button>
          <label class="btn alt" style="padding:6px 10px">Importar <input id="importFile" type="file" accept="application/json" style="display:none"></label>
          <button id="resetBtn" class="btn warn" style="padding:6px 10px">Reiniciar</button>
        </div>
      </div>
    </div>
  </div>
</header>

<main class="wrap" style="padding-top:18px">
  <div class="grid">
    <section class="card" id="mainSection">
      <div class="section-title">
        üÉè Inventario de cartas
        <span class="small">(clic para ver y comprar/usar)</span>
        <div class="spacer"></div>
        <label class="small" style="display:flex;gap:8px;align-items:center">
          <select id="typeFilter">
            <option value="">Todas las categor√≠as</option>
            <option value="curaci√≥n">Curaci√≥n</option><option value="ataque">Ataque</option>
            <option value="defensa">Defensa</option><option value="econom√≠a">Econom√≠a</option>
            <option value="gacha">Gacha</option><option value="√≠tem">√çtem</option><option value="captura">Captura</option>
          </select>
          <label style="display:flex;gap:6px;align-items:center">
            <input type="checkbox" id="hideZero"/> Ocultar sin tener
          </label>
        </label>
      </div>
      <div id="cardsGrid" class="cards"></div>
    </section>

    <aside class="card">
      <div class="section-title">üé∞ Ruleta</div>
      <div class="wheelBox">
        <div class="small">Incluye <strong>10 monedas</strong> + <strong>Monedero perdido</strong> + 1 legendaria (10/13) + 1 √©pica (7) + 3 de 4 + 4 de 2.</div>
        <div class="hr"></div>
        <div class="slot"><div id="slotText" class="slotText">‚Äî</div></div>
        <div class="flex" style="margin-top:10px">
          <button id="spinPaid" class="btn">Tirar (gasta 1 ‚ÄúRuleta‚Äù)</button>
          <button id="spinFree" class="btn good">Tirada gratis (post-gym)</button>
          <div class="spacer"></div>
          <span class="badge">Tienes ‚ÄúRuleta‚Äù: <span id="ruletaQty">0</span></span>
        </div>
      </div>

      <div class="hr"></div>
      <div class="section-title">üìí Registros</div>
      <details>
        <summary class="flex"><span class="chev">‚ñ∂</span> Historial de monedas</summary>
        <div class="details" style="border:1px dashed var(--edge);border-radius:12px;padding:10px;margin-top:8px">
          <div id="walletLog" class="small"></div>
        </div>
      </details>
      <div class="hr"></div>
      <details>
        <summary class="flex"><span class="chev">‚ñ∂</span> Historial de cartas</summary>
        <div class="details" style="border:1px dashed var(--edge);border-radius:12px;padding:10px;margin-top:8px">
          <div id="useLog" class="small"></div>
        </div>
      </details>
    </aside>
  </div>
  <div class="footer small">Firestore por usuario. Ataques con defensoras y debufos (Maldici√≥n/Regalo). Robos por notificaci√≥n.</div>
</main>

<div id="toast" class="toast"></div>

<!-- Modal Monedas -->
<div id="coinModal" class="modal" aria-hidden="true">
  <div class="panel" role="dialog" aria-label="Ajustar monedas">
    <button class="closeX" id="coinCloseX">Cerrar</button>
    <div style="grid-column:1/-1"><h3>üí∞ Ajustar monedas</h3><div class="small">Enteros. No se permite quedar en negativo.</div></div>
    <div>
      <label class="small">Cantidad</label>
      <input id="coinAmount" type="number" step="1" min="0" placeholder="0"/>
      <label class="small" style="margin-top:8px;display:block">Motivo (opcional)</label>
      <input id="coinReason" type="text" placeholder="p. ej. Recompensa del juego X"/>
    </div>
    <div>
      <label class="small">Acci√≥n</label>
      <div class="flex" style="margin-top:8px">
        <button id="coinAdd" class="btn good">+ Ingreso</button>
        <button id="coinSub" class="btn bad">‚àí Gasto</button>
        <button id="coinClose" class="btn alt right">Cerrar</button>
      </div>
    </div>

    <div style="grid-column:1/-1" class="hr"></div>
    <div>
      <div class="small" style="margin-bottom:6px">Atajos de partida</div>
      <div class="flex">
        <button id="btnLeader" class="btn">üèÜ L√≠der completado</button>
        <button id="btnBoss" class="btn alt">‚öîÔ∏è Combate importante</button>
      </div>
      <div class="small" style="margin-top:6px">L√≠der: +6 (o +9 sin bajas). Importante: +5 (o +7 sin bajas).</div>
    </div>
  </div>
</div>

<!-- Modal Carta -->
<div id="cardModal" class="modal" aria-hidden="true">
  <div class="panel" role="dialog" aria-label="Detalle de carta">
    <button class="closeX" id="cardCloseX">Cerrar</button>
    <div class="bigImg"><img id="cardImgBig" alt="Carta" style="max-width:100%;max-height:100%"></div>
    <div>
      <h3 id="cardTitle">Carta</h3>
      <div class="small" id="cardTypeCost"></div>
      <div id="cardDesc" class="small" style="margin-top:8px"></div>
      <div class="hr"></div>
      <div class="flex">
        <span class="badge">Precio: <span id="cardPrice">0</span> ü™ô</span>
        <span class="badge">Tienes: <span id="cardQty">0</span></span>
      </div>
      <div class="hr"></div>
      <div class="flex">
        <button id="buyBtn" class="btn">Comprar</button>
        <button id="useBtn" class="btn alt">Usar</button>
        <button id="closeCard" class="btn right alt">Cerrar</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal Recompensa ruleta -->
<div id="rewardModal" class="modal" aria-hidden="true">
  <div class="panel" role="dialog" aria-label="Recompensa de ruleta">
    <button class="closeX" id="rewardCloseX">Cerrar</button>
    <div class="bigImg"><img id="rewardImg" alt="Carta ganada" style="max-width:100%;max-height:100%"></div>
    <div>
      <h3 class="rewardTitle">üéâ ¬°Has obtenido <span id="rewardName"></span>!</h3>
      <div class="small" id="rewardMeta"></div>
      <div style="margin-top:8px" id="rewardDesc" class="small"></div>
      <div class="hr"></div>
      <button id="rewardClose" class="btn alt right">Cerrar</button>
    </div>
  </div>
</div>

<!-- Modal Notificaci√≥n de ROBO (v√≠ctima) -->
<div id="inboxModal" class="modal" aria-hidden="true">
  <div class="panel" role="dialog" aria-label="Notificaci√≥n de robo" style="grid-template-columns:1fr">
    <button class="closeX" id="inboxCloseX">Cerrar</button>
    <h3>‚ö†Ô∏è Te han robado una carta</h3>
    <div class="small" id="inboxText">‚Ä¶</div>
    <div id="inboxPreview" class="cards" style="margin-top:10px"></div>
    <div class="hr"></div>
    <div class="flex">
      <button id="inboxApply" class="btn bad">OK (restar de mi inventario)</button>
    </div>
  </div>
</div>

<!-- Modal Notificaci√≥n de ATAQUE (v√≠ctima) -->
<div id="attackModal" class="modal" aria-hidden="true">
  <div class="panel" role="dialog" aria-label="Ataque recibido" style="grid-template-columns:1fr">
    <button class="closeX" id="attackCloseX">Cerrar</button>
    <h3>‚öîÔ∏è ¬°Ataque recibido!</h3>
    <div class="small" id="attackText">‚Ä¶</div>
    <div id="attackPreview" class="cards" style="margin-top:10px"></div>
    <div class="hr"></div>
    <div class="flex" id="defenseButtons">
      <!-- Se rellenan din√°micamente seg√∫n Reversa/Bloqueo/Protecci√≥n disponibles -->
    </div>
  </div>
</div>

<!-- Modal Robo sigiloso (ladr√≥n) -->
<div id="stealModal" class="modal" aria-hidden="true">
  <div class="panel" role="dialog" aria-label="Robo sigiloso" style="grid-template-columns:1fr">
    <button class="closeX" id="stealCloseX">Cerrar</button>
    <h3>üïµÔ∏è‚Äç‚ôÇÔ∏è Robo sigiloso</h3>
    <div class="small">Elige un usuario y UNA carta del inventario del rival. A ti se te suma ahora; al rival se le restar√° cuando pulse OK.</div>
    <div class="flex">
      <select id="stealTarget"><option value="">‚Äî Elegir usuario ‚Äî</option></select>
      <button id="stealLoad" class="btn alt">Ver inventario</button>
    </div>
    <div id="stealGrid" class="cards"></div>
    <div class="hr"></div>
    <div class="flex"><button id="stealConfirm" class="btn" disabled>Robar carta seleccionada</button><div class="spacer"></div><button id="stealCancel" class="btn alt">Cancelar</button></div>
  </div>
</div>

<!-- Modal Barajear cartas -->
<div id="shuffleModal" class="modal" aria-hidden="true">
  <div class="panel" role="dialog" aria-label="Barajear cartas" style="grid-template-columns:1fr">
    <button class="closeX" id="shuffleCloseX">Cerrar</button>
    <h3>üîÄ Barajear cartas</h3>
    <div class="small">Elige <strong>3</strong> cartas (por unidades). Se restar√°n y recibir√°s <strong>2</strong> aleatorias, ponderadas por rarezas.</div>
    <div id="shufflePickGrid" class="cards" style="margin-top:10px"></div>
    <div class="hr"></div>
    <div class="flex">
      <div class="badge">Seleccionadas: <span id="shuffleCount">0</span>/3</div>
      <div class="spacer"></div>
      <button id="shuffleConfirm" class="btn" disabled>Barajar</button>
      <button id="shuffleCancel" class="btn alt">Cancelar</button>
    </div>
  </div>
</div>

<!-- Modal Resultado Barajar -->
<div id="shuffleResultModal" class="modal" aria-hidden="true">
  <div class="panel" role="dialog" aria-label="Resultado barajar">
    <button class="closeX" id="shuffleResultCloseX">Cerrar</button>
    <div class="bigImg"><img id="shuffleImg1" alt="Carta 1" style="max-width:100%;max-height:100%"></div>
    <div>
      <h3>üéÅ Nuevas cartas</h3>
      <div id="shuffleNames" class="small"></div>
      <div class="hr"></div>
      <button id="shuffleResultClose" class="btn alt right">Cerrar</button>
    </div>
  </div>
</div>

<script type="module">
/* ========= Firebase ========= */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
import {
  getAuth, onAuthStateChanged, signInWithPopup, signInWithRedirect, GoogleAuthProvider,
  signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, updateProfile
} from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
import {
  getFirestore, doc, getDoc, setDoc, onSnapshot, enableIndexedDbPersistence,
  collection, query, where, addDoc, updateDoc, serverTimestamp, getDocs
} from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCPhWAShfR33sAuZ2H4Y2BAGnF8wkkv_S0",
  authDomain: "pokerandom-ce300.firebaseapp.com",
  projectId: "pokerandom-ce300",
  storageBucket: "pokerandom-ce300.firebasestorage.app",
  messagingSenderId: "637348459448",
  appId: "1:637348459448:web:4ab19e68bcce734692554d"
};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
enableIndexedDbPersistence(db).catch(()=>{});

/* ========= Helpers ========= */
const $ = s => document.querySelector(s);
const esc = s => String(s).replace(/[&<>"']/g,c=>({"&":"&amp;","<":"&lt;","&gt;":"&gt;","\"":"&quot;","'":"&#039;"}[c]));
const toast = (m)=>{ const t=$("#toast"); t.textContent=m; t.classList.add("show"); setTimeout(()=>t.classList.remove("show"),1800); };
const slugType = t => t.trim().toLowerCase().replace("curacion","curaci√≥n").replace("economia","econom√≠a").replace("item","√≠tem");
const tierOf = c => (c===13||c===10)?"legendaria": c===7?"√©pica": c===4?"rara": c===2?"com√∫n": (c===0||c===99)?"especial":"otra";
const capFirst = s => { if(!s) return ""; let t=s.trim(); t=t.replace(/\bpokemon(es)?\b/gi,m=>m.toLowerCase().endsWith("es")?"Pok√©mones":"Pok√©mon"); t=t.replace(/\busala\b/gi,"√∫sala").replace(/\busa la\b/gi,"√∫sala"); t=t.replace(/\bdeber\b/gi,"deber√°").replace(/\bpage\b/gi,"pague"); return t.charAt(0).toUpperCase()+t.slice(1); };
const randInt = (n)=> Math.floor(Math.random()*n);
const choice = (arr)=> arr[randInt(arr.length)];

/* ========= Datos base ========= */
const rawList = [
  [2,"Curacion","Objeto curativo","permite comprar un objeto curativo de una tienda."],
  [7,"Curacion","Dama curativa","Puedes comprar hasta 5 objetos curativos en la misma tienda."],
  [4,"Gacha","Ruleta","Puedes tirar ruleta en la que obtendr√°s una carta aleatoria."],
  [99,"Ataque","Robo de monedas","Puedes robar 5 monedas a otro jugador en cualquier momento."],
  [0,"economia","Venta ilegal","libera un pokemon y recibe 2 monedas."],
  [10,"economia","10 monedas","recibes 10 monedas al instante."],
  [3,"economia","Monedero perdido","recibes de 1 a 5 monedas aleatorias."],
  [2,"economia","Apuesta","Recibes 3 monedas m√°s si no pierdes pokemon contra el siguiente l√≠der de gimnasio."],
  [10,"captura","Captura shiny","puedes capturar una vez m√°s en ruta y ese pokemon se volver√° shiny."],
  [2,"captura","Skip pokemon","al usarla antes de capturar, puedes decidir si skipear el primer pok√©mon que salga. Esto no contar√° como primer pok√©mon de ruta y p√≠ldoras volver a intentar capturar."],
  [10,"captura","Recaptura","puedes recapturar"],
  [4,"captura","Reroll","puedes usarla tras aparecer el primer pok√©mon y podr√°s skipearlo e ir a por el siguiente."],
  [4,"item","Masterball","obtienes una masterball."],
  [7,"item","Compra MT","√∫sala para poder comprar una MT en una tienda del juego"],
  [10,"item","Capsula habilidad","√∫sala para obtener una c√°psula habilidad."],
  [10,"item","Piedra Evolutiva","√ösala para canjearla por una piedra evolutiva a tu elecci√≥n."],
  [10,"item","MegaPiedra","√ösala para obtener una mega piedra a tu elecci√≥n."],
  [4,"Gacha","Caja sorpresa","Cambia un item por otro random del mismo tipo."],
  [10,"item","Objeto fuerte","obtienes un objeto competitivo a tu elecci√≥n."],
  [10,"Curacion","Revivir Pokemon","revive un pokemon"],
  [10,"Curacion","Revivir Inicial","Revive a tu inicial una vez (no cuenta para el uso de revivir, es decir, p√≠ldoras  revivir a un inicial que haya sido revivido por la carta revivir)"],
  [7,"Curacion","Cambio de inicial","puedes designar a otro pok√©mon vivo de tu elecci√≥n como inicial"],
  [10,"defensa","Reversa","bloqueas y devuelves la carta de ataque del rival"],
  [7,"defensa","Bloqueo","bloquear la carta del rival"],
  [10,"curacion","Bendici√≥n de Arceus","usala antes de un combate y el primer pokemon muerto, no morir√° realmente."],
  [7,"ataque","Robo Curativo","robas 3 objetos curativos a un rival"],
  [4,"ataque","Desgaste","Obligas a un rival a no poder sacar ni meter pokemons antes del siguiente combate contra un l√≠der."],
  [7,"ataque","Liberaci√≥n","escoge dos pokemons del rival y √©l decidir√° uno al que liberar."],
  [10,"ataque","Robo de caja","roba el pok√©mon a tu elecci√≥n de la caja del rival"],
  [13,"ataque","Robo de equipo","roba un pok√©mon aleatorio del equipo del rival"],
  [7,"ataque","bloqueo pokemon","bloquea un pok√©mon rival hasta el siguiente l√≠der (en los combates tambi√©n estaba bloqueado y por tanto no lo podr√° usar)"],
  [7,"ataque","destructor","obligas al rival a jugar con solo 5 pokemons hasta el siguiente l√≠der"],
  [5,"ataque","Mismo destino","tu liberas un pokemon y el rival deber√° liberar otro que comparta uno de los tipos"],
  [4,"ataque","envenenamiento","el rival deber tirar 2 curas de su inventario"],
  [10,"gacha","Prime","si tu pok√©mon elegido con la carta no muere en los combates contra los dem√°s, recibir√° 31 IVS en todo, si lo vuelves a usar, se volver√° shiny"],
  [4,"defensa","Venganza","si te han tirado 2 o m√°s cartas el mismo jugador, puedes tirar de ruleta o robarle un pok√©mon aleatorio de su caja."],
  [4,"gacha","Apuesta Segura","Apuesta que vas a ganar los combates contra los dem√°s jugadores. si Ganas, recibes 15 monedas, si pierdes, debes dar 5 monedas a cada jugador que te gano."],
  [10,"ataque","Cambio repentino","Un pok√©mon de un rival cambiar√° su habilidad al menos que el rival page 15 monedas"],
  [0,"item","Intercambio","Intercambia un pok√©mon con un rival si ambos quieren."],
  [2,"defensa","Regalo","Env√≠as un objeto curativo aleatorio a un rival. A cambio, si te lanza una carta negativa, tendr√°s que devolver el regalo por 3 de su propio inventario."],
  [10,"defensa","Maldici√≥n","Maldices a un rival, si ese jugador tiene 3 de karma negativo o m√°s, puedes robarle una carta a tu elecci√≥n."],
  [7,"Ataque","Robo sigiloso","Robas una carta del rival"],
  [7,"defensa","Buff permanente","subes 8 puntos todos los IVS de un pok√©mon a tu elecci√≥n"],
  [2,"defensa","Protecci√≥n del d√©bil","usa cuando te tiren una carta de ataque, tira una moneda; si sale cara, te proteges y el rival recupera su carta; si sale cruz, recibes el ataque y pierdes esta carta."],
  [4,"gacha","Barajear cartas","Elige 3 cartas de tu inventario; recibes 2 cartas aleatorias ponderadas por rareza."],
  [2,"econom√≠a","Intercambio (monedas)","Intercambia con coste 2 monedas."],
];
const cardsBase = rawList.map((r,i)=>({id:"c"+String(i+1).padStart(2,"0"),cost:+r[0],type:slugType(r[1]),name:r[2].trim(),desc:capFirst(r[3]||""),qty:0}));

/* ========= Estado ========= */
let currentUser=null, spyUid=null, unsubInv=null, unsubProfiles=null, unsubInbox=null, unsubAttackInbox=null, unsubDebuffs=null, unsubGiftAlerts=null;
let profiles=[];
let state={coins:0,karma:0,cards:cardsBase,walletLog:[],useLog:[],updatedAt:null};

/* ========= Refs ========= */
const invRef = uid => doc(db,"inventories",uid);
const profRef = uid => doc(db,"profiles",uid);
const stealCol = collection(db,"stealRequests");
const attackCol = collection(db,"attackRequests");
const debuffCol = collection(db,"debuffs");
const giftAlertCol = collection(db,"giftAlerts"); // avisos de "debes 3 curas"

/* ========= UI comunes ========= */
const coinsEl=$("#coins"), coinsMini=$("#coinsMini"), karmaEl=$("#karma");
// === Exportar / Importar / Reiniciar ===
$("#exportBtn").onclick = ()=>{
  const filename = `wobalonga_${(currentUser?.displayName||currentUser?.email||"anon").replace(/[^a-z0-9_-]/gi,"_")}_${new Date().toISOString().slice(0,10)}.json`;
  const blob = new Blob([JSON.stringify(state,null,2)], {type:"application/json"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = filename;
  a.click();
  setTimeout(()=>URL.revokeObjectURL(a.href), 1000);
};

$("#importFile").onchange = async (e)=>{
  const file = e.target.files?.[0]; if(!file) return;
  try{
    const text = await file.text();
    const data = JSON.parse(text);
    // importamos solo campos conocidos
    state.coins = Math.max(0, Math.trunc(data.coins||0));
    state.karma = Math.trunc(data.karma||0);
    if(Array.isArray(data.cards)){
      // conservamos metadatos (desc, tipo, cost) de las cartas de este build y aplicamos qty del fichero
      const map = new Map(data.cards.map(c=>[c.id, Math.max(0, Math.trunc(c.qty||0))]));
      state.cards.forEach(c=>{ c.qty = map.get(c.id)||0; });
    }
    state.walletLog = Array.isArray(data.walletLog)?data.walletLog:[];
    state.useLog    = Array.isArray(data.useLog)?data.useLog:[];
    toast("üì• Importado");
    scheduleSave(); render();
  }catch(err){ alert("Import inv√°lido"); }
};

$("#resetBtn").onclick = ()=>{
  if(!confirm("¬øSeguro que quieres reiniciar tu inventario?")) return;
  if(!confirm("Mu mal‚Ä¶ esto no tiene deshacer. ¬øConfirmas?")) return;
  state.coins = 0;
  state.karma = 0;
  state.cards.forEach(c=> c.qty = 0);
  state.walletLog = [];
  state.useLog = [];
  toast("üßπ Reiniciado");
  scheduleSave(); render();
};

const gridEl=$("#cardsGrid"), walletLogEl=$("#walletLog"), useLogEl=$("#useLog");
const typeFilter=$("#typeFilter"), hideZero=$("#hideZero");
const toolsBox=$("#toolsBox"), toolsBtn=$("#toolsBtn"), toolsPanel=$("#toolsPanel");
toolsBtn.onclick=(e)=>{e.stopPropagation();toolsPanel.classList.toggle("show")};
document.body.addEventListener("click",()=>toolsPanel.classList.remove("show"));
typeFilter.onchange=render; hideZero.onchange=render;

/* ========= Auth ========= */
const who=$("#whoAmI"), btnGoogle=$("#btnGoogle"), btnEmail=$("#btnEmail"), btnLogout=$("#btnLogout");
btnGoogle.onclick=async()=>{try{const p=new GoogleAuthProvider();p.setCustomParameters({prompt:"select_account"});await signInWithPopup(auth,p)}catch(e){if(e.code==="auth/popup-blocked"||e.code==="auth/popup-closed-by-user"){try{await signInWithRedirect(auth,new GoogleAuthProvider())}catch(e2){alert("Redirect fall√≥: "+e2.code)}}else if(e.code==="auth/unauthorized-domain"){alert("Dominio no autorizado en Firebase.")}else{alert("Error Google: "+e.code)}}};
btnEmail.onclick=async()=>{const email=prompt("Email:");if(!email)return;const pass=prompt("Contrase√±a:");if(!pass)return;try{await signInWithEmailAndPassword(auth,email,pass)}catch(e){if(e.code==="auth/user-not-found"||e.code==="auth/invalid-credential"){if(confirm("No existe ese usuario. ¬øCrear cuenta con ese email?")){try{const cred=await createUserWithEmailAndPassword(auth,email,pass);const name=prompt("Nombre para mostrar (opcional):")||"";if(name)await updateProfile(cred.user,{displayName:name});toast("Cuenta creada ‚úÖ")}catch(e2){alert("Error creando: "+e2.code)}}return}if(e.code==="auth/unauthorized-domain"){alert("Dominio no autorizado en Firebase.");return}alert("Error email/contrase√±a: "+e.code)}};
btnLogout.onclick=()=>signOut(auth);

async function ensureProfile(u){
  const d=await getDoc(profRef(u.uid));
  const payload={displayName:u.displayName||(u.email?u.email.split("@")[0]:"Jugador"),email:u.email||null,updatedAt:serverTimestamp()};
  if(!d.exists()) payload.createdAt=serverTimestamp();
  await setDoc(profRef(u.uid),payload,{merge:true});
}
async function initInventoryIfMissing(uid){
  const d=await getDoc(invRef(uid));
  if(!d.exists()){
    await setDoc(invRef(uid),{coins:0,karma:0,cards:cardsBase,walletLog:[],useLog:[],updatedAt:serverTimestamp()});
  }
}

/* ========= Subs ========= */
function subscribeProfiles(){
  if(unsubProfiles){unsubProfiles();unsubProfiles=null}
  unsubProfiles=onSnapshot(collection(db,"profiles"),(snap)=>{
    profiles=snap.docs.map(d=>({id:d.id,...d.data()}));
    renderSpyMenu();
    // robo select
    const me=currentUser?.uid;
    const opts=['<option value="">‚Äî Elegir usuario ‚Äî</option>'].concat(
      profiles.filter(p=>p.id!==me).map(p=>`<option value="${p.id}">${esc(p.displayName||p.email||p.id)}</option>`)
    );
    const tsel=$("#stealTarget"); if(tsel) tsel.innerHTML=opts.join("");
  });
}
function subscribeInventory(uid){
  if(unsubInv){unsubInv();unsubInv=null}
  unsubInv=onSnapshot(invRef(uid),(snap)=>{ if(!snap.exists())return; state=snap.data()||state; render(); });
}
function subscribeInbox(uid){ // robos donde YO soy v√≠ctima
  if(unsubInbox){unsubInbox();unsubInbox=null}
  const qv=query(stealCol, where("victimId","==",uid), where("status","==","pending"));
  unsubInbox=onSnapshot(qv,(snap)=>{ const docs=snap.docs; if(!docs.length) return; showStealInbox(docs[0].id, docs[0].data()); });
}
function subscribeAttackInbox(uid){ // ataques donde YO soy v√≠ctima
  if(unsubAttackInbox){unsubAttackInbox();unsubAttackInbox=null}
  const qv=query(attackCol, where("victimId","==",uid), where("status","==","pending"));
  unsubAttackInbox=onSnapshot(qv,(snap)=>{ const docs=snap.docs; if(!docs.length) return; showAttackInbox(docs[0].id, docs[0].data()); });
}
function subscribeDebuffs(uid){
  if(unsubDebuffs){unsubDebuffs();unsubDebuffs=null}
  const qv=query(debuffCol, where("targetId","==",uid), where("active","==",true));
  unsubDebuffs=onSnapshot(qv,()=>{ render(); }); // solo para re-render badges (lo usamos en header de inventario si quisieras)
}
function subscribeGiftAlerts(uid){
  if(unsubGiftAlerts){unsubGiftAlerts();unsubGiftAlerts=null}
  const qv=query(giftAlertCol, where("receiverId","==",uid), where("status","==","pending"));
  unsubGiftAlerts=onSnapshot(qv,(snap)=>{
    const d=snap.docs[0]; if(!d) return;
    alert(`üì¶ Debes 3 objetos curativos a ${d.data().creditorName||d.data().creditorId} por ‚ÄúRegalo‚Äù.`);
    updateDoc(doc(db,"giftAlerts", d.id), {status:"shown", shownAt: serverTimestamp()});
  });
}

/* ========= Guardado ========= */
let saveTimer=null;
function scheduleSave(){ if(spyUid||!currentUser) return; clearTimeout(saveTimer); saveTimer=setTimeout(()=>saveNow().catch(()=>{}),350); }
async function saveNow(){ await setDoc(invRef(currentUser.uid), {...state, updatedAt:serverTimestamp()}, {merge:true}); }

/* ========= Render ========= */
function render(){
  document.body.classList.toggle("spyMode", !!spyUid);
  $("#mainSection").classList.toggle("readonly", !!spyUid);
  coinsEl.textContent=String(state.coins||0);
  coinsMini.textContent=String(state.coins||0);
  karmaEl.textContent=String(state.karma||0);

  gridEl.innerHTML="";
  const f=(typeFilter.value||"").trim(), hide=hideZero.checked;
  state.cards.forEach(card=>{
    if(spyUid && (card.qty||0)<=0) return; // espiar: solo las que tiene
    if(f && card.type!==f) return; if(hide && (card.qty||0)<=0) return;
    const slot=document.createElement("div"); slot.className="cardSlot"+((card.qty||0)<=0?" zero":""); slot.dataset.id=card.id;
    const imgWrap=document.createElement("div"); imgWrap.className="imgWrap";
    const img=document.createElement("img"); img.alt=card.name; img.src=`img/${card.id}.png`; img.onerror=()=>{ if(!img.dataset.tryJ){ img.dataset.tryJ=1; img.src=`img/${card.id}.jpg`; } };
    imgWrap.appendChild(img);
    const title=document.createElement("div"); title.className="title"; title.textContent=card.name;
    const meta=document.createElement("div"); meta.className="small"; meta.innerHTML=`<span class="badge">${esc(card.type)}</span> ¬∑ <span class="badge">${card.cost} ü™ô ¬∑ ${esc(tierOf(card.cost))}</span>`;
    if(card.qty>0){ const qty=document.createElement("div"); qty.className="qty"; qty.textContent="√ó "+card.qty; slot.appendChild(qty); }
    slot.appendChild(imgWrap); slot.appendChild(title); slot.appendChild(meta);
    slot.onclick=()=> openCard(card.id);
    gridEl.appendChild(slot);
  });

  walletLogEl.innerHTML=(state.walletLog||[]).slice().reverse().map(l=>{
    const gain=l.type==="ingreso"; const cls=gain?"gain":"loss"; const sign=gain?"+":"‚àí";
    const note=l.note?` ‚Äî <span class="small">${esc(l.note)}</span>`:"";
    return `<div class="${cls}"><span class="small">${new Date(l.date).toLocaleString()}</span> ¬∑ <strong>${esc(l.type)}</strong> ¬∑ <span class="mono">${sign} ${Math.trunc(l.amount)}</span>${note}</div>`;
  }).join("");
  useLogEl.innerHTML=(state.useLog||[]).slice().reverse().map(u=>{
    const gain=/Compraste|Ganaste por ruleta|A√±adida|a√±adida|\(\+1\)|pendiente/i.test(u.name);
    const cls=gain?"gain":"loss";
    const note=u.note?` ‚Äî <span class="small">${esc(u.note)}</span>`:"";
    return `<div class="${cls}"><span class="small">${new Date(u.date).toLocaleString()}</span> ¬∑ ${esc(u.name)}${note}</div>`;
  }).join("");

  const r=state.cards.find(c=>c.name.toLowerCase()==="ruleta"); $("#ruletaQty").textContent=r?(r.qty||0):0;
}

/* ========= Header extra ========= */
$("#karmaBtn").onclick=async()=>{
  if(!currentUser) return;
  if(confirm("¬øHas recibido un ataque?")){
    state.karma=(state.karma||0)-1; toast("‚ö° Karma reducido (ataque recibido)"); scheduleSave(); render();
  }
};

/* ========= Modales comunes ========= */
const modals=[$("#coinModal"),$("#cardModal"),$("#rewardModal"),$("#stealModal"),$("#inboxModal"),$("#shuffleModal"),$("#shuffleResultModal"),$("#attackModal")];
function toggleModal(el,show){el.classList.toggle("show",!!show);el.setAttribute("aria-hidden",show?"false":"true")}
modals.forEach(m=>m.addEventListener("click",(e)=>{if(e.target===m)toggleModal(m,false)}));
window.addEventListener("keydown",(e)=>{if(e.key==="Escape"){modals.forEach(m=>toggleModal(m,false))}});

/* ========= Monedero ========= */
$("#coinMenuBtn").onclick=()=>toggleModal($("#coinModal"),true);
$("#coinClose").onclick=()=>toggleModal($("#coinModal"),false);
$("#coinCloseX").onclick=()=>toggleModal($("#coinModal"),false);
$("#coinAdd").onclick=()=>coinOp("ingreso");
$("#coinSub").onclick=()=>coinOp("gasto");
$("#btnLeader").onclick=quickLeader;
$("#btnBoss").onclick=quickBoss;
function coinOp(kind){
  if(spyUid||!currentUser) return;
  const amt=Math.max(0,Math.trunc(Number($("#coinAmount").value))); if(!amt){alert("Cantidad inv√°lida");return}
  const note=($("#coinReason").value||"").trim();
  if(kind==="ingreso"){state.coins+=amt;toast(`ü™ô +${amt} monedas`)}
  else{ if(state.coins<amt){alert("No tienes suficientes monedas");return} state.coins-=amt;toast(`üí∏ -${amt} monedas`)}
  state.walletLog.push({date:new Date().toISOString(),type:kind,amount:amt,note});
  $("#coinAmount").value="";$("#coinReason").value="";
  scheduleSave(); toggleModal($("#coinModal"),false); render();
}
function quickLeader(){ if(spyUid||!currentUser)return; const lost=confirm("¬øHas perdido alg√∫n Pok√©mon contra el l√≠der?\nAceptar = S√ç ¬∑ Cancelar = NO"); const total=lost?6:9; state.coins+=total; toast(`üèÜ +${total} monedas (${lost?"con":"sin"} bajas)`); state.walletLog.push({date:new Date().toISOString(),type:"ingreso",amount:total,note:`L√≠der completado (${lost?"con":"sin"} bajas)`}); scheduleSave(); render();}
function quickBoss(){ if(spyUid||!currentUser)return; const lost=confirm("¬øHas perdido alg√∫n Pok√©mon en el combate importante?\nAceptar = S√ç ¬∑ Cancelar = NO"); const total=lost?5:7; state.coins+=total; toast(`‚öîÔ∏è +${total} monedas (${lost?"con":"sin"} bajas)`); state.walletLog.push({date:new Date().toISOString(),type:"ingreso",amount:total,note:`Combate importante (${lost?"con":"sin"} bajas)`}); scheduleSave(); render(); }

/* ========= Carta modal ========= */
const cardModal=$("#cardModal");
$("#closeCard").onclick=()=>toggleModal(cardModal,false);
$("#cardCloseX").onclick=()=>toggleModal(cardModal,false);
let currentCardId=null;
$("#buyBtn").onclick=onBuy; $("#useBtn").onclick=onUse;

function openCard(id){
  currentCardId=id; const c=state.cards.find(x=>x.id===id); if(!c)return;
  const big=$("#cardImgBig"); big.removeAttribute("data-tried"); big.onerror=null;
  big.src=`img/${c.id}.png`; big.onerror=()=>{ if(!big.dataset.tried){big.dataset.tried=1; big.src=`img/${c.id}.jpg`;} };
  $("#cardTitle").textContent=c.name;
  $("#cardTypeCost").innerHTML=`<span class="badge">${esc(c.type)}</span> ¬∑ <span class="badge">${c.cost} ü™ô ¬∑ ${esc(tierOf(c.cost))}</span>`;
  $("#cardDesc").textContent=c.desc||"";
  $("#cardPrice").textContent=Math.trunc(c.cost||0);
  $("#cardQty").textContent=Math.trunc(c.qty||0);
  $("#useBtn").disabled=(c.qty||0)<=0 || !!spyUid || !currentUser;
  $("#buyBtn").disabled=!!spyUid || !currentUser;
  toggleModal(cardModal,true);
}

function onBuy(){
  if(spyUid||!currentUser)return;
  const c=state.cards.find(x=>x.id===currentCardId); if(!c)return;
  const price=Math.trunc(c.cost||0);
  if(c.name.toLowerCase().startsWith("intercambio") && price<2){ // fuerza coste 2 al ‚ÄúIntercambio‚Äù
    c.cost = 2;
  }
  if(state.coins<price){alert("No tienes suficientes monedas para comprar esta carta.");return}
  state.coins-=price; c.qty=(c.qty||0)+1;
  state.walletLog.push({date:new Date().toISOString(),type:"gasto",amount:price,note:`Compra: ${c.name}`});
  state.useLog.push({date:new Date().toISOString(),cardId:c.id,name:`Compraste ${c.name} (+1)`,note:"Compra"});
  toast(`üõí Compraste ${c.name} (+1)`); scheduleSave(); render(); openCard(c.id);
}

/* ========= Utilidades cartas ========= */
function findCardByName(name){ return state.cards.find(c=>c.name.toLowerCase()===name.toLowerCase()); }
function addCoins(amount,note){ state.coins+=amount; state.walletLog.push({date:new Date().toISOString(),type:"ingreso",amount,note}); }

/* ========= Robo sigiloso (por notificaci√≥n) ========= */
const stealModal=$("#stealModal"), stealTarget=$("#stealTarget"), stealLoad=$("#stealLoad"), stealGrid=$("#stealGrid");
const stealConfirm=$("#stealConfirm"), stealCancel=$("#stealCancel"), stealCloseX=$("#stealCloseX");
let stealSelectedCardId=null, stealSelectedCardName=null, victimSnapshot=null;
stealCancel.onclick=()=>toggleModal(stealModal,false);
stealCloseX.onclick=()=>toggleModal(stealModal,false);

/* ========= Barajear cartas ========= */
const shuffleModal=$("#shuffleModal"), shufflePickGrid=$("#shufflePickGrid"), shuffleCount=$("#shuffleCount"), shuffleConfirm=$("#shuffleConfirm"), shuffleCancel=$("#shuffleCancel");
const shuffleResultModal=$("#shuffleResultModal"), shuffleResultClose=$("#shuffleResultClose"), shuffleResultCloseX=$("#shuffleResultCloseX"), shuffleImg1=$("#shuffleImg1"), shuffleNames=$("#shuffleNames");
let shuffleSelection=[];

shuffleCancel.onclick=()=>toggleModal(shuffleModal,false);
shuffleResultClose.onclick=()=>toggleModal(shuffleResultModal,false);
shuffleResultCloseX.onclick=()=>toggleModal(shuffleResultModal,false);

function openShufflePicker(){
  shuffleSelection=[]; shuffleCount.textContent="0"; shufflePickGrid.innerHTML="";
  state.cards.forEach(c=>{
    if((c.qty||0)<=0) return;
    // Mostrar una "unidad clickable" por cada qty:
    for(let i=0;i<c.qty;i++){
      const slot=document.createElement("div"); slot.className="cardSlot"; slot.dataset.id=c.id;
      const imgWrap=document.createElement("div"); imgWrap.className="imgWrap";
      const img=document.createElement("img"); img.alt=c.name; img.src=`img/${c.id}.png`; img.onerror=()=>{ if(!img.dataset.tryJ){ img.dataset.tryJ=1; img.src=`img/${c.id}.jpg`; } };
      imgWrap.appendChild(img);
      const title=document.createElement("div"); title.className="title"; title.textContent=c.name+" (u)";
      const meta=document.createElement("div"); meta.className="small"; meta.innerHTML=`<span class="badge">${esc(c.type)}</span> ¬∑ <span class="badge">${c.cost} ü™ô</span>`;
      slot.onclick=()=>{
        if(slot.classList.contains("picked")){ // deseleccionar
          slot.classList.remove("picked");
          const idx=shuffleSelection.indexOf(c.id); if(idx>=0) shuffleSelection.splice(idx,1);
        }else{
          if(shuffleSelection.length>=3) return;
          slot.classList.add("picked");
          shuffleSelection.push(c.id);
        }
        shuffleCount.textContent=String(shuffleSelection.length);
        shuffleConfirm.disabled = shuffleSelection.length!==3;
      };
      shufflePickGrid.appendChild(slot);
    }
  });
  toggleModal(shuffleModal,true);
}

shuffleConfirm.onclick=()=>{
  if(shuffleSelection.length!==3) return;
  // Restar 3 seleccionadas (por id)
  shuffleSelection.forEach(id=>{
    const c=state.cards.find(x=>x.id===id);
    if(c && c.qty>0) c.qty -= 1;
  });

  // Ponderaci√≥n por rareza (3 seleccionadas)
  const selectedCards = shuffleSelection.map(id=>state.cards.find(c=>c.id===id)).filter(Boolean);
  const weights = {legendaria:5, √©pica:3, rara:2, com√∫n:1, especial:1, otra:1};
  const sumTier = selectedCards.reduce((acc,c)=> acc + (weights[tierOf(c.cost)]||1), 0);
  function pickWeighted(){
    let pool = state.cards.filter(c=>true);
    // Asignar peso por propia rareza + bonus proporcional al input
    const entries = pool.map(c=>{
      const base=(weights[tierOf(c.cost)]||1);
      // bonus m√°ximo 2x seg√∫n sumTier
      const bonus = Math.min(2, 1 + sumTier/10);
      return {c, w: base*bonus};
    });
    const total = entries.reduce((a,e)=>a+e.w,0);
    let r = Math.random()*total;
    for(const e of entries){ if((r-=e.w)<=0) return e.c; }
    return entries[entries.length-1].c;
  }
  const win1=pickWeighted(), win2=pickWeighted();
  if(win1) win1.qty=(win1.qty||0)+1;
  if(win2) win2.qty=(win2.qty||0)+1;

  // Mostrar resultado
  shuffleImg1.src=`img/${win1.id}.png`; shuffleImg1.onerror=()=>{ shuffleImg1.src=`img/${win1.id}.jpg`; };
  shuffleNames.innerHTML=`<div class="badge">${esc(win1.name)}</div> <div class="badge">${esc(win2.name)}</div>`;
  toggleModal(shuffleModal,false);
  toggleModal(shuffleResultModal,true);

  state.useLog.push({date:new Date().toISOString(), name:`Barajear: ‚àí3 ( + ${win1.name}, ${win2.name})`});
  toast(`üîÄ Barajear ‚Üí ${win1.name} & ${win2.name}`);
  scheduleSave(); render();
};

/* ========= Robos (v√≠ctima) ========= */
const inboxModal=$("#inboxModal"), inboxText=$("#inboxText"), inboxPreview=$("#inboxPreview");
const inboxApply=$("#inboxApply"), inboxCloseX=$("#inboxCloseX");
let currentInboxId=null, currentInboxData=null;
inboxCloseX.onclick=()=>toggleModal(inboxModal,false);
function showStealInbox(docId, data){
  currentInboxId=docId; currentInboxData=data;
  const attacker=data.attackerName||data.attackerId;
  inboxText.innerHTML = `<strong>${esc(attacker)}</strong> te ha robado <strong>${esc(data.cardName || "una carta")}</strong>. Pulsa OK para restar 1 de tu inventario.`;
  inboxPreview.innerHTML="";
  const vc=state.cards.find(c=>c.id===data.cardId);
  const block=document.createElement("div"); block.className="cardSlot";
  const imgWrap=document.createElement("div"); imgWrap.className="imgWrap";
  const img=document.createElement("img"); img.alt=vc?.name||data.cardName; img.src=`img/${data.cardId}.png`; img.onerror=()=>{ if(!img.dataset.tryJ){ img.dataset.tryJ=1; img.src=`img/${data.cardId}.jpg`; } };
  imgWrap.appendChild(img);
  const title=document.createElement("div"); title.className="title"; title.textContent=vc?.name||data.cardName||"Carta";
  const meta=document.createElement("div"); meta.className="small"; meta.innerHTML=`<span class="badge">${esc(vc?.type||"")}</span> ¬∑ <span class="badge">${vc?.cost||"?"} ü™ô</span>`;
  const qty=document.createElement("div"); qty.className="qty"; qty.textContent="√ó "+(vc?.qty||0); block.appendChild(qty);
  block.appendChild(imgWrap); block.appendChild(title); block.appendChild(meta);
  inboxPreview.appendChild(block);
  toggleModal(inboxModal,true);
}
let stealingOnce=false;
inboxApply.onclick=async()=>{
  if(stealingOnce) return; stealingOnce=true; // evita dobles clics
  try{
    if(!currentInboxId||!currentInboxData){toggleModal(inboxModal,false);return}
    const cid=currentInboxData.cardId, cname=currentInboxData.cardName||"Carta";
    const vc=state.cards.find(c=>c.id===cid);
    if(vc && (vc.qty||0)>0){
      vc.qty -= 1;
      state.useLog.push({date:new Date().toISOString(),cardId:cid,name:`Te robaron ${cname} (‚àí1)`,note:`Por ${currentInboxData.attackerName||currentInboxData.attackerId}`});
      toast(`üîª -1 ${cname}`);
      scheduleSave(); render();
    }else{
      toast("No ten√≠as esa carta disponible. No se resta.");
    }
    await updateDoc(doc(db,"stealRequests",currentInboxId),{status:"applied",appliedAt:serverTimestamp()});
    toggleModal(inboxModal,false);
    currentInboxId=null; currentInboxData=null;
  }finally{
    setTimeout(()=>{ stealingOnce=false; }, 600);
  }
};

/* ========= Ataques (v√≠ctima) ========= */
const attackModal=$("#attackModal"), attackText=$("#attackText"), attackPreview=$("#attackPreview"), defenseButtons=$("#defenseButtons"), attackCloseX=$("#attackCloseX");
attackCloseX.onclick=()=>toggleModal(attackModal,false);
let currentAttackId=null, currentAttackData=null;

async function showAttackInbox(docId, data){
  currentAttackId=docId; currentAttackData=data;

  const attacker=data.attackerName||data.attackerId;
  attackText.innerHTML=`<strong>${esc(attacker)}</strong> te ha atacado con <strong>${esc(data.cardName)}</strong>.`;
  attackPreview.innerHTML="";
  const vc = state.cards.find(c=>c.name.toLowerCase()===data.cardName.toLowerCase());
  const block=document.createElement("div"); block.className="cardSlot";
  const imgWrap=document.createElement("div"); imgWrap.className="imgWrap";
  const img=document.createElement("img"); img.alt=data.cardName; img.src=`img/${vc?.id||"c01"}.png`; img.onerror=()=>{ if(!img.dataset.tryJ){ img.dataset.tryJ=1; img.src=`img/${vc?.id||"c01"}.jpg`; } };
  imgWrap.appendChild(img);
  const title=document.createElement("div"); title.className="title"; title.textContent=data.cardName;
  block.appendChild(imgWrap); block.appendChild(title);
  attackPreview.appendChild(block);

  // ‚Äî‚Äî‚Äî Cargar inventario real del usuario (no confiar en state por si no est√° a√∫n)
  let myInv;
  try{
    const snap = await getDoc(invRef(currentUser.uid));
    myInv = snap.exists()? snap.data(): state;
  }catch{ myInv = state; }

  const qtyOf = (name)=> (myInv.cards.find(c=>c.name.toLowerCase()===name.toLowerCase())?.qty||0);

  defenseButtons.innerHTML="";
  const hasReversa = qtyOf("Reversa")>0;
  const hasBloqueo = qtyOf("Bloqueo")>0;
  const hasProtec = qtyOf("Protecci√≥n del d√©bil")>0;

  // Bot√≥n "aceptar ataque"
  const okBtn = document.createElement("button"); okBtn.className="btn bad"; okBtn.textContent="OK (recibir ataque)";
  okBtn.onclick = async ()=>{
    state.karma=(state.karma||0)-1;
    await updateDoc(doc(db,"attackRequests",currentAttackId), {status:"applied", resolvedAt: serverTimestamp()});
    toast("‚ö° Ataque recibido: karma ‚àí1");
    scheduleSave(); render();
    toggleModal(attackModal,false);
  };
  defenseButtons.appendChild(okBtn);

  // Reversa
  if(hasReversa){
    const b=document.createElement("button"); b.className="btn alt"; b.textContent="Usar Reversa";
    b.onclick=async()=>{
      const c=findCardByName("Reversa"); if(c&&c.qty>0) c.qty-=1;
      await updateDoc(doc(db,"attackRequests",currentAttackId), {status:"defended", defenseUsed:"reversa", resolvedAt: serverTimestamp()});
      state.useLog.push({date:new Date().toISOString(), name:"Usaste Reversa (‚àí1)"});
      toast("üõ°Ô∏è Reversa usada. Sin penalizaci√≥n de karma.");
      scheduleSave(); render(); toggleModal(attackModal,false);
    };
    defenseButtons.appendChild(b);
  }

  // Bloqueo
  if(hasBloqueo){
    const b=document.createElement("button"); b.className="btn alt"; b.textContent="Usar Bloqueo";
    b.onclick=async()=>{
      const c=findCardByName("Bloqueo"); if(c&&c.qty>0) c.qty-=1;
      await updateDoc(doc(db,"attackRequests",currentAttackId), {status:"defended", defenseUsed:"bloqueo", resolvedAt: serverTimestamp()});
      state.useLog.push({date:new Date().toISOString(), name:"Usaste Bloqueo (‚àí1)"});
      toast("üõ°Ô∏è Bloqueo usado. Sin penalizaci√≥n de karma.");
      scheduleSave(); render(); toggleModal(attackModal,false);
    };
    defenseButtons.appendChild(b);
  }

  // Protecci√≥n del d√©bil (50/50)
  if(hasProtec){
    const b=document.createElement("button"); b.className="btn alt"; b.textContent="Usar Protecci√≥n del d√©bil (50%)";
    b.onclick=async()=>{
      const c=findCardByName("Protecci√≥n del d√©bil"); if(!(c&&c.qty>0)) return;
      const cara = Math.random()<0.5;
      if(cara){
        await updateDoc(doc(db,"attackRequests",currentAttackId), {status:"protected_success_refund", defenseUsed:"proteccion", coin:"cara", resolvedAt: serverTimestamp()});
        toast("ü™ô ¬°Cara! Te proteges, rival recupera su carta. Sin karma ‚àí1.");
      }else{
        c.qty -= 1;
        state.karma=(state.karma||0)-1;
        await updateDoc(doc(db,"attackRequests",currentAttackId), {status:"protected_fail", defenseUsed:"proteccion", coin:"cruz", resolvedAt: serverTimestamp()});
        toast("ü™ô Cruz. Pierdes la carta y recibes el ataque (karma ‚àí1).");
      }
      scheduleSave(); render(); toggleModal(attackModal,false);
    };
    defenseButtons.appendChild(b);
  }

  toggleModal(attackModal,true);
}

/* ========= Espiar ========= */
const btnSpy=$("#btnSpy"), spyMenu=$("#spyMenu"), spyInfo=$("#spyInfo"), spyName=$("#spyName"), spyExit=$("#spyExit");
function renderSpyMenu(){
  const me=currentUser?.uid;
  const items=profiles.filter(p=>p.id!==me).map(p=>`<button class="spyItem" data-uid="${p.id}">${esc(p.displayName||p.email||p.id)}</button>`);
  $("#spyMenu").innerHTML=items.length?items.join(""):'<div class="small">No hay otros usuarios a√∫n.</div>';
}
btnSpy.onclick=(e)=>{e.stopPropagation();renderSpyMenu();$("#spyMenu").classList.toggle("show")};
document.body.addEventListener("click",()=>$("#spyMenu").classList.remove("show"));
$("#spyMenu").addEventListener("click",(e)=>{
  const btn=e.target.closest(".spyItem"); if(!btn)return;
  const uid=btn.getAttribute("data-uid"); $("#spyMenu").classList.remove("show"); if(!uid)return;
  spyUid=uid; $("#spyInfo").style.display="inline-flex";
  const profile=profiles.find(p=>p.id===uid); $("#spyName").textContent=profile?.displayName||profile?.email||uid;
  subscribeInventory(uid);
});
spyExit.onclick=()=>{spyUid=null;$("#spyInfo").style.display="none";if(currentUser)subscribeInventory(currentUser.uid)};

/* ========= Auth state ========= */
onAuthStateChanged(auth, async (u)=>{
  if(u){
    currentUser=u;
    who.innerHTML=`Conectado como <strong>${esc(u.displayName||u.email||u.uid)}</strong>`;
    btnGoogle.style.display="none"; btnEmail.style.display="none"; btnLogout.style.display="inline-block";
    toolsBox.style.display="block"; $("#spyBox").style.display="block";
    await ensureProfile(u); await initInventoryIfMissing(u.uid);
    spyUid=null; $("#spyInfo").style.display="none";
    subscribeInventory(u.uid);
    subscribeProfiles();
    subscribeInbox(u.uid);
    subscribeAttackInbox(u.uid);
    subscribeDebuffs(u.uid);
    subscribeGiftAlerts(u.uid);
  }else{
    currentUser=null; spyUid=null;
    who.textContent="Sin sesi√≥n";
    btnGoogle.style.display="inline-block"; btnEmail.style.display="inline-block"; btnLogout.style.display="none";
    toolsBox.style.display="none"; $("#spyBox").style.display="none";
    if(unsubInv){unsubInv();unsubInv=null} if(unsubProfiles){unsubProfiles();unsubProfiles=null}
    if(unsubInbox){unsubInbox();unsubInbox=null} if(unsubAttackInbox){unsubAttackInbox();unsubAttackInbox=null}
    if(unsubDebuffs){unsubDebuffs();unsubDebuffs=null} if(unsubGiftAlerts){unsubGiftAlerts();unsubGiftAlerts=null}
    state={coins:0,karma:0,cards:cardsBase,walletLog:[],useLog:[]}; render();
  }
});

/* ========= USAR carta ========= */
async function onUse(){
  if(spyUid||!currentUser)return;
  const c=state.cards.find(x=>x.id===currentCardId); if(!c)return;
  if((c.qty||0)<=0){alert("No tienes esta carta.");return}

  // Flujos especiales
  const nm=c.name.toLowerCase();

  // --- Robo sigiloso: UI de robo por notificaci√≥n
  if(nm==="robo sigiloso"){
    stealSelectedCardId=null; stealSelectedCardName=null; victimSnapshot=null;
    stealGrid.innerHTML=""; stealConfirm.disabled=true; toggleModal(stealModal,true);

    stealLoad.onclick=async()=>{
      const uid=$("#stealTarget").value; if(!uid){alert("Elige un usuario.");return}
      const d=await getDoc(invRef(uid)); if(!d.exists()){alert("El objetivo no tiene inventario inicializado.");return}
      victimSnapshot=d.data(); stealGrid.innerHTML="";
      victimSnapshot.cards.forEach(vc=>{
        if((vc.qty||0)<=0) return;
        const slot=document.createElement("div"); slot.className="cardSlot"; slot.dataset.id=vc.id;
        const imgWrap=document.createElement("div"); imgWrap.className="imgWrap";
        const img=document.createElement("img"); img.alt=vc.name; img.src=`img/${vc.id}.png`; img.onerror=()=>{ if(!img.dataset.tryJ){ img.dataset.tryJ=1; img.src=`img/${vc.id}.jpg`; } };
        imgWrap.appendChild(img);
        const title=document.createElement("div"); title.className="title"; title.textContent=vc.name;
        const meta=document.createElement("div"); meta.className="small"; meta.innerHTML=`<span class="badge">${esc(vc.type)}</span> ¬∑ <span class="badge">${vc.cost} ü™ô</span>`;
        const qty=document.createElement("div"); qty.className="qty"; qty.textContent="√ó "+vc.qty; slot.appendChild(qty);
        slot.appendChild(imgWrap); slot.appendChild(title); slot.appendChild(meta);
        slot.onclick=()=>{ [...stealGrid.children].forEach(ch=>ch.style.outline="none"); slot.style.outline="2px solid #7c5cff"; stealSelectedCardId=vc.id; stealSelectedCardName=vc.name; stealConfirm.disabled=false; };
        stealGrid.appendChild(slot);
      });
      if(!stealGrid.children.length){stealGrid.innerHTML='<div class="small">Este jugador no tiene cartas disponibles para robar.</div>';stealConfirm.disabled=true}
    };

    stealConfirm.onclick=async()=>{
      const victimId=$("#stealTarget").value; if(!victimId||!stealSelectedCardId)return;
      // Gastas tu "Robo sigiloso"
      c.qty -= 1;
      state.useLog.push({date:new Date().toISOString(), name:`Usaste ${c.name} (‚àí1)`});
      // Te sumas la robada ya
      const myCard=state.cards.find(x=>x.id===stealSelectedCardId); if(myCard){ myCard.qty=(myCard.qty||0)+1; }
      state.karma=(state.karma||0)+1;
      state.useLog.push({date:new Date().toISOString(), name:`Robaste ${stealSelectedCardName} (+1) (pendiente)`, note:`A ${profiles.find(p=>p.id===victimId)?.displayName||victimId}`});
      toast(`üïµÔ∏è Robaste ${stealSelectedCardName} (+1)`);

      await addDoc(stealCol,{
  attackerId: currentUser.uid,
  attackerName: currentUser.displayName||currentUser.email||currentUser.uid,
  victimId,
  victimName: profiles.find(p=>p.id===victimId)?.displayName||null,
  cardId: stealSelectedCardId,
  cardName: stealSelectedCardName,   // ‚Üê ESTO IMPORTA
  status: "pending",
  createdAt: serverTimestamp()
});

      scheduleSave(); render(); toggleModal(stealModal,false); toggleModal(cardModal,false);
    };
    return;
  }

  // --- Barajear cartas
  if(nm==="barajear cartas"){
    toggleModal(cardModal,false);
    openShufflePicker();
    return;
  }

  // --- Regalo: aplicar debuff gift (giver=currentUser, receiver=seleccionado)
  if(nm==="regalo"){
    const victimId = prompt("¬øA qu√© usuario env√≠as el Regalo? (escribe exacto como en lista de perfiles)");
    if(!victimId) return;
    // buscar por nombre visible
    const pr = profiles.find(p=> (p.displayName||p.email||p.id)===victimId) || profiles.find(p=>p.id===victimId);
    if(!pr){ alert("Usuario no encontrado."); return; }
    c.qty -= 1;
    await addDoc(debuffCol, { type:"gift", active:true, giverId: currentUser.uid, giverName: currentUser.displayName||currentUser.email||currentUser.uid, receiverId: pr.id, receiverName: pr.displayName||pr.email||pr.id, targetId: pr.id, createdAt: serverTimestamp() });
    state.useLog.push({date:new Date().toISOString(), name:`Usaste Regalo ‚Üí ${pr.displayName||pr.email||pr.id}`});
    toast("üéÅ Regalo aplicado");
    scheduleSave(); render(); toggleModal(cardModal,false);
    return;
  }

  // --- Maldici√≥n: debuff + si karma de v√≠ctima ‚â§ ‚àí3 ‚áí robo
  if(nm==="maldici√≥n" || nm==="maldicion"){
    const victimId = prompt("¬øA qui√©n maldices? (nombre o uid)");
    if(!victimId) return;
    const pr = profiles.find(p=> (p.displayName||p.email||p.id)===victimId) || profiles.find(p=>p.id===victimId);
    if(!pr){ alert("Usuario no encontrado."); return; }
    c.qty -= 1;
    state.useLog.push({date:new Date().toISOString(), name:`Maldici√≥n ‚Üí ${pr.displayName||pr.email||pr.id}`});
    toast("ü™Ñ Maldici√≥n aplicada (debuff)");
    await addDoc(debuffCol,{ type:"curse", active:true, fromId: currentUser.uid, fromName: currentUser.displayName||currentUser.email||currentUser.uid, targetId: pr.id, targetName: pr.displayName||pr.email||pr.id, createdAt: serverTimestamp() });
    scheduleSave(); render();

    // comprobar karma
    const inv=await getDoc(invRef(pr.id)); if(inv.exists()){
      const v=inv.data(); const vk=(v.karma||0);
      if(vk<=-3){
        // permitir robo como flujo de robo sigiloso (notificaci√≥n)
        const d=await getDoc(invRef(pr.id));
        if(d.exists()){
          const victimData=d.data();
          // elegir carta a robar (versi√≥n r√°pida: robamos la primera que tenga; si quieres UI, se podr√≠a abrir el modal de robo)
          // Abrimos el modal de robo para elegir (reutilizamos)
          toggleModal(cardModal,false);
          stealSelectedCardId=null; stealSelectedCardName=null;
          stealGrid.innerHTML=""; stealConfirm.disabled=true; toggleModal(stealModal,true);
          $("#stealTarget").value = pr.id;
          victimSnapshot=victimData;
          victimSnapshot.cards.forEach(vc=>{
            if((vc.qty||0)<=0) return;
            const slot=document.createElement("div"); slot.className="cardSlot"; slot.dataset.id=vc.id;
            const imgWrap=document.createElement("div"); imgWrap.className="imgWrap";
            const img=document.createElement("img"); img.alt=vc.name; img.src=`img/${vc.id}.png`; img.onerror=()=>{ if(!img.dataset.tryJ){ img.dataset.tryJ=1; img.src=`img/${vc.id}.jpg`; } };
            imgWrap.appendChild(img);
            const title=document.createElement("div"); title.className="title"; title.textContent=vc.name;
            const meta=document.createElement("div"); meta.className="small"; meta.innerHTML=`<span class="badge">${esc(vc.type)}</span> ¬∑ <span class="badge">${vc.cost} ü™ô</span>`;
            const qty=document.createElement("div"); qty.className="qty"; qty.textContent="√ó "+vc.qty; slot.appendChild(qty);
            slot.appendChild(imgWrap); slot.appendChild(title); slot.appendChild(meta);
            slot.onclick=()=>{ [...stealGrid.children].forEach(ch=>ch.style.outline="none"); slot.style.outline="2px solid #7c5cff"; stealSelectedCardId=vc.id; stealSelectedCardName=vc.name; stealConfirm.disabled=false; };
            stealGrid.appendChild(slot);
          });
          stealConfirm.onclick=async()=>{
            if(!stealSelectedCardId) return;
            const myCard=state.cards.find(x=>x.id===stealSelectedCardId); if(myCard){ myCard.qty=(myCard.qty||0)+1; }
            state.useLog.push({date:new Date().toISOString(), name:`Robaste (Maldici√≥n) ${stealSelectedCardName} (+1)`, note:`A ${pr.displayName||pr.email||pr.id}`});
            await addDoc(stealCol,{ attackerId: currentUser.uid, attackerName: currentUser.displayName||currentUser.email||currentUser.uid, victimId: pr.id, victimName: pr.displayName||pr.email||pr.id, cardId: stealSelectedCardId, cardName: stealSelectedCardName, status: "pending", createdAt: serverTimestamp() });
            scheduleSave(); render(); toggleModal(stealModal,false);
          };
        }
      }else{
        toast("El objetivo no tiene karma ‚â§ ‚àí3. No hay robo.");
      }
    }
    toggleModal(cardModal,false);
    return;
  }

  // --- Ataques gen√©ricos: elegir rival, crear attackRequest, gastar carta, karma+1
  if(c.type==="ataque"){
    const victimName = prompt("¬øA qu√© usuario atacas? (nombre o uid)");
    if(!victimName) return;
    const pr = profiles.find(p=> (p.displayName||p.email||p.id)===victimName) || profiles.find(p=>p.id===victimName);
    if(!pr){ alert("Usuario no encontrado."); return; }

    // Regalo pendiente: si hay debuff gift donde giverId==victim y receiverId==yo
    // avisamos y anulamos
    const giftQ = query(debuffCol, where("type","==","gift"), where("active","==",true), where("receiverId","==",currentUser.uid), where("giverId","==",pr.id));
   const gSnap = await getDocs(giftQ);
    if(gSnap.docs.length){
      // notificarme y cerrar gift
      await addDoc(giftAlertCol,{ receiverId: currentUser.uid, creditorId: pr.id, creditorName: pr.displayName||pr.email||pr.id, status:"pending", createdAt: serverTimestamp() });
      // marcar todos inactivos
      await Promise.all(gSnap.docs.map(d=> updateDoc(doc(db,"debuffs", d.id), {active:false, consumedAt: serverTimestamp()})));
    }

    // gastar carta de ataque
    c.qty -= 1;
    state.karma=(state.karma||0)+1;
    state.useLog.push({date:new Date().toISOString(), name:`Usaste ${c.name} (‚àí1) ‚Üí ${pr.displayName||pr.email||pr.id}`});
    toast(`‚öîÔ∏è Ataque: ${c.name} ‚Üí ${pr.displayName||pr.email||pr.id}`);

    // efectos econ√≥micos que ya ten√≠as
    if(nm==="robo de monedas"){ addCoins(5,"Carta: Robo de monedas"); toast("ü™ô +5 monedas"); }

    await addDoc(attackCol,{ attackerId: currentUser.uid, attackerName: currentUser.displayName||currentUser.email||currentUser.uid, victimId: pr.id, victimName: pr.displayName||pr.email||pr.id, cardId: c.id, cardName: c.name, status:"pending", createdAt: serverTimestamp() });

    scheduleSave(); render(); toggleModal(cardModal,false);
    return;
  }

  // --- Uso normal de otras cartas
  c.qty -= 1;
  state.useLog.push({date:new Date().toISOString(), name:`Usaste ${c.name} (‚àí1)`});
  toast(`üé¥ Usaste ${c.name} (‚àí1)`); if(c.type==="ataque"){state.karma=(state.karma||0)+1}
  if(nm==="10 monedas"){addCoins(10,"Carta: 10 monedas");toast("ü™ô +10 monedas")}
  if(nm==="venta ilegal"){addCoins(2,"Carta: Venta ilegal");toast("ü™ô +2 monedas")}
  if(nm==="monedero perdido"){const g=(Math.floor(Math.random()*5)+1);addCoins(g,`Carta: Monedero perdido (+${g})`);toast(`ü™ô Monedero perdido: +${g}`)}
  scheduleSave(); render(); openCard(c.id);
}

/* ========= Ruleta ========= */
const slotText=$("#slotText");
$("#spinPaid").onclick=()=>spin({paid:true});
$("#spinFree").onclick=()=>spin({paid:false});
function buildPool(){
  const fixed10=state.cards.find(c=>c.name.toLowerCase()==="10 monedas");
  const fixedMono=state.cards.find(c=>c.name.toLowerCase()==="monedero perdido");
  const pool=[]; if(fixed10)pool.push(fixed10); if(fixedMono)pool.push(fixedMono);
  const pick=(arr,n)=>{const a=arr.slice();const out=[];while(a.length&&out.length<n){const i=Math.floor(Math.random()*a.length);out.push(a[i]);a.splice(i,1)}return out};
  const all=state.cards, legend=all.filter(c=>c.cost===10||c.cost===13), epic=all.filter(c=>c.cost===7), rare3=all.filter(c=>c.cost===4), common4=all.filter(c=>c.cost===2);
  pool.push(...pick(legend,1),...pick(epic,1),...pick(rare3,3),...pick(common4,4));
  return pool.slice(0,10);
}
function spin({paid}){
  if(spyUid||!currentUser)return;
  if(paid){
    if(!confirm("¬øGastar 1 tirada de Ruleta?\nRecuerda: el RNG no te debe nada üòÖ"))return;
    const ru=state.cards.find(c=>c.name.toLowerCase()==="ruleta"); if(!ru||ru.qty<=0){alert("No tienes carta 'Ruleta'.");return}
    ru.qty-=1; state.useLog.push({date:new Date().toISOString(),name:"Usaste Ruleta (‚àí1)",note:"Tirada pagada"}); toast("üé∞ Usaste 1 Ruleta (‚àí1)");
  }else{
    const ok=confirm("¬øHas vencido a un l√≠der de gimnasio? (Solo entonces procede la tirada gratis)"); if(!ok)return;
    state.useLog.push({date:new Date().toISOString(),name:"Tirada gratis post-gym",note:"+1 tirada"}); toast("üéÅ Tirada gratis post-gym");
  }
  scheduleSave(); render();
  const candidates=buildPool(); if(!candidates.length){alert("No hay cartas para la ruleta.");return}
  let t=0,idx=0; slotText.textContent="‚Äî";
  const it=setInterval(()=>{idx=(idx+1)%candidates.length;slotText.textContent=candidates[idx].name;t+=60;
    if(t>=2000){clearInterval(it);const win=candidates[Math.floor(Math.random()*candidates.length)];slotText.textContent="üéâ "+win.name;
      const card=state.cards.find(c=>c.id===win.id); if(card){card.qty=(card.qty||0)+1}
      state.useLog.push({date:new Date().toISOString(),name:`Ganaste por ruleta: ${win.name}`,note:"+1 carta"});
      toast(`üéâ +1 ${win.name}`); scheduleSave(); render(); showReward(win);
    }
  },60);
}
const rewardModal=$("#rewardModal"), rewardClose=$("#rewardClose"), rewardCloseX=$("#rewardCloseX");
rewardClose.onclick=()=>toggleModal(rewardModal,false);
rewardCloseX.onclick=()=>toggleModal(rewardModal,false);
function showReward(win){
  const img=$("#rewardImg"); img.removeAttribute("data-tried"); img.onerror=null;
  img.src=`img/${win.id}.png`; img.onerror=()=>{ if(!img.dataset.tried){ img.dataset.tried=1; img.src=`img/${win.id}.jpg`; } };
  $("#rewardName").textContent=win.name;
  $("#rewardMeta").innerHTML=`<span class="badge">${esc(win.type)}</span> ¬∑ <span class="badge">${win.cost} ü™ô ¬∑ ${esc(tierOf(win.cost))}</span>`;
  $("#rewardDesc").textContent=win.desc;
  toggleModal(rewardModal,true);
}

/* ========= Listeners de ‚Äúataques enviados‚Äù (feedback al atacante) ========= */
onSnapshot(query(attackCol, where("attackerId","==",()=>currentUser?.uid||"zz")), (snap)=>{
  snap.docChanges().forEach(ch=>{
    if(ch.type!=="modified") return;
    const d=ch.doc.data();
    if(d.status==="defended"){
      toast(`üõ°Ô∏è Rival defendi√≥ con ${d.defenseUsed}.`);
    }
    if(d.status==="protected_success_refund"){
      // devolvemos la carta al atacante
      const my = state.cards.find(c=>c.name.toLowerCase()===d.cardName.toLowerCase());
      if(my){ my.qty=(my.qty||0)+1; toast(`ü™ô Protecci√≥n del d√©bil: te devuelven ${my.name}.`); scheduleSave(); render(); }
    }
  });
});

/* ========= Ataque: colecciones etc. ========= */

/* ========= FIN ========= */
</script>
</body>
</html>
